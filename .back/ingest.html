{% extends "base.html" %}
{% block content %}

<style>
  /* REM: ãƒšã‚¤ãƒ³ä¸Šä¸‹åˆ†å‰² */
  #ingest-container { display:flex; flex-direction:column; height:calc(100vh - 2em); }
  #pane-top         { flex:0 0 auto; padding-bottom:1em; border-bottom:1px solid #ddd; }
  #pane-bottom      { flex:1 1 auto; overflow-y:auto; padding:1em 1em 1em 0; }

  /* REM: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒšãƒ¼ã‚¸è¡¨ç¤º */
  .file-header  { background:#eef; padding:4px 8px; font-weight:bold; margin-bottom:0.5em; }
  .file-progress{ font-size:0.9em; color:#555; margin-left:1ch; margin-bottom:0.5em; }
  .page-header  { margin-left:1ch; font-style:italic; margin-bottom:0.5em; }
  .file-section > div:not(.page-header), .file-section > details { margin-left:2ch; }

  /* REM: details ã‚«ãƒ¼ãƒ‰é¢¨ */
  #pane-bottom details { width:100%; box-sizing:border-box; margin-bottom:8px;
                         padding:12px; border:1px solid #ddd; border-radius:4px; background:#fafafa; }
  #pane-bottom details pre { white-space:pre-wrap; word-break:break-word; margin-top:8px; }
</style>

<div id="ingest-container">
  <div id="pane-top">
    <!-- REM: å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <h1 class="page-title">âœï¸ ãƒ‡ãƒ¼ã‚¿æ•´å½¢/ç™»éŒ²</h1>

    <form id="ingest-form">
      <!-- REM: ãƒ•ã‚©ãƒ«ãƒ€ or ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
      <div class="form-section">
        {% include "partials/ingest/ingest_header.html" %}
        {% include "partials/ingest/folder_modal.html" %}
      </div><br>

      <!-- REM: LLM æ•´å½¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ -->
      <div class="form-section">
        <label for="refine-prompt">ğŸ“ æ•´å½¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼š</label>
        <select id="refine-prompt" name="refine_prompt_key">
          {% for key in prompt_keys %}
            <option value="{{ key }}">{{ key }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- REM: åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«é¸æŠ -->
      <div class="form-section">
        <label>ğŸ“ åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ï¼š</label>
        {% for key, config in embedding_options.items() %}
          <label>
            <input type="checkbox" name="embed_models" value="{{ key }}" checked>
            {{ loop.index }}. {{ config.model_name }}
          </label>ã€€ã€€
        {% endfor %}
      </div><br>

      <!-- REM: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
      <div class="form-section">
        <label>æ—¢å­˜ä¸Šæ›¸ãï¼ˆoverwriteï¼‰ï¼š<input type="checkbox" name="overwrite_existing" value="true"></label><br>
        <label>è³ªã‚¹ã‚³ã‚¢é–¾å€¤ï¼š<input type="number" name="quality_threshold" min="0" max="1" step="0.05" value="0.0"></label>
      </div><br>

      <!-- REM: å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
      <div class="form-actions">
        <button type="button" id="start-btn">ğŸš€ å‡¦ç†é–‹å§‹</button>
        <button type="button" id="cancel-btn" disabled>âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </form>
  </div>

  <!-- REM: å‡¦ç†ãƒ­ã‚°å‡ºåŠ›ã‚¨ãƒªã‚¢ -->
  <div id="pane-bottom"></div>
</div>

<script>
// REM: DOM æ§‹ç¯‰å®Œäº†å¾Œã«åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
  const startBtn   = document.getElementById('start-btn');
  const cancelBtn  = document.getElementById('cancel-btn');
  const paneBottom = document.getElementById('pane-bottom');
  let controller, es;
  const fileContainers = {};

  startBtn.onclick = async () => {
    startBtn.disabled  = true;
    cancelBtn.disabled = false;
    paneBottom.innerHTML = '';

    controller = new AbortController();
    const form = new FormData(document.getElementById('ingest-form'));
    form.append('include_subdirs',
      document.getElementById('include-subdirs').checked ? 'true' : 'false');
    await fetch('/ingest', { method:'POST', body:form, signal:controller.signal });

    es = new EventSource('/ingest/stream');
    es.onmessage = evt => {
      const d = JSON.parse(evt.data);
      if (!d.step || typeof d.step !== 'string' || !d.step.trim()) return;

      // prompt_text / refined_text æœ¬æ–‡æŒ¿å…¥
      if (d.step === 'prompt_text' || d.step === 'refined_text') {
        const cat  = d.step === 'prompt_text' ? 'ä½¿ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¨æ–‡' : 'LLMæ•´å½¢çµæœå…¨æ–‡';
        const part = d.part ?? 'all';
        const det  = paneBottom.querySelector(
          `details[data-cat="${cat}"][data-part="${part}"]`);
        if (det) {
          let pre = det.querySelector('pre') || det.appendChild(document.createElement('pre'));
          pre.textContent = (d.content || '').replace(/\n{3,}/g, '\n\n');
        }
        return;
      }

      // è¦‹å‡ºã—detailsç”Ÿæˆ
      if (d.step.startsWith('ä½¿ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¨æ–‡') || d.step.startsWith('LLMæ•´å½¢çµæœå…¨æ–‡')) {
        const [cat, partRaw] = d.step.split(' part:');
        const part = partRaw || 'all';
        if (!paneBottom.querySelector(`details[data-cat="${cat}"][data-part="${part}"]`)) {
          const dt  = document.createElement('details');
          dt.dataset.cat  = cat;
          dt.dataset.part = part;
          const sum = document.createElement('summary');
          sum.textContent = d.step;
          dt.appendChild(sum);
          paneBottom.prepend(dt);
        }
        return;
      }

      // ãã®ä»–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡Œ
      const div = document.createElement('div');
      div.textContent = d.step;
      paneBottom.prepend(div);

      // å®Œäº†
      if (d.done) {
        es.close();
        paneBottom.prepend(Object.assign(document.createElement('div'), {textContent:'âœ… å…¨å‡¦ç†å®Œäº†'}));
        startBtn.disabled  = false;
        cancelBtn.disabled = true;
        return;
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç¢ºä¿
      if (!fileContainers[d.file]) {
        if (paneBottom.firstChild) paneBottom.prepend(document.createElement('br'));
        const cont = document.createElement('div');
        const hdr  = document.createElement('div'); hdr.className='file-header';
        const link = document.createElement('a');
        link.textContent = d.file;
        link.href   = `/viewer/${d.file_id}`;
        link.target = '_blank';
        hdr.appendChild(link);
        cont.appendChild(hdr);
        if (d.index && d.total) {
          const prog = document.createElement('div'); prog.className='file-progress';
          prog.textContent = `${d.index}/${d.total}ç•ªç›®ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ä¸­â€¦`;
          cont.appendChild(prog);
        }
        const sec = document.createElement('div'); sec.className='file-section';
        cont.appendChild(sec);
        paneBottom.prepend(cont);
        fileContainers[d.file] = sec;
      }
      const section = fileContainers[d.file];

      // ãƒšãƒ¼ã‚¸è¦‹å‡ºã—
      if (d.step.startsWith('Page ')) {
        const ph = document.createElement('div'); ph.className='page-header';
        ph.textContent = d.step;
        section.prepend(ph);
        return;
      }

      // ãƒ©ãƒ™ãƒ«è¡Œè¿½åŠ 
      const label = d.step + (d.duration ? ` (${d.duration}s)` : '');
      const isDetail = d.step.startsWith('ä½¿ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¨æ–‡') || d.step.startsWith('LLMæ•´å½¢çµæœå…¨æ–‡');
      if (isDetail) {
        const [cat, partLabel] = d.step.split(' part:');
        const dt = document.createElement('details');
        dt.dataset.cat  = cat;
        dt.dataset.part = partLabel || 'all';
        const sum = document.createElement('summary'); sum.textContent = label;
        dt.appendChild(sum);
        section.prepend(dt);
      } else {
        const div2 = document.createElement('div');
        div2.textContent = label;
        section.prepend(div2);
      }
    };
  };

  cancelBtn.onclick = () => {
    controller?.abort();
    es?.close();
    startBtn.disabled  = false;
    cancelBtn.disabled = true;
  };
});
</script>

{% endblock %}
