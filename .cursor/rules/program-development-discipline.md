---
alwaysApply: true
---
# プログラム開発・修正規律ルール

## 基本原則

### 信頼関係構築の重要性
- **誠実な対応**: 嘘を言わず、推測は推測として明示する
- **適切なコミュニケーション**: 不明点は即座に確認し、勝手な判断を避ける
- **プロセス遵守**: 信頼関係は適切なプロセスの積み重ねから生まれる
- **継続的改善**: 失敗から学び、同じ間違いを繰り返さない

## プログラム修正時の4段階検討ステップ

### 第1段階：問題点の整理と現状分析
- **現象の正確な把握**: エラーメッセージ、動作不具合の詳細記録
- **影響範囲の特定**: どのファイル、機能、画面が関係するか
- **再現条件の確認**: 問題が発生する具体的な操作手順
- **緊急度の評価**: 即座に対応すべきか、計画的に対応すべきか

### 第2段階：俯瞰的分析と根本原因追求
- **系統的調査**: 関連ファイル、設定、依存関係の全体像把握
- **類似箇所との比較**: 他のページ、コンポーネントとの実装差異確認
- **設計意図の理解**: なぜその実装になっているのか背景調査
- **技術的負債の発見**: 場当たり的対応、独自仕様の痕跡特定

### 第3段階：修正方針の決定と根拠確立
- **公式ドキュメント確認**: Flet、Python、関連ライブラリの公式情報
- **ベストプラクティス調査**: 業界標準、推奨パターンの確認
- **複数案の検討**: 修正方法の選択肢比較（メリット・デメリット）
- **根拠の明確化**: 修正方針の理論的・技術的裏付け記述
- **推測部分の明示**: 確証がない部分は「推測」として明確に記載

### 第4段階：実行計画の策定と承認
- **作業分解**: ToDoリストへの具体的タスク分割
- **実行順序決定**: 依存関係を考慮した適切な作業順序
- **テスト計画**: 各段階での検証方法、テストファイル指定
- **リスク評価**: 想定される問題点と対応策
- **承認取得**: ユーザーからの明示的な実行許可取得

## 修正実行プロセス

### 事前準備（必須）
- **実行計画承認確認**: 「即実行」指示以外は必ず計画提示→承認
- **現状バックアップ**: 重要なファイルの現在状態記録
- **テスト環境確認**: 必要なテストファイル、プロセスの事前準備

### 実行中の規律
- **ToDo駆動開発**: 承認されたToDoリスト順序で実行
- **段階的実装**: 一度に大量修正せず、小刻みに検証
- **即座なテスト**: 修正後は必ず該当機能の単体テスト実行
- **エラー即停止**: 予期しないエラー発生時は作業停止、指示要請

### 計画逸脱時の対応
- **場当たり修正禁止**: 計画にない修正は実行前に相談
- **立ち止まる勇気**: 不明な状況では無理に進めず一旦停止
- **状況報告**: 何が計画と異なるか、なぜ逸脱したかを正確に報告
- **再計画立案**: 必要に応じて修正計画の見直し提案

## テスト実行ルール

### Flet アプリケーション特有のルール

#### 必須のタイムアウト設定
```bash
# ✅ 正しいテスト方法
timeout 30 python tests/debug/test_upload_standalone.py &

# ❌ 間違い：ハングアップの原因
python tests/debug/test_upload_standalone.py
```

#### バックグラウンド実行必須
- **理由**: Fletアプリケーションは対話型のため、フォアグラウンド実行では進行不可
- **実行方法**: 必ず末尾に `&` を付けてバックグラウンド実行
- **確認方法**: `curl` でHTTP接続確認、適切なレスポンス検証

#### 適切なプロセス管理
```bash
# プロセス確認
ps aux | grep test_filename

# 確実な終了
pkill -f test_filename

# 一般的な終了は不適切
pkill -f python  # ← これは他のプロセスも終了させる危険性
```

### 単体テスト必須ルール

#### main.py全体テスト禁止
- **理由**: 修正箇所の特定的検証ができない
- **問題**: 他の機能の影響で問題の切り分けが困難
- **対策**: 修正したページ・コンポーネントの単体テスト必須

#### 修正ファイル個別テスト
- **アップロードページ修正**: `tests/debug/test_upload_standalone.py`
- **OCR調整ページ修正**: `tests/debug/test_ocr_adjustment_standalone.py`
- **新規ページ作成**: 対応する単体テストファイル作成

#### テストファイル構成
```
tests/
└── debug/
    ├── test_upload_standalone.py          # アップロードページ単体
    ├── test_ocr_adjustment_standalone.py  # OCR調整ページ単体
    ├── test_files_standalone.py           # ファイルページ単体
    └── [新規]_standalone.py               # 新規ページ対応
```

### テスト実行手順（テンプレート）

#### 1. 事前準備
```bash
# 既存プロセス確認・終了
pkill -f test_[target]_standalone

# ファイル存在確認
ls tests/debug/test_[target]_standalone.py
```

#### 2. テスト実行
```bash
# 正しい実行方法
timeout 30 python tests/debug/test_[target]_standalone.py &
```

#### 3. 動作確認
```bash
# HTTP接続確認
sleep 3 && curl -f http://localhost:8501 >/dev/null 2>&1 && echo "✓ 起動成功" || echo "✗ 起動失敗"

# プロセス状態確認（必要時）
ps aux | grep test_[target]_standalone
```

#### 4. 適切な終了
```bash
# テスト完了後の確実な終了
pkill -f test_[target]_standalone
```

## 品質保証チェックリスト

### 修正前チェック
- [ ] 実行計画が策定され、承認されているか
- [ ] 修正対象ファイルの現状が把握されているか
- [ ] 影響範囲が特定されているか
- [ ] 適切な単体テストファイルが準備されているか

### 修正後チェック
- [ ] 修正内容が計画通りに実装されているか
- [ ] 単体テストが正常に起動するか
- [ ] 期待される動作が確認できるか
- [ ] 他の機能への影響がないか
- [ ] リファクタリング時は技術的負債が解消されているか

### 完了報告前チェック
- [ ] 全てのToDoが完了状態になっているか
- [ ] テストプロセスが適切に終了されているか
- [ ] 実際の動作確認が完了しているか
- [ ] ユーザーによる最終確認が取れているか

## 禁止事項（重要）

### 絶対に行ってはいけないこと
- **拙速な修正実行**: 計画なしの即座な編集
- **タイムアウトなしテスト**: Fletアプリの直接実行
- **全体テストのみ**: main.pyだけでの動作確認
- **推測の確定化**: 根拠なき断定的表現
- **場当たり修正**: 計画外のその場しのぎ対応
- **プロセス放置**: テスト終了後のプロセス残存

### 段階的エスカレーション
1. **軽微な問題**: 計画内で対応可能な場合は継続
2. **中程度の問題**: 作業停止して状況報告、指示要請
3. **重大な問題**: 即座に全作業停止、詳細な問題分析報告

## トラブルシューティング

### よくある問題と対策

#### Fletテストがハングする
- **原因**: タイムアウト設定なし
- **対策**: `timeout 30` を必ず付加
- **緊急対応**: `Ctrl+C` で中断後、`pkill -f python` で全Python プロセス終了

#### 単体テストが起動しない
- **原因1**: ファイルパス間違い → `ls` で存在確認
- **原因2**: モジュールインポートエラー → エラーメッセージ詳細確認
- **原因3**: ポート競合 → `pkill` で既存プロセス終了

#### 修正効果が確認できない
- **原因1**: キャッシュ問題 → ブラウザリロード
- **原因2**: プロセス再起動不備 → 完全なプロセス終了後再起動
- **原因3**: 修正箇所違い → ファイル確認、変更差分確認

## 継続的改善

### 学習記録
- **失敗パターンの記録**: 同じ間違いの再発防止
- **成功パターンの蓄積**: 効率的な作業手順の標準化
- **ツール・手法の改善**: より良い開発環境の構築

### 定期的見直し
- **ルールの実効性確認**: 形骸化していないか
- **新しい問題への対応**: 技術進歩に応じたルール更新
- **プロセス効率化**: 無駄な手順の排除、自動化検討

---

**このルールは開発効率と品質向上、そして信頼関係構築のための基盤です。**  
**遵守することで、継続的な改善と安定した開発プロセスを実現します。**
