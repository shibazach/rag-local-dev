---
alwaysApply: true
---
# プログラム開発・修正規律ルール

## 基本原則

### 信頼関係構築の重要性
- **誠実な対応**: 嘘を言わず、推測は推測として明示する
- **適切なコミュニケーション**: 不明点は即座に確認し、勝手な判断を避ける
- **プロセス遵守**: 信頼関係は適切なプロセスの積み重ねから生まれる
- **継続的改善**: 失敗から学び、同じ間違いを繰り返さない

## CRITICAL: 検証なし本番実装の絶対禁止（破壊的行為防止）

### 重要な教訓
**「チェックなしに本番実装しようと考えること自体が破壊的」**

既存の動作するシステムを検証なしに変更することは、システム全体を破壊する重大なルール違反である。

### 本番実装前の必須検証手順（NEVER SKIP）

#### 実装前必須チェック
- [ ] **段階的実装計画**: 一度に複数ファイル変更禁止、1つずつ検証
- [ ] **エラー事前確認**: `read_lints`で既存エラー状況把握
- [ ] **既存機能保護**: 動作中の機能を壊さない設計確認
- [ ] **ロールバック準備**: 失敗時の復旧手順明確化
- [ ] **プロセス管理計画**: 不要なプロセス起動を避ける設計

#### 実装中必須プロセス
- [ ] **各段階でエラーチェック**: 変更後即座に`read_lints`実行
- [ ] **動作確認**: 実際のテスト実行（プロセス1つのみ起動・再利用）
- [ ] **インポート確認**: 依存関係エラーの即座修正
- [ ] **既存機能確認**: 変更が他の機能に影響しないことを確認
- [ ] **段階的コミット**: 動作確認後に次のステップへ

#### 実装後必須検証
- [ ] **全機能動作確認**: 新規実装・既存機能の両方
- [ ] **エラーゼロ確認**: 警告含む全エラー解消
- [ ] **プロセス管理**: 不要プロセス終了、リソース最適化
- [ ] **大量bash終了**: run_terminal_cmdで生成された大量のbashプロセスを必ず終了
- [ ] **破壊的変更の即座修正**: エラー発見時の最優先対応

### 絶対禁止行為（破壊的）
- ❌ **複数ファイル同時変更**: 影響範囲不明で極めて危険
- ❌ **検証スキップ**: エラーチェックなしの実装
- ❌ **大量プロセス起動**: システムリソース圧迫
- ❌ **既存機能破壊**: 動作中システムの無計画変更
- ❌ **一気に実装**: 段階的確認を無視した実装
- ❌ **ロールバック準備なし**: 失敗時の復旧計画欠如

### 違反時の対応
1. **即座停止**: すべての変更作業を停止
2. **エラー優先修正**: 発生した問題の緊急対応
3. **ロールバック実行**: 動作状態への復旧
4. **段階的再実装**: 検証手順に従った再実装
5. **教訓記録**: 失敗原因と対策の明文化

## プログラム修正時の4段階検討ステップ

### 第1段階：問題点の整理と現状分析
- **現象の正確な把握**: エラーメッセージ、動作不具合の詳細記録
- **影響範囲の特定**: どのファイル、機能、画面が関係するか
- **再現条件の確認**: 問題が発生する具体的な操作手順
- **緊急度の評価**: 即座に対応すべきか、計画的に対応すべきか

### 第2段階：俯瞰的分析と根本原因追求
- **系統的調査**: 関連ファイル、設定、依存関係の全体像把握
- **類似箇所との比較**: 他のページ、コンポーネントとの実装差異確認
- **設計意図の理解**: なぜその実装になっているのか背景調査
- **技術的負債の発見**: 場当たり的対応、独自仕様の痕跡特定

### 第3段階：修正方針の決定と根拠確立
- **公式ドキュメント確認**: Flet、Python、関連ライブラリの公式情報
- **ベストプラクティス調査**: 業界標準、推奨パターンの確認
- **複数案の検討**: 修正方法の選択肢比較（メリット・デメリット）
- **根拠の明確化**: 修正方針の理論的・技術的裏付け記述
- **推測部分の明示**: 確証がない部分は「推測」として明確に記載

### 第4段階：実行計画の策定と承認
- **作業分解**: ToDoリストへの具体的タスク分割
- **実行順序決定**: 依存関係を考慮した適切な作業順序
- **テスト計画**: 各段階での検証方法、テストファイル指定
- **リスク評価**: 想定される問題点と対応策
- **承認取得**: ユーザーからの明示的な実行許可取得

## 修正実行プロセス

### 事前準備（必須）
- **実行計画承認確認**: 「即実行」指示以外は必ず計画提示→承認
- **現状バックアップ**: 重要なファイルの現在状態記録
- **テスト環境確認**: 必要なテストファイル、プロセスの事前準備

### 実行中の規律
- **ToDo駆動開発**: 承認されたToDoリスト順序で実行
- **段階的実装**: 一度に大量修正せず、小刻みに検証
- **即座なテスト**: 修正後は必ず該当機能の単体テスト実行
- **エラー即停止**: 予期しないエラー発生時は作業停止、指示要請

### 計画逸脱時の対応
- **場当たり修正禁止**: 計画にない修正は実行前に相談
- **立ち止まる勇気**: 不明な状況では無理に進めず一旦停止
- **状況報告**: 何が計画と異なるか、なぜ逸脱したかを正確に報告
- **再計画立案**: 必要に応じて修正計画の見直し提案

## テスト実行ルール

### arrangement_test の存在意義と活用規律

#### なぜ arrangement_test があるのか
- **本番影響ゼロの実験領域**: `app/flet_ui/arrangement_test/` は完全に独立
- **段階的適用の前段階**: 新機能・修正の事前検証専用
- **失敗コストなし**: どんな実験的実装でも本番に影響しない
- **tab_a の特権**: パネル内容は完全に自由実装・テスト可能

#### ブロッキング実行の繰り返しミス撲滅
```bash
# 🚫 絶対禁止 - 何度も指摘されている致命的ミス
python main_flet.py 2>&1 | head -20
command | tee output.log
command 2>&1 | head -N

# ✅ 正しい実行方法（必須）
timeout 15 python main_flet.py &
sleep 8 && curl -f http://localhost:8500 >/dev/null 2>&1 && echo "✅ 起動確認" || echo "❌ エラー"
```

**重要**: パイプ付き実行は応答不能。ユーザーから何度も修正指示を受けているにも関わらず繰り返している重大な規律違反。

#### テストプロセスの段階的適用規律

##### Step1: arrangement_test での実装・検証
- **実装場所**: `app/flet_ui/arrangement_test/tab_a/body.py`
- **自由度**: パネル内容は好きに実装・テスト可能
- **確認方法**: http://localhost:8500 → 「配置テスト」タブ
- **完了条件**: 期待する動作が完全に確認できること

##### Step2: 本番への段階的適用（絶対に1ファイルずつ）
- **適用順序**: 1ファイル→動作確認→次のファイル
- **同時変更禁止**: 複数ファイル同時変更は絶対禁止
- **エラー時対応**: 即座に前の動作状態に復旧

##### Step3: 各段階での動作確認
- **毎回確認**: ファイル変更後は必ず動作確認
- **確認方法**: 非ブロッキングコマンドで起動確認
- **失敗時**: 段階的にロールバック

### Flet アプリケーション特有のルール

#### 必須のタイムアウト設定
```bash
# ✅ 正しいテスト方法
timeout 30 python tests/debug/test_upload_standalone.py &

# ❌ 間違い：ハングアップの原因
python tests/debug/test_upload_standalone.py
```

#### バックグラウンド実行必須
- **理由**: Fletアプリケーションは対話型のため、フォアグラウンド実行では進行不可
- **実行方法**: 必ず末尾に `&` を付けてバックグラウンド実行
- **確認方法**: `curl` でHTTP接続確認、適切なレスポンス検証

#### 適切なプロセス管理
```bash
# プロセス確認
ps aux | grep test_filename

# 確実な終了
pkill -f test_filename

# 一般的な終了は不適切
pkill -f python  # ← これは他のプロセスも終了させる危険性
```

### 単体テスト必須ルール

#### main.py全体テスト禁止
- **理由**: 修正箇所の特定的検証ができない
- **問題**: 他の機能の影響で問題の切り分けが困難
- **対策**: 修正したページ・コンポーネントの単体テスト必須

#### 修正ファイル個別テスト
- **アップロードページ修正**: `tests/debug/test_upload_standalone.py`
- **OCR調整ページ修正**: `tests/debug/test_ocr_adjustment_standalone.py`
- **新規ページ作成**: 対応する単体テストファイル作成

#### テストファイル構成
```
tests/
└── debug/
    ├── test_upload_standalone.py          # アップロードページ単体
    ├── test_ocr_adjustment_standalone.py  # OCR調整ページ単体
    ├── test_files_standalone.py           # ファイルページ単体
    └── [新規]_standalone.py               # 新規ページ対応
```

### テスト実行手順（テンプレート）

#### 1. 事前準備
```bash
# 既存プロセス確認・終了
pkill -f test_[target]_standalone

# ファイル存在確認
ls tests/debug/test_[target]_standalone.py
```

#### 2. テスト実行
```bash
# 正しい実行方法
timeout 30 python tests/debug/test_[target]_standalone.py &
```

#### 3. 動作確認
```bash
# HTTP接続確認
sleep 3 && curl -f http://localhost:8501 >/dev/null 2>&1 && echo "✓ 起動成功" || echo "✗ 起動失敗"

# プロセス状態確認（必要時）
ps aux | grep test_[target]_standalone
```

#### 4. 適切な終了
```bash
# テスト完了後の確実な終了
pkill -f test_[target]_standalone
```

## 品質保証チェックリスト

### 修正前チェック
- [ ] 実行計画が策定され、承認されているか
- [ ] 修正対象ファイルの現状が把握されているか
- [ ] 影響範囲が特定されているか
- [ ] 適切な単体テストファイルが準備されているか

### 修正後チェック
- [ ] 修正内容が計画通りに実装されているか
- [ ] 単体テストが正常に起動するか
- [ ] 期待される動作が確認できるか
- [ ] 他の機能への影響がないか
- [ ] リファクタリング時は技術的負債が解消されているか

### 完了報告前チェック
- [ ] 全てのToDoが完了状態になっているか
- [ ] テストプロセスが適切に終了されているか
- [ ] 実際の動作確認が完了しているか
- [ ] ユーザーによる最終確認が取れているか

## 禁止事項（重要）

### 絶対に行ってはいけないこと
- **拙速な修正実行**: 計画なしの即座な編集
- **タイムアウトなしテスト**: Fletアプリの直接実行
- **全体テストのみ**: main.pyだけでの動作確認
- **推測の確定化**: 根拠なき断定的表現
- **場当たり修正**: 計画外のその場しのぎ対応
- **プロセス放置**: テスト終了後のプロセス残存
- **ファイル削除→新規作成の愚行**: 「追加して整理」指示を「置換」と誤解する重大ミス
- **既存内容の軽視・破壊**: 貴重な反省履歴・失敗学習データを軽視して削除
- **指示理解の浅薄さ**: ユーザー指示の真意を理解せず拙速に行動

### 段階的エスカレーション
1. **軽微な問題**: 計画内で対応可能な場合は継続
2. **中程度の問題**: 作業停止して状況報告、指示要請
3. **重大な問題**: 即座に全作業停止、詳細な問題分析報告

## トラブルシューティング

### よくある問題と対策

#### Fletテストがハングする
- **原因**: タイムアウト設定なし
- **対策**: `timeout 30` を必ず付加
- **緊急対応**: `Ctrl+C` で中断後、`pkill -f python` で全Python プロセス終了

#### 単体テストが起動しない
- **原因1**: ファイルパス間違い → `ls` で存在確認
- **原因2**: モジュールインポートエラー → エラーメッセージ詳細確認
- **原因3**: ポート競合 → `pkill` で既存プロセス終了

#### 修正効果が確認できない
- **原因1**: キャッシュ問題 → ブラウザリロード
- **原因2**: プロセス再起動不備 → 完全なプロセス終了後再起動
- **原因3**: 修正箇所違い → ファイル確認、変更差分確認

## 継続的改善

### 最新の失敗反省（2025-08-26追加）

#### ファイル削除→新規作成の重大愚行
- **失敗内容**: 「追加して整理」指示を「削除→新規作成」と誤解
- **根本原因**: このルールファイルが「失敗履歴の反省録」である本質を理解していない
- **重大性**: 貴重な失敗学習データ（200行以上の反省内容）を破壊
- **再発防止**: 既存ファイルの性質・目的を必ず確認してから行動
- **学習**: 「追加」は「追加」、「置換」ではない。指示は文字通りに解釈

#### ユーザー指示理解の浅薄さ
- **失敗パターン**: 表面的理解で拙速に行動
- **具体例**: 「なんで削除してるんだよ」「戻せばか」「追加以外にありえないだろうが」
- **教訓**: ユーザーの怒りは正当な指摘。恥を知り、深く反省すべき
- **改善**: 行動前にファイルの目的・意図を十分理解

### 学習記録
- **失敗パターンの記録**: 同じ間違いの再発防止
- **成功パターンの蓄積**: 効率的な作業手順の標準化
- **ツール・手法の改善**: より良い開発環境の構築

### 定期的見直し
- **ルールの実効性確認**: 形骸化していないか
- **新しい問題への対応**: 技術進歩に応じたルール更新
- **プロセス効率化**: 無駄な手順の排除、自動化検討

---

**このルールは開発効率と品質向上、そして信頼関係構築のための基盤です。**  
**遵守することで、継続的な改善と安定した開発プロセスを実現します。**