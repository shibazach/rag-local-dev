# データ登録機能実装計画

## プロジェクト概要

新系RAGシステムにおけるデータ登録機能の段階的実装計画。
旧系（OLD/）の資産を活用しつつ、モダンなアーキテクチャで再構築。

## 実装フェーズ

### フェーズ1: 基盤構築 ✅

#### 1.1 データベース接続・設定 ✅
- **実装完了**: 2024年実装完了
- **成果物**:
  - `new/config.py`: 統合設定ファイル
  - `new/database/`: DB関連モジュール
    - `connection.py`: 接続管理
    - `models.py`: テーブル定義（3テーブル構成）
    - `schemas.py`: スキーマ初期化
  - `new/test_db_connection.py`: 接続テストスクリプト

- **テーブル構成**:
  - `files_blob`: バイナリデータ（主テーブル、checksum主導）
  - `files_meta`: メタデータ（1:1対応）
  - `files_text`: OCR・整形テキスト（1:1対応）

- **確認済み**:
  - PostgreSQL 15.4 + pgvector拡張
  - 既存データ: 32ファイル存在
  - 接続・スキーマ初期化正常動作

#### 1.2 基本API構造 ✅
- **実装完了**: 2024年実装完了
- **成果物**:
  - `new/main.py`: FastAPIアプリケーション
  - `new/api/`: APIルーター群
    - `files.py`: ファイル管理API
    - `upload.py`: アップロードAPI
  - `new/schemas.py`: Pydanticスキーマ定義
  - `new/auth.py`: 認証基盤（スタブ）

- **APIエンドポイント**:
  ```
  /api/files/                 # ファイル管理
    GET /                     # ファイル一覧
    GET /{file_id}           # ファイル詳細
    PATCH /{file_id}/status  # ステータス更新
    DELETE /{file_id}        # ファイル削除

  /api/upload/               # ファイルアップロード
    POST /single            # 単一ファイル
    POST /batch             # 一括アップロード
    GET /status             # アップロード状況
  ```

- **確認済み**:
  - ヘルスチェック: `GET /health` ✅
  - APIドキュメント: `GET /docs` ✅
  - 基本エンドポイント動作確認

#### 1.3 ファイル管理基盤 🚧
- **実装中**: 認証統合とフロントエンド接続

### フェーズ2: コア機能実装

#### 2.1 ファイル処理パイプライン 🚧
- **目標**: 既存files_blobのOCR処理・LLM整形・ベクトル化
- **参考**: `OLD/app/services/ingest/worker.py`, `OLD/app/routes/ingest.py`
- **実装範囲**:
  - OCRエンジン統合（ocrmypdf、PaddleOCR、EasyOCR、Tesseract）
  - LLM整形処理（Ollama連携）
  - 埋め込みベクトル生成（SentenceTransformers、Ollama）
  - バッチ処理・エラーハンドリング・キャンセル機能

#### 2.2 データ登録API
- **目標**: フロントエンドとの完全統合
- **実装予定**:
  - ページネーション最適化
  - フィルタリング・検索機能
  - リアルタイム更新

#### 2.3 リアルタイム進捗表示
- **目標**: SSE（Server-Sent Events）実装
- **参考**: `OLD/app/routes/ingest.py`
- **実装予定**:
  - 処理状況ストリーミング
  - 進捗バー・ログ表示
  - エラー・完了通知

### フェーズ3: 高度機能・最適化

#### 3.1 LLM連携
- **目標**: Ollama統合・テキスト品質向上
- **参考**: `OLD/llm/`
- **実装予定**:
  - テキスト整形処理
  - 埋め込みベクトル生成
  - マルチモーダル処理（GPU環境）

#### 3.2 UI機能強化
- **目標**: ユーザビリティ向上
- **実装予定**:
  - ドラッグ&ドロップアップロード
  - プレビュー機能拡張
  - 一括操作・設定管理

#### 3.3 パフォーマンス・安定性
- **目標**: 本番運用対応
- **実装予定**:
  - 非同期処理最適化
  - メモリ使用量監視
  - 自動復旧・ヘルスチェック

## 技術スタック

### バックエンド
- **Framework**: FastAPI + uvicorn
- **Database**: PostgreSQL + pgvector
- **ORM**: SQLAlchemy Core
- **Validation**: Pydantic

### フロントエンド
- **Base**: HTML/CSS/JavaScript（バニラJS）
- **Styling**: CSS Grid/Flexbox統一設計
- **Communication**: Fetch API + SSE

### インフラ
- **Container**: Docker
- **LLM**: Ollama（ローカル実行）
- **OCR**: 複数エンジン対応
- **Vector**: pgvector

## 設計原則

### データベース設計
- **checksum主導**: 重複防止・整合性確保
- **UUID主キー**: 分散対応・セキュリティ
- **CASCADE削除**: データ整合性維持

### API設計
- **RESTful**: 直感的なエンドポイント設計
- **Streaming**: SSEによるリアルタイム更新
- **Error Handling**: 統一されたエラーレスポンス

### UI設計
- **統一表スタイル**: 全ページ共通デザイン
- **ブラウザ互換**: Chrome、Edge対応
- **レスポンシブ**: デスクトップ・タブレット対応

## 進捗状況

| フェーズ | 項目 | 状態 | 完了日 |
|---------|------|------|--------|
| 1.1 | データベース接続設定 | ✅ 完了 | 2024-07-31 |
| 1.1 | テーブルスキーマ | ✅ 完了 | 2024-07-31 |
| 1.2 | FastAPI基盤 | ✅ 完了 | 2024-07-31 |
| 1.2 | APIルーター | ✅ 完了 | 2024-07-31 |
| 1.3 | ファイル管理基盤 | 🚧 進行中 | - |
| 2.1 | ファイル処理パイプライン | ⏳ 待機 | - |
| 2.2 | データ登録API | ⏳ 待機 | - |
| 2.3 | SSE進捗表示 | ⏳ 待機 | - |

## 次のアクション

### 現在の焦点: フェーズ1.3 ファイル管理基盤
1. **認証統合**: APIエンドポイントの認証要件調整
2. **フロントエンド接続**: データ登録ページとAPI連携
3. **ファイルアップロード**: 単一・一括アップロード機能
4. **ステータス管理**: リアルタイム更新基盤

### 技術的課題
- **認証方式**: セッション vs JWT検討
- **ファイルサイズ**: 大容量ファイル対応
- **並行処理**: 複数ファイル同時処理

## 参考資料

### 旧系資産
- `OLD/app/routes/ingest.py`: SSE処理実装
- `OLD/db/handler.py`: DB操作ヘルパー
- `OLD/src/config.py`: 設定管理
- `.kiro/steering/`: 設計思想・ガイドライン

### 新系実装
- `UI_DESIGN_STANDARDS.md`: UI設計標準
- `new/database/`: DB関連実装
- `new/api/`: API実装

---

**最終更新**: 2024-07-31  
**次回レビュー**: フェーズ1.3完了時