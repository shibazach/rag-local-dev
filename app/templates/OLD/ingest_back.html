<!-- app/templates/ingest.html @æ›´æ–°æ—¥æ™‚: 2025-07-18 17:00 JST -->
{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', path='css/ingest.css') }}">

<div id="ingest-container">
  <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
  <button id="expand-btn" class="layout-toggle-btn" title="PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ‹¡å¼µè¡¨ç¤º">&lt;&lt;</button>
  <button id="collapse-btn" class="layout-toggle-btn" title="é€šå¸¸è¡¨ç¤ºã«æˆ»ã™">&gt;&gt;</button>

  <!-- ä¸Šãƒšã‚¤ãƒ³ -->
  <div id="pane-top">
    <!-- ä¸Šãƒšã‚¤ãƒ³å·¦å´ï¼ˆãƒ•ã‚©ãƒ¼ãƒ éƒ¨åˆ†ï¼‰ -->
    <div id="pane-top-left">
      <h1 class="page-title">âœï¸ ãƒ‡ãƒ¼ã‚¿æ•´å½¢/ç™»éŒ²</h1>
      <form id="ingest-form">
        <div class="form-section">
          {% include "partials/ingest/ingest_header.html" %}
        </div>
        <div class="form-section">
          <label for="refine-prompt">ğŸ“ æ•´å½¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼š</label>
          <select id="refine-prompt" name="refine_prompt_key">
            {% for key in prompt_keys %}
            <option value="{{ key }}">{{ key }}</option>
            {% endfor %}
          </select>
          <button type="button" id="prompt-edit-btn" style="margin-left: 0.5em;">ç¢ºèª</button>
          <span style="margin-left: 1em; color: #666; font-size: 0.9em;">ï¼ˆLLM ãƒ¢ãƒ‡ãƒ«ï¼š{{ llm_model }}ï¼‰</span>
        </div>

        <!-- OCRè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
          <label for="ocr-engine">ğŸ” OCRã‚¨ãƒ³ã‚¸ãƒ³ï¼š</label>
          <select id="ocr-engine" name="ocr_engine_id">
            <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
          </select>
          <button type="button" id="ocr-settings-btn" style="margin-left: 0.5em;">è¨­å®š</button>
          <button type="button" id="ocr-presets-btn" style="margin-left: 0.5em;">ãƒ—ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <!-- çœç•¥ï¼šåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ãƒ»ä¸Šæ›¸ããƒ»ãƒœã‚¿ãƒ³ç¾¤ -->
        <div class="form-section">
          <label style="min-width: 140px;">ğŸ“ åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ï¼š</label>
          {% for key, opt in embedding_options.items() %}
          <label style="margin-left:0.5em;">
            <input type="checkbox" name="embed_models" value="{{ key }}" checked>
            {{ loop.index }}. {{ opt.model_name }}
          </label>
          {% endfor %}
        </div>
        <div class="form-section">
          <label for="overwrite_existing" style="margin-left: 1.5em;">æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸Šæ›¸ãï¼š</label>
          <input id="overwrite_existing" type="checkbox" name="overwrite_existing" value="true">
          <label for="quality_threshold">ï¼ˆè³ªã‚¹ã‚³ã‚¢é–¾å€¤</label>
          <input id="quality_threshold" type="number" name="quality_threshold" min="0" max="1" step="0.05" value="0.0"
            style="width:4em;">
          <label>ä»¥ä¸Šã¯SKIPï¼‰</label>
        </div>
        <div class="form-section">
          <label for="llm_timeout">â±ï¸ LLMã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼š</label>
          <input id="llm_timeout" type="number" name="llm_timeout" min="0" max="3600" step="10" value="300"
            style="width:5em; text-align:center;">
          <label>ç§’ï¼ˆ0ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãªã—ï¼‰</label>
        </div>
        <div class="form-actions">
          <button type="button" id="start-btn">ğŸš€ å‡¦ç†é–‹å§‹</button>
          <button type="button" id="cancel-btn" disabled>âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <!-- PDFè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
          <span style="margin-left:1em;">
            PDFè¡¨ç¤ºï¼š<label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="embed" checked>
              åŒä¸€ã‚¿ãƒ–å†…</label>
            <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="newtab"> åˆ¥ã‚¿ãƒ–</label>
          </span>
          <!-- ãƒ†ã‚¹ãƒˆç”¨ãƒœã‚¿ãƒ³ -->
          <div style="margin-top: 0.5em;">
            <button type="button" id="test-pdf-btn"
              style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">ãƒ†ã‚¹ãƒˆç”¨PDFè¡¨ç¤º</button>
            <button type="button" id="debug-layout-btn"
              style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; margin-left: 5px;">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒãƒƒã‚°</button>
          </div>
        </div>
      </form>
    </div>

    <!-- ä¸Šãƒšã‚¤ãƒ³å³å´ï¼ˆPDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰ -->
    <div id="pane-top-right">
      <div id="pdf-preview-area">
        <iframe id="pdf-preview-frame" style="width: 100%; height: 100%; border: none;"></iframe>
      </div>
    </div>
  </div>

  <!-- ä¸‹ãƒšã‚¤ãƒ³ï¼šãƒ­ã‚° and ç·¨é›† -->
  <div id="pane-bottom">
    <div id="log-pane"></div>

    <!-- ãƒ­ã‚°ãƒšã‚¤ãƒ³ã¨ç·¨é›†ãƒšã‚¤ãƒ³ã®é–“ã«å¯å¤‰ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ -->
    <div id="splitter"></div>
    <div id="editor-pane">
      <textarea id="prompt-editor"></textarea>
    </div>
  </div>

</div>

<!-- æ‹¡å¼µãƒ¢ãƒ¼ãƒ‰ç”¨PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆç”»é¢å³å´å…¨ä½“ï¼‰ -->
<div id="splitter-expanded"></div>
<div id="pdf-preview-expanded">
  <iframe id="pdf-preview-frame-expanded" style="width: 100%; height: 100%; border: none;"></iframe>
</div>

<!-- å‡¦ç†ä¸­ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è­¦å‘Š -->
<div id="nav-warning">
  âš ï¸ ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã§ã™<br>
  ä»–ã®ãƒšãƒ¼ã‚¸ã¸ã®ç§»å‹•ã¯ã§ãã¾ã›ã‚“<br>
  <small>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã§å‡¦ç†ã‚’ä¸­æ­¢ã§ãã¾ã™</small>
</div>

<!-- OCRè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="ocr-settings-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ” OCRè¨­å®š</h3>
      <span class="close" id="ocr-settings-close">&times;</span>
    </div>
    <div id="ocr-settings-content">
      <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹è¨­å®šé …ç›® -->
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-secondary" id="ocr-settings-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button type="button" class="btn-primary" id="ocr-settings-save">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- OCRãƒ—ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="ocr-presets-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“‹ OCRãƒ—ãƒªã‚»ãƒƒãƒˆ</h3>
      <span class="close" id="ocr-presets-close">&times;</span>
    </div>
    <div style="margin-bottom: 15px;">
      <input type="text" id="new-preset-name" placeholder="æ–°ã—ã„ãƒ—ãƒªã‚»ãƒƒãƒˆå" style="width: 70%; margin-right: 10px;">
      <button type="button" class="btn-primary" id="save-current-preset">ç¾åœ¨ã®è¨­å®šã‚’ä¿å­˜</button>
    </div>
    <div id="ocr-presets-list">
      <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ -->
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-secondary" id="ocr-presets-cancel">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- REM: ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ä»˜ãï¼‰ -->
<script src="{{ url_for('static', path='js/ingest.js') }}?v=20250718"></script>
<script src="{{ url_for('static', path='js/ingest_sse.js') }}?v=20250722"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    let processingInProgress = false;
    const navWarning = document.getElementById('nav-warning');

    // å‡¦ç†é–‹å§‹æ™‚ã®åˆ¶å¾¡
    function startProcessing() {
      processingInProgress = true;
      document.body.classList.add('processing-in-progress');

      // ãƒšãƒ¼ã‚¸é›¢è„±ã®è­¦å‘Š
      window.addEventListener('beforeunload', handleBeforeUnload);

      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ç›£è¦–
      document.querySelectorAll('nav a').forEach(link => {
        link.addEventListener('click', handleNavClick);
      });
    }

    // å‡¦ç†çµ‚äº†æ™‚ã®åˆ¶å¾¡
    function endProcessing() {
      processingInProgress = false;
      document.body.classList.remove('processing-in-progress');

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
      window.removeEventListener('beforeunload', handleBeforeUnload);
      document.querySelectorAll('nav a').forEach(link => {
        link.removeEventListener('click', handleNavClick);
      });

      // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éš ã™
      navWarning.style.display = 'none';
    }

    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®è­¦å‘Š
    function handleBeforeUnload(e) {
      if (processingInProgress) {
        const message = 'ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹ã¨å‡¦ç†ãŒä¸­æ–­ã•ã‚Œã¾ã™ã€‚';
        e.preventDefault();
        e.returnValue = message;
        return message;
      }
    }

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    function handleNavClick(e) {
      if (processingInProgress) {
        e.preventDefault();
        e.stopPropagation();

        // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        navWarning.style.display = 'block';

        // 3ç§’å¾Œã«è‡ªå‹•ã§éš ã™
        setTimeout(() => {
          navWarning.style.display = 'none';
        }, 3000);

        return false;
      }
    }

    // å‡¦ç†é–‹å§‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆæ—¢å­˜ã®JavaScriptã¨é€£æºï¼‰
    const startBtn = document.getElementById('start-btn');
    const cancelBtn = document.getElementById('cancel-btn');

    if (startBtn) {
      startBtn.addEventListener('click', function () {
        // å‡¦ç†é–‹å§‹ã®åˆ¶å¾¡ã‚’è¿½åŠ 
        startProcessing();
      });
    }

    if (cancelBtn) {
      cancelBtn.addEventListener('click', function () {
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®åˆ¶å¾¡ã‚’è¿½åŠ 
        endProcessing();
      });
    }

    // å‡¦ç†å®Œäº†æ™‚ã®åˆ¶å¾¡ï¼ˆæ—¢å­˜ã®JavaScriptã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹æƒ³å®šï¼‰
    window.onIngestComplete = function () {
      endProcessing();
    };

    // å‡¦ç†ã‚¨ãƒ©ãƒ¼æ™‚ã®åˆ¶å¾¡ï¼ˆæ—¢å­˜ã®JavaScriptã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹æƒ³å®šï¼‰
    window.ingestProcessError = function () {
      endProcessing();
    };

    // OCRæ©Ÿèƒ½ã®åˆæœŸåŒ–
    initOCRFeatures();

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã®åˆæœŸåŒ–
    initLayoutToggle();

    // ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ã®åˆæœŸåŒ–
    initResizeHandlers();
  });

  // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã®åˆæœŸåŒ–
  function initLayoutToggle() {
    const expandBtn = document.getElementById('expand-btn');
    const collapseBtn = document.getElementById('collapse-btn');
    const container = document.getElementById('ingest-container');
    const pdfPreviewFrameExpanded = document.getElementById('pdf-preview-frame-expanded');

    let currentPdfUrl = null;
    let layoutState = 'no-preview'; // 'no-preview', 'preview-normal', 'preview-expanded'

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateLayoutState(newState) {
      console.log(`ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹å¤‰æ›´: ${layoutState} â†’ ${newState}`);

      // æ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      document.body.classList.remove('layout-preview-normal', 'layout-expanded');

      // æ–°ã—ã„çŠ¶æ…‹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      switch (newState) {
        case 'preview-normal':
          document.body.classList.add('layout-preview-normal');
          break;
        case 'preview-expanded':
          document.body.classList.add('layout-expanded');
          break;
        case 'no-preview':
        default:
          // ã‚¯ãƒ©ã‚¹ãªã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ï¼‰
          break;
      }

      layoutState = newState;
    }

    // æ‹¡å¼µãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ â†’ ç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
    expandBtn.addEventListener('click', function () {
      console.log('æ‹¡å¼µãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - ç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ');

      if (layoutState === 'preview-normal') {
        // ãƒªã‚µã‚¤ã‚ºè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
        if (window.resetResizeSettings) {
          window.resetResizeSettings();
        }

        updateLayoutState('preview-expanded');

        // PDFãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€æ‹¡å¼µãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
        if (currentPdfUrl) {
          console.log('PDFã‚’æ‹¡å¼µãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã«è¡¨ç¤º:', currentPdfUrl);
          pdfPreviewFrameExpanded.src = currentPdfUrl;
        }
      }
    });

    // ç¸®å°ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ â†’ ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
    collapseBtn.addEventListener('click', function () {
      console.log('ç¸®å°ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ');

      if (layoutState === 'preview-expanded') {
        // ãƒªã‚µã‚¤ã‚ºè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
        if (window.resetResizeSettings) {
          window.resetResizeSettings();
        }

        updateLayoutState('preview-normal');

        // æ‹¡å¼µãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
        pdfPreviewFrameExpanded.src = '';

        // é€šå¸¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
        if (currentPdfUrl) {
          const pdfPreviewFrame = document.getElementById('pdf-preview-frame');
          pdfPreviewFrame.src = currentPdfUrl;
        }
      }
    });

    // PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºé–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.showPdfPreview = function (pdfUrl) {
      console.log('showPdfPreviewå‘¼ã³å‡ºã—:', pdfUrl);
      currentPdfUrl = pdfUrl;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã—çŠ¶æ…‹ã®å ´åˆã¯ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ã«é·ç§»
      if (layoutState === 'no-preview') {
        updateLayoutState('preview-normal');
      }

      if (layoutState === 'preview-expanded') {
        // ç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šæ‹¡å¼µãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
        console.log('ç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ã§PDFè¡¨ç¤º:', pdfUrl);
        pdfPreviewFrameExpanded.src = pdfUrl;
      } else if (layoutState === 'preview-normal') {
        // ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šeditor-paneå†…ã«iframeã‚’ä½œæˆã—ã¦PDFè¡¨ç¤º
        console.log('ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ã§PDFè¡¨ç¤º:', pdfUrl);
        const editorPane = document.getElementById('editor-pane');

        // æ—¢å­˜ã®textareaã‚’éš ã™
        const textarea = editorPane.querySelector('textarea');
        if (textarea) {
          textarea.style.display = 'none';
        }

        // PDFç”¨ã®iframeã‚’ä½œæˆã¾ãŸã¯æ›´æ–°
        let pdfIframe = editorPane.querySelector('#pdf-iframe-pattern1');
        if (!pdfIframe) {
          pdfIframe = document.createElement('iframe');
          pdfIframe.id = 'pdf-iframe-pattern1';
          pdfIframe.style.width = '100%';
          pdfIframe.style.height = '100%';
          pdfIframe.style.border = 'none';
          editorPane.appendChild(pdfIframe);
        }

        pdfIframe.src = pdfUrl;
      }
    };

    // PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤ºé–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.hidePdfPreview = function () {
      console.log('PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã—çŠ¶æ…‹ã«é·ç§»');
      currentPdfUrl = null;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã—çŠ¶æ…‹ã«é·ç§»
      updateLayoutState('no-preview');

      // å…¨ã¦ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
      pdfPreviewFrameExpanded.src = '';
      const pdfPreviewFrame = document.getElementById('pdf-preview-frame');
      if (pdfPreviewFrame) {
        pdfPreviewFrame.src = '';
      }
    };

    // ãƒ•ã‚¡ã‚¤ãƒ«ç•ªå·ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
    function attachFileNumberClickHandlers() {
      // ãƒ­ã‚°ãƒšã‚¤ãƒ³å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ç•ªå·ãƒªãƒ³ã‚¯ã‚’ç›£è¦–
      const logPane = document.getElementById('log-pane');
      if (logPane) {
        logPane.addEventListener('click', function (event) {
          const target = event.target;

          // ãƒ•ã‚¡ã‚¤ãƒ«ç•ªå·ã®ãƒªãƒ³ã‚¯ã‹ã©ã†ã‹ã‚’åˆ¤å®š
          if (target.tagName === 'A' && target.textContent.match(/^\d+$/)) {
            console.log('ãƒ•ã‚¡ã‚¤ãƒ«ç•ªå·ãƒªãƒ³ã‚¯ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:', target.textContent);

            // PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã—çŠ¶æ…‹ã«æˆ»ã™
            window.hidePdfPreview();

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªãƒ³ã‚¯å‹•ä½œã¯ç¶™ç¶š
          }
        });
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã¨ãƒ­ã‚°æ›´æ–°æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ç•ªå·ãƒªãƒ³ã‚¯ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®š
    attachFileNumberClickHandlers();

    // MutationObserverã§ãƒ­ã‚°ãƒšã‚¤ãƒ³ã®å¤‰æ›´ã‚’ç›£è¦–
    const logPane = document.getElementById('log-pane');
    if (logPane) {
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.type === 'childList') {
            // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ç•ªå·ãƒªãƒ³ã‚¯ãŒè¿½åŠ ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§å†è¨­å®š
            attachFileNumberClickHandlers();
          }
        });
      });

      observer.observe(logPane, {
        childList: true,
        subtree: true
      });
    }
  }

  // OCRæ©Ÿèƒ½ã®åˆæœŸåŒ–
  function initOCRFeatures() {
    let availableEngines = {};
    let currentEngineSettings = {};

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«OCRã‚¨ãƒ³ã‚¸ãƒ³ä¸€è¦§ã‚’å–å¾—
    loadOCREngines();

    // OCRã‚¨ãƒ³ã‚¸ãƒ³é¸æŠã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('ocr-engine').addEventListener('change', function () {
      const engineId = this.value;
      if (engineId) {
        loadEngineSettings(engineId);
      }
    });

    // OCRè¨­å®šãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('ocr-settings-btn').addEventListener('click', function () {
      const engineId = document.getElementById('ocr-engine').value;
      if (!engineId) {
        alert('OCRã‚¨ãƒ³ã‚¸ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      showOCRSettingsModal(engineId);
    });

    // OCRãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('ocr-presets-btn').addEventListener('click', function () {
      showOCRPresetsModal();
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('ocr-settings-close').addEventListener('click', closeOCRSettingsModal);
    document.getElementById('ocr-settings-cancel').addEventListener('click', closeOCRSettingsModal);
    document.getElementById('ocr-presets-close').addEventListener('click', closeOCRPresetsModal);
    document.getElementById('ocr-presets-cancel').addEventListener('click', closeOCRPresetsModal);

    // OCRè¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('ocr-settings-save').addEventListener('click', saveOCRSettings);

    // ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('save-current-preset').addEventListener('click', saveCurrentPreset);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.addEventListener('click', function (event) {
      const settingsModal = document.getElementById('ocr-settings-modal');
      const presetsModal = document.getElementById('ocr-presets-modal');
      if (event.target === settingsModal) {
        closeOCRSettingsModal();
      }
      if (event.target === presetsModal) {
        closeOCRPresetsModal();
      }
    });

    // OCRã‚¨ãƒ³ã‚¸ãƒ³ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadOCREngines() {
      try {
        const response = await fetch('/ingest/ocr/engines');
        availableEngines = await response.json();

        const select = document.getElementById('ocr-engine');
        select.innerHTML = '<option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>';

        for (const [engineId, engineInfo] of Object.entries(availableEngines)) {
          const option = document.createElement('option');
          option.value = engineId;
          option.textContent = `${engineInfo.name} ${engineInfo.available ? 'âœ“' : 'âœ—'}`;
          option.disabled = !engineInfo.available;
          select.appendChild(option);
        }
      } catch (error) {
        console.error('OCRã‚¨ãƒ³ã‚¸ãƒ³ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
      }
    }

    // ã‚¨ãƒ³ã‚¸ãƒ³è¨­å®šã‚’èª­ã¿è¾¼ã¿
    async function loadEngineSettings(engineId) {
      try {
        const response = await fetch(`/ingest/ocr/settings/${engineId}`);
        const data = await response.json();
        currentEngineSettings = data.settings;
      } catch (error) {
        console.error('ã‚¨ãƒ³ã‚¸ãƒ³è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
        currentEngineSettings = {};
      }
    }

    // OCRè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showOCRSettingsModal(engineId) {
      const modal = document.getElementById('ocr-settings-modal');
      const content = document.getElementById('ocr-settings-content');

      if (!availableEngines[engineId]) {
        alert('ã‚¨ãƒ³ã‚¸ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      const engineInfo = availableEngines[engineId];
      const parameters = engineInfo.parameters || [];

      // è¨­å®šé …ç›®ã‚’å‹•çš„ç”Ÿæˆ
      content.innerHTML = '';

      if (parameters.length === 0) {
        content.innerHTML = '<p>ã“ã®ã‚¨ãƒ³ã‚¸ãƒ³ã«ã¯è¨­å®šå¯èƒ½ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      } else {
        parameters.forEach(param => {
          const group = document.createElement('div');
          group.className = 'ocr-setting-group';

          const label = document.createElement('label');
          label.textContent = param.label;
          group.appendChild(label);

          let input;
          const currentValue = currentEngineSettings[param.name] !== undefined
            ? currentEngineSettings[param.name]
            : param.default;

          if (param.type === 'checkbox') {
            input = document.createElement('input');
            input.type = 'checkbox';
            input.checked = currentValue;
          } else if (param.type === 'number') {
            input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            if (param.min !== undefined) input.min = param.min;
            if (param.max !== undefined) input.max = param.max;
            if (param.step !== undefined) input.step = param.step;
          } else if (param.type === 'select') {
            input = document.createElement('select');
            param.options.forEach(option => {
              const opt = document.createElement('option');
              opt.value = option.value;
              opt.textContent = option.label;
              opt.selected = option.value === currentValue;
              input.appendChild(opt);
            });
          } else {
            input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
          }

          input.dataset.paramName = param.name;
          group.appendChild(input);

          if (param.description) {
            const desc = document.createElement('div');
            desc.className = 'ocr-setting-description';
            desc.textContent = param.description;
            group.appendChild(desc);
          }

          content.appendChild(group);
        });
      }

      modal.style.display = 'block';
    }

    // OCRè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeOCRSettingsModal() {
      document.getElementById('ocr-settings-modal').style.display = 'none';
    }

    // OCRãƒ—ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    async function showOCRPresetsModal() {
      const modal = document.getElementById('ocr-presets-modal');
      const list = document.getElementById('ocr-presets-list');

      try {
        const response = await fetch('/ingest/ocr/presets');
        const presets = await response.json();

        list.innerHTML = '';

        if (Object.keys(presets).length === 0) {
          list.innerHTML = '<p>ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒªã‚»ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        } else {
          for (const [presetName, presetData] of Object.entries(presets)) {
            const item = document.createElement('div');
            item.className = 'preset-item';

            const info = document.createElement('div');
            info.className = 'preset-info';

            const name = document.createElement('div');
            name.className = 'preset-name';
            name.textContent = presetName;
            info.appendChild(name);

            const details = document.createElement('div');
            details.className = 'preset-details';
            details.textContent = `ã‚¨ãƒ³ã‚¸ãƒ³: ${presetData.engine} | ä½œæˆæ—¥: ${new Date(presetData.created_at).toLocaleDateString()}`;
            info.appendChild(details);

            item.appendChild(info);

            const actions = document.createElement('div');

            const loadBtn = document.createElement('button');
            loadBtn.textContent = 'èª­ã¿è¾¼ã¿';
            loadBtn.className = 'btn-primary';
            loadBtn.style.marginRight = '5px';
            loadBtn.addEventListener('click', () => loadPreset(presetName, presetData));
            actions.appendChild(loadBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'å‰Šé™¤';
            deleteBtn.className = 'btn-secondary';
            deleteBtn.addEventListener('click', () => deletePreset(presetName));
            actions.appendChild(deleteBtn);

            item.appendChild(actions);
            list.appendChild(item);
          }
        }

        modal.style.display = 'block';
      } catch (error) {
        console.error('ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
        alert('ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // OCRãƒ—ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeOCRPresetsModal() {
      document.getElementById('ocr-presets-modal').style.display = 'none';
    }

    // OCRè¨­å®šã‚’ä¿å­˜
    async function saveOCRSettings() {
      const engineId = document.getElementById('ocr-engine').value;
      if (!engineId) return;

      const settings = {};
      const inputs = document.querySelectorAll('#ocr-settings-content input, #ocr-settings-content select');

      inputs.forEach(input => {
        const paramName = input.dataset.paramName;
        if (paramName) {
          if (input.type === 'checkbox') {
            settings[paramName] = input.checked;
          } else if (input.type === 'number') {
            settings[paramName] = parseFloat(input.value);
          } else {
            settings[paramName] = input.value;
          }
        }
      });

      try {
        const response = await fetch(`/ingest/ocr/settings/${engineId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(settings)
        });

        if (response.ok) {
          currentEngineSettings = settings;
          alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          closeOCRSettingsModal();
        } else {
          alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ç¾åœ¨ã®è¨­å®šã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆã¨ã—ã¦ä¿å­˜
    async function saveCurrentPreset() {
      const presetName = document.getElementById('new-preset-name').value.trim();
      const engineId = document.getElementById('ocr-engine').value;

      if (!presetName) {
        alert('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (!engineId) {
        alert('OCRã‚¨ãƒ³ã‚¸ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const response = await fetch('/ingest/ocr/presets', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            preset_name: presetName,
            engine_id: engineId,
            settings: currentEngineSettings
          })
        });

        if (response.ok) {
          alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          document.getElementById('new-preset-name').value = '';
          showOCRPresetsModal(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        } else {
          alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿
    function loadPreset(presetName, presetData) {
      document.getElementById('ocr-engine').value = presetData.engine;
      currentEngineSettings = presetData.settings;
      alert(`ãƒ—ãƒªã‚»ãƒƒãƒˆ "${presetName}" ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      closeOCRPresetsModal();
    }

    // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤
    async function deletePreset(presetName) {
      if (!confirm(`ãƒ—ãƒªã‚»ãƒƒãƒˆ "${presetName}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      try {
        const response = await fetch(`/ingest/ocr/presets/${encodeURIComponent(presetName)}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          showOCRPresetsModal(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        } else {
          alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('ãƒ—ãƒªã‚»ãƒƒãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«OCRè¨­å®šã‚’å«ã‚ã‚‹
    const originalStartBtn = document.getElementById('start-btn');
    if (originalStartBtn) {
      originalStartBtn.addEventListener('click', function () {
        // OCRè¨­å®šã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¿½åŠ 
        const form = document.getElementById('ingest-form');

        // æ—¢å­˜ã®OCRè¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
        const existingOCRSettings = form.querySelector('input[name="ocr_settings"]');
        if (existingOCRSettings) {
          existingOCRSettings.remove();
        }

        // OCRè¨­å®šã‚’è¿½åŠ 
        const ocrSettingsInput = document.createElement('input');
        ocrSettingsInput.type = 'hidden';
        ocrSettingsInput.name = 'ocr_settings';
        ocrSettingsInput.value = JSON.stringify(currentEngineSettings);
        form.appendChild(ocrSettingsInput);
      });
    }

    // ãƒ†ã‚¹ãƒˆç”¨ãƒœã‚¿ãƒ³ã¨ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const testPdfBtn = document.getElementById('test-pdf-btn');
    const debugLayoutBtn = document.getElementById('debug-layout-btn');

    if (testPdfBtn) {
      testPdfBtn.addEventListener('click', function () {
        console.log('ãƒ†ã‚¹ãƒˆç”¨PDFãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');

        // ç°¡å˜ãªãƒ†ã‚¹ãƒˆç”¨PDFï¼ˆæœ€å°é™ã®PDFãƒ‡ãƒ¼ã‚¿ï¼‰
        const testPdfUrl = 'data:application/pdf;base64,JVBERi0xLjQKMSAwIG9iago8PAovVHlwZSAvQ2F0YWxvZwovUGFnZXMgMiAwIFIKPj4KZW5kb2JqCjIgMCBvYmoKPDwKL1R5cGUgL1BhZ2VzCi9LaWRzIFszIDAgUl0KL0NvdW50IDEKPD4KZW5kb2JqCjMgMCBvYmoKPDwKL1R5cGUgL1BhZ2UKL1BhcmVudCAyIDAgUgovTWVkaWFCb3ggWzAgMCA2MTIgNzkyXQovUmVzb3VyY2VzIDw8Ci9Gb250IDw8Ci9GMSA0IDAgUgo+Pgo+PgovQ29udGVudHMgNSAwIFIKPj4KZW5kb2JqCjQgMCBvYmoKPDwKL1R5cGUgL0ZvbnQKL1N1YnR5cGUgL1R5cGUxCi9CYXNlRm9udCAvSGVsdmV0aWNhCj4+CmVuZG9iago1IDAgb2JqCjw8Ci9MZW5ndGggNDQKPj4Kc3RyZWFtCkJUCi9GMSAxMiBUZgoxMDAgNzAwIFRkCihUZXN0IFBERikgVGoKRVQKZW5kc3RyZWFtCmVuZG9iagp4cmVmCjAgNgowMDAwMDAwMDAwIDY1NTM1IGYgCjAwMDAwMDAwMDkgMDAwMDAgbiAKMDAwMDAwMDA1OCAwMDAwMCBuIAowMDAwMDAwMTE1IDAwMDAwIG4gCjAwMDAwMDAyNDUgMDAwMDAgbiAKMDAwMDAwMDMxNCAwMDAwMCBuIAp0cmFpbGVyCjw8Ci9TaXplIDYKL1Jvb3QgMSAwIFIKPj4Kc3RhcnR4cmVmCjQwOAolJUVPRg==';

        console.log('PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚’è©¦è¡Œ:', testPdfUrl.substring(0, 50) + '...');

        // PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºé–¢æ•°ã‚’å‘¼ã³å‡ºã—
        if (window.showPdfPreview) {
          window.showPdfPreview(testPdfUrl);
          console.log('showPdfPreviewé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã—ãŸ');
        } else {
          console.error('showPdfPreviewé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          alert('showPdfPreviewé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      });
    }

    if (debugLayoutBtn) {
      debugLayoutBtn.addEventListener('click', function () {
        console.log('=== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');

        const main = document.querySelector('main');
        const ingestContainer = document.getElementById('ingest-container');
        const pdfExpanded = document.getElementById('pdf-preview-expanded');

        console.log('mainè¦ç´ :', main);
        console.log('mainè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«:', window.getComputedStyle(main));
        console.log('mainè¦ç´ ã®display:', window.getComputedStyle(main).display);
        console.log('mainè¦ç´ ã®flex-direction:', window.getComputedStyle(main).flexDirection);

        console.log('ingest-containerè¦ç´ :', ingestContainer);
        console.log('ingest-containerè¦ç´ ã®flex:', window.getComputedStyle(ingestContainer).flex);

        console.log('pdf-preview-expandedè¦ç´ :', pdfExpanded);
        console.log('pdf-preview-expandedè¦ç´ ã®display:', window.getComputedStyle(pdfExpanded).display);
        console.log('pdf-preview-expandedè¦ç´ ã®flex:', window.getComputedStyle(pdfExpanded).flex);

        console.log('bodyè¦ç´ ã®ã‚¯ãƒ©ã‚¹:', document.body.className);
        console.log('layout-expandedã‚¯ãƒ©ã‚¹ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹:', document.body.classList.contains('layout-expanded'));

        alert('ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸã€‚F12ã‚­ãƒ¼ã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      });
    }
  }

  // ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ã®åˆæœŸåŒ–
  function initResizeHandlers() {
    let isResizing = false;
    let currentSplitter = null;
    let startX = 0;
    let containerWidth = 0;

    // ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ç”¨ã®ãƒªã‚µã‚¤ã‚ºå‡¦ç†
    const splitter = document.getElementById('splitter');
    const logPane = document.getElementById('log-pane');
    const editorPane = document.getElementById('editor-pane');

    // ç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ç”¨ã®ãƒªã‚µã‚¤ã‚ºå‡¦ç†
    const splitterExpanded = document.getElementById('splitter-expanded');
    const ingestContainer = document.getElementById('ingest-container');
    const pdfPreviewExpanded = document.getElementById('pdf-preview-expanded');

    // ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼
    if (splitter) {
      splitter.addEventListener('mousedown', function (e) {
        console.log('ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');

        // ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã‚’ç¢ºèª
        if (!document.body.classList.contains('layout-preview-normal')) {
          console.log('ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯ãªã„ãŸã‚ã€ãƒªã‚µã‚¤ã‚ºã‚’ç„¡åŠ¹åŒ–');
          return;
        }

        isResizing = true;
        currentSplitter = 'normal';
        startX = e.clientX;

        const paneBottom = document.getElementById('pane-bottom');
        containerWidth = paneBottom.getBoundingClientRect().width - 5; // ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼å¹…ã‚’é™¤ã

        // æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
        logPane.style.width = '';
        logPane.style.flex = '';
        editorPane.style.width = '';
        editorPane.style.flex = '';

        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
        e.stopPropagation();

        console.log(`ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒªã‚µã‚¤ã‚ºé–‹å§‹: ã‚³ãƒ³ãƒ†ãƒŠå¹…=${containerWidth}px`);
      });
    }

    // ç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼
    if (splitterExpanded) {
      splitterExpanded.addEventListener('mousedown', function (e) {
        console.log('ç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');

        // ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã‚’ç¢ºèª
        if (!document.body.classList.contains('layout-expanded')) {
          console.log('ç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯ãªã„ãŸã‚ã€ãƒªã‚µã‚¤ã‚ºã‚’ç„¡åŠ¹åŒ–');
          return;
        }

        isResizing = true;
        currentSplitter = 'expanded';
        startX = e.clientX;

        const mainRect = document.querySelector('main').getBoundingClientRect();
        containerWidth = mainRect.width - 5; // ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼å¹…ã‚’é™¤ã

        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
        e.stopPropagation();

        console.log(`ç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒªã‚µã‚¤ã‚ºé–‹å§‹: ã‚³ãƒ³ãƒ†ãƒŠå¹…=${containerWidth}px`);
      });
    }

    // ãƒã‚¦ã‚¹ç§»å‹•æ™‚ã®å‡¦ç†
    document.addEventListener('mousemove', function (e) {
      if (!isResizing) return;

      const currentX = e.clientX;
      const deltaX = currentX - startX;

      if (currentSplitter === 'normal') {
        // ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒªã‚µã‚¤ã‚ºå‡¦ç†
        // ç¾åœ¨ã®ãƒã‚¦ã‚¹ä½ç½®ã‹ã‚‰å·¦å´ã®å¹…ã‚’è¨ˆç®—
        const paneBottom = document.getElementById('pane-bottom');
        const paneRect = paneBottom.getBoundingClientRect();
        const leftWidth = currentX - paneRect.left;
        const rightWidth = paneRect.right - currentX - 5; // ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼å¹…ã‚’é™¤ã

        // æœ€å°å¹…ã®åˆ¶é™ï¼ˆ20%ï¼‰
        const minWidth = containerWidth * 0.2;
        if (leftWidth >= minWidth && rightWidth >= minWidth) {
          const leftPercentage = (leftWidth / containerWidth) * 100;
          const rightPercentage = (rightWidth / containerWidth) * 100;

          // resizingã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã¦CSSã®ç«¶åˆã‚’å›é¿
          logPane.classList.add('resizing');
          editorPane.classList.add('resizing');

          // widthãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç›´æ¥è¨­å®š
          logPane.style.width = `${leftPercentage}%`;
          editorPane.style.width = `${rightPercentage}%`;

          console.log(`ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒªã‚µã‚¤ã‚º: å·¦=${leftPercentage.toFixed(1)}%, å³=${rightPercentage.toFixed(1)}%`);
        }
      } else if (currentSplitter === 'expanded') {
        // ç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒªã‚µã‚¤ã‚ºå‡¦ç†
        const mainRect = document.querySelector('main').getBoundingClientRect();
        const leftWidth = currentX - mainRect.left;
        const rightWidth = mainRect.right - currentX - 5; // ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼å¹…ã‚’é™¤ã

        // æœ€å°å¹…ã®åˆ¶é™ï¼ˆ20%ï¼‰
        const minWidth = containerWidth * 0.2;
        if (leftWidth >= minWidth && rightWidth >= minWidth) {
          const leftPercentage = (leftWidth / containerWidth) * 100;
          const rightPercentage = (rightWidth / containerWidth) * 100;

          // resizingã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã¦CSSã®ç«¶åˆã‚’å›é¿
          ingestContainer.classList.add('resizing');
          pdfPreviewExpanded.classList.add('resizing');

          // widthãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç›´æ¥è¨­å®š
          ingestContainer.style.width = `${leftPercentage}%`;
          pdfPreviewExpanded.style.width = `${rightPercentage}%`;

          console.log(`ç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒªã‚µã‚¤ã‚º: å·¦=${leftPercentage.toFixed(1)}%, å³=${rightPercentage.toFixed(1)}%`);
        }
      }
    });

    // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—æ™‚ã®å‡¦ç†
    document.addEventListener('mouseup', function () {
      if (isResizing) {
        console.log('ãƒªã‚µã‚¤ã‚ºçµ‚äº†');
        isResizing = false;
        currentSplitter = null;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      }
    });

    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰ãƒã‚¦ã‚¹ãŒå‡ºãŸæ™‚ã®å‡¦ç†
    document.addEventListener('mouseleave', function () {
      if (isResizing) {
        console.log('ãƒã‚¦ã‚¹ãŒã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰å‡ºãŸãŸã‚ã€ãƒªã‚µã‚¤ã‚ºçµ‚äº†');
        isResizing = false;
        currentSplitter = null;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      }
    });

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆæ™‚ã«ãƒªã‚µã‚¤ã‚ºè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetResizeSettings() {
      // ç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒªã‚»ãƒƒãƒˆ
      logPane.style.width = '';
      logPane.style.flex = '';
      logPane.classList.remove('resizing');
      editorPane.style.width = '';
      editorPane.style.flex = '';
      editorPane.classList.remove('resizing');

      // ç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒªã‚»ãƒƒãƒˆ
      ingestContainer.style.width = '';
      ingestContainer.style.flex = '';
      ingestContainer.classList.remove('resizing');
      pdfPreviewExpanded.style.width = '';
      pdfPreviewExpanded.style.flex = '';
      pdfPreviewExpanded.classList.remove('resizing');

      console.log('ãƒªã‚µã‚¤ã‚ºè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    }

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆæ™‚ã«ãƒªã‚»ãƒƒãƒˆé–¢æ•°ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.resetResizeSettings = resetResizeSettings;
  }
</script>

{% endblock %}