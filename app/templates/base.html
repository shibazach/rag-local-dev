<!-- app/templates/base.html @2025-07-18 00:00 UTC +9 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç ”ç©¶éƒ¨RAG</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    /* REM: å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: sans-serif;
    }
    /* REM: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    nav {
      width: 200px;
      background: #f4f4f4;
      border-right: 1px solid #ddd;
      padding: 1em;
      box-sizing: border-box;
    }
    nav h2 {
      margin-top: 0;
      font-size: 1.2em;
    }
    nav ul {
      list-style: none;
      padding: 0;
    }
    nav li + li {
      margin-top: 0.5em;
    }
    nav a {
      text-decoration: none;
      color: #333;
    }
    nav a:hover {
      text-decoration: underline;
    }
    /* REM: ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    main {
      flex: 1;
      padding: 0;
      overflow: auto;
    }
    /* REM: ãƒšãƒ¼ã‚¸ã”ã¨ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    .page-title {
      margin: 0 0 8px;
      font-size: 1.2em;
      line-height: 1.5em;
    }
    .index-title {
      margin: 0 0 8px;
      line-height: 1.5em;
    }
  </style>
  <!-- REM: ãƒšãƒ¼ã‚¸å›ºæœ‰ã® head è¦ç´ ã‚’ã“ã“ã«è¿½åŠ  -->
  {% block head %}{% endblock %}
</head>
<body>
  <nav>
    <!-- REM: ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¿ã‚¤ãƒˆãƒ« -->
    <h2><a href="/" style="text-decoration:none; color:inherit;">ç ”ç©¶éƒ¨ RAG</a></h2>
    <ul>
      <li><a href="/ingest">ğŸ“š ãƒ‡ãƒ¼ã‚¿æ•´å½¢/ç™»éŒ²</a></li>
      <li><a href="/chat">ğŸ” ãƒãƒ£ãƒƒãƒˆæ¤œç´¢</a></li>
      <li><a href="/try_ocr">ğŸ”¬ OCRæ©Ÿèƒ½æ¯”è¼ƒ</a></li>
    </ul>
    <hr>
    <!-- è¾æ›¸ç·¨é›†ãƒœã‚¿ãƒ³ç¾¤ -->
    <div id="dict-buttons" style="padding:0.5em 0;">
      <div style="font-weight:bold; margin-bottom:0.5em; font-size:0.9em;">ğŸ“ OCRè¾æ›¸ç·¨é›†</div>
      
      <div class="dict-btn-container" onclick="loadDictDirect('ä¸€èˆ¬ç”¨èª')" style="cursor:pointer; margin-bottom:0.3em; padding:0.4em; border:1px solid #ddd; border-radius:3px; background:#f9f9f9; text-align:center;">
        <div style="font-size:0.85em; font-weight:bold;">ğŸ“„ ä¸€èˆ¬ç”¨èª</div>
        <div style="font-size:0.7em; color:#888;" id="dict-count-ä¸€èˆ¬ç”¨èª">--ä»¶</div>
      </div>
      
      <div class="dict-btn-container" onclick="loadDictDirect('å°‚é–€ç”¨èª')" style="cursor:pointer; margin-bottom:0.3em; padding:0.4em; border:1px solid #ddd; border-radius:3px; background:#f9f9f9; text-align:center;">
        <div style="font-size:0.85em; font-weight:bold;">ğŸ”¬ å°‚é–€ç”¨èª</div>
        <div style="font-size:0.7em; color:#888;" id="dict-count-å°‚é–€ç”¨èª">--ä»¶</div>
      </div>
      
      <div class="dict-btn-container" onclick="loadDictDirect('èª¤å­—ä¿®æ­£')" style="cursor:pointer; margin-bottom:0.3em; padding:0.4em; border:1px solid #ddd; border-radius:3px; background:#f9f9f9; text-align:center;">
        <div style="font-size:0.85em; font-weight:bold;">ğŸ”§ èª¤å­—ä¿®æ­£</div>
        <div style="font-size:0.7em; color:#888;" id="dict-count-èª¤å­—ä¿®æ­£">--ä»¶</div>
      </div>
      
      <div class="dict-btn-container" onclick="loadDictDirect('å½¢æ…‹ç´ è¾æ›¸')" style="cursor:pointer; margin-bottom:0.3em; padding:0.4em; border:1px solid #ddd; border-radius:3px; background:#f9f9f9; text-align:center;">
        <div style="font-size:0.85em; font-weight:bold;">âš™ï¸ å½¢æ…‹ç´ è¾æ›¸</div>
        <div style="font-size:0.7em; color:#888;" id="dict-count-å½¢æ…‹ç´ è¾æ›¸">--ä»¶</div>
      </div>
    </div>
    <hr>
    <!-- REM: ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¡¨ç¤ºç”¨ -->
    <div id="system-monitor">
      <p>CPU ä½¿ç”¨ç‡ï¼š<span id="cpu-usage">--</span>%</p>
      <p id="gpu-info" style="display:none">
        GPU ä½¿ç”¨ç‡ï¼š<span id="gpu-util">--</span>%<br>
        æ¶ˆè²»é›»åŠ›ï¼š<span id="gpu-power">--</span>W
      </p>
    </div>
  </nav>

  <!-- è¾æ›¸ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="dict-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border-radius:8px; width:80%; max-width:800px; max-height:80%; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <div style="padding:1em; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;" id="dict-modal-title">ğŸ“ OCRè¾æ›¸ç·¨é›†</h3>
        <button id="dict-modal-close" style="background:none; border:none; font-size:1.5em; cursor:pointer;">&times;</button>
      </div>
      <div style="display:flex; flex-direction:column; height:60vh;">
        <div id="dict-editor" style="display:flex; flex-direction:column; height:100%;">
          <div style="margin-bottom:1em; display:flex; justify-content:flex-end; align-items:center; flex-shrink:0; padding:0 1em;">
            <div>
              <button id="dict-save-btn" style="background:#4CAF50; color:white; border:none; padding:0.5em 1em; border-radius:4px; cursor:pointer;">ğŸ’¾ ä¿å­˜</button>
              <button id="dict-add-btn" style="background:#2196F3; color:white; border:none; padding:0.5em 1em; border-radius:4px; cursor:pointer; margin-left:0.5em;">â• è¿½åŠ </button>
            </div>
          </div>
          <div id="dict-content" style="flex:1; padding:0 1em 1em 1em; overflow:hidden;">
            <textarea id="dict-textarea" style="width:100%; height:100%; font-family:monospace; font-size:0.9em; border:1px solid #ddd; border-radius:4px; padding:0.5em; box-sizing:border-box; resize:none;"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- REM: ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–
    setInterval(async () => {
      try {
        const res = await fetch('/metrics');
        if (!res.ok) return;
        const j = await res.json();
        // REM: j.cpu ãŒæœªå®šç¾©ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!j || typeof j.cpu !== 'number') return;
        document.getElementById('cpu-usage').textContent = j.cpu.toFixed(1);
        // REM: GPU æƒ…å ±ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
        if (j.gpu && typeof j.gpu.util === 'number') {
          document.getElementById('gpu-info').style.display = 'block';
          document.getElementById('gpu-util').textContent = j.gpu.util.toFixed(1);
          // REM: GPU power ãŒæ•°å€¤ãªã‚‰è¡¨ç¤º
          if (typeof j.gpu.power === 'number') {
            document.getElementById('gpu-power').textContent = j.gpu.power.toFixed(1);
          }
        }
      } catch (e) {
        console.error('metrics fetch error:', e);
      }
    }, 3000);

    // è¾æ›¸ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
    document.addEventListener('DOMContentLoaded', () => {
      const dictModal = document.getElementById('dict-modal');
      const dictModalClose = document.getElementById('dict-modal-close');
      const dictSaveBtn = document.getElementById('dict-save-btn');
      const dictAddBtn = document.getElementById('dict-add-btn');
      const dictTextarea = document.getElementById('dict-textarea');
      
      let currentDict = null;

      // ç›´æ¥è¾æ›¸ç·¨é›†ã‚’é–‹ã
      window.loadDictDirect = async function(dictName) {
        dictModal.style.display = 'block';
        
        try {
          // è¾æ›¸æƒ…å ±ã‚’å–å¾—ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
          const [contentResponse, listResponse] = await Promise.all([
            fetch(`/api/dict/content/${encodeURIComponent(dictName)}`),
            fetch('/api/dict/list')
          ]);
          
          const dictData = await contentResponse.json();
          const dictList = await listResponse.json();
          
          currentDict = dictData;
          
          // ã‚¿ã‚¤ãƒˆãƒ«ã«è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
          const dictInfo = dictList.find(d => d.name === dictName);
          if (dictInfo) {
            const titleElement = document.getElementById('dict-modal-title');
            const icon = dictName === 'ä¸€èˆ¬ç”¨èª' ? 'ğŸ“„' : 
                        dictName === 'å°‚é–€ç”¨èª' ? 'ğŸ”¬' : 
                        dictName === 'èª¤å­—ä¿®æ­£' ? 'ğŸ”§' : 'âš™ï¸';
            titleElement.innerHTML = `
              <div style="font-size:1.2em; font-weight:bold; line-height:1.5em;">${icon} ${dictName}</div>
              <div style="font-size:0.75em; color:#666; font-weight:normal; margin-top:0.2em;">${dictInfo.description} | ${dictInfo.entry_count}ä»¶ | ${dictInfo.modified}</div>
            `;
          }
          
          // CSVãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤º
          let content = '';
          if (dictData.headers && dictData.headers.length > 0) {
            content += dictData.headers.join(',') + '\n';
          }
          if (dictData.data && dictData.data.length > 0) {
            dictData.data.forEach(row => {
              content += row.join(',') + '\n';
            });
          }
          
          dictTextarea.value = content;
          
        } catch (error) {
          alert('è¾æ›¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          console.error('è¾æ›¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          dictModal.style.display = 'none';
        }
      };

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¾æ›¸ãƒœã‚¿ãƒ³ã®ä»¶æ•°ã‚’æ›´æ–°
      loadDictButtonCounts();

      // è¾æ›¸ãƒœã‚¿ãƒ³ã®ä»¶æ•°ã‚’èª­ã¿è¾¼ã¿
      async function loadDictButtonCounts() {
        try {
          const response = await fetch('/api/dict/list');
          const dicts = await response.json();
          
          dicts.forEach(dict => {
            const countElement = document.getElementById(`dict-count-${dict.name}`);
            if (countElement) {
              countElement.textContent = `${dict.entry_count}ä»¶`;
            }
          });
          
        } catch (error) {
          console.error('è¾æ›¸ä»¶æ•°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
      dictModalClose.addEventListener('click', () => {
        dictModal.style.display = 'none';
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      dictModal.addEventListener('click', (e) => {
        if (e.target === dictModal) {
          dictModal.style.display = 'none';
        }
      });

      // è¾æ›¸ã‚’ä¿å­˜
      dictSaveBtn.addEventListener('click', async () => {
        if (!currentDict) return;
        
        try {
          const formData = new FormData();
          formData.append('content', dictTextarea.value);
          
          const response = await fetch(`/api/dict/save/${encodeURIComponent(currentDict.name)}`, {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('ä¿å­˜ã—ã¾ã—ãŸ');
          } else {
            alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
          }
          
        } catch (error) {
          alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
          console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        }
      });

      // ã‚¨ãƒ³ãƒˆãƒªè¿½åŠ 
      dictAddBtn.addEventListener('click', () => {
        if (!currentDict) return;
        
        let newEntry = '';
        if (currentDict.type === 'single_column') {
          newEntry = prompt('è¿½åŠ ã™ã‚‹ç”¨èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
          if (newEntry) {
            dictTextarea.value += newEntry + '\n';
          }
        } else if (currentDict.type === 'two_column') {
          newEntry = prompt('èª¤å­—,æ­£å­— ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„:');
          if (newEntry && newEntry.includes(',')) {
            dictTextarea.value += newEntry + '\n';
          } else if (newEntry) {
            alert('ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: å¥‘ç´„æ‰€,å¥‘ç´„æ›¸ï¼‰');
          }
        } else {
          alert('ã“ã®è¾æ›¸ã‚¿ã‚¤ãƒ—ã®è¿½åŠ æ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™');
        }
      });
    });
  </script>

  <main>
    {% block content %}{% endblock %}
  </main>
</body>
</html>
