<!-- app/templates/chat.html -->
{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='css/chat.css') }}">
{% endblock %}

{% block content %}
<div id="app-container" class="layout-no-preview">
  <!-- 上部設定エリア（設定パネルを最初から配置） -->
  <div id="top-container" class="settings-container">
    <!-- 設定パネル -->
    <div id="settings-panel" class="panel">
      <!-- レイアウト切り替えボタン -->
      <div id="layout-controls">
        <button id="pattern1-btn" class="layout-btn">▽</button>
        <button id="pattern2-btn" class="layout-btn">△</button>
      </div>
      <div class="panel-content">
        <h1 class="page-title">🔍 チャット検索</h1>
        
        <div class="form-section">
          <textarea id="query" rows="4" placeholder="質問を入力してください…" style="width: 100%; box-sizing: border-box; resize: vertical;"></textarea>
        </div>
        
        <div class="form-section">
          <label for="mode" style="min-width: 120px;">検索モード：</label>
          <select id="mode">
            <option value="チャンク統合">チャンク統合</option>
            <option value="ファイル別（要約+一致度）" selected>ファイル別（要約+一致度）</option>
          </select>
          <label for="model_key" style="margin-left:1em;">埋め込みモデル：</label>
          <select id="model_key">
            {% for key, config in embedding_options.items() %}
            <option value="{{ key }}">{{ config["model_name"] }} ({{ config["embedder"] }})</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="form-section">
          <label for="search_limit" style="min-width: 120px;">検索件数：</label>
          <input type="number" id="search_limit" min="1" max="50" value="10" style="width:4em;">
          <span style="margin-left:0.5em; color:#666; font-size:0.9em;">件</span>

          <label for="min_score" style="margin-left:1em;">最小一致度：</label>
          <input type="number" id="min_score" min="0" max="1" step="0.1" value="0.0" style="width:4em;">
          <span style="margin-left:0.5em; color:#666; font-size:0.9em;">以上</span>
        </div>
        
        <div class="form-section">
          <label for="search_timeout">⏱️ 検索タイムアウト：</label>
          <input id="search_timeout" type="number" min="0" max="3600" step="5" value="10" style="width:5em; text-align:center;">
          <label>秒（0でタイムアウトなし）</label>
        </div>
        
        <div class="form-actions">
          <button id="search-btn">🔍 検索実行</button>
          <button id="history-btn">📜 履歴</button>
          <span id="loading" style="display: none; color: #555; margin-left: 8px;">検索中…お待ちください</span>
          
          <span style="margin-left:1em;">
            PDF表示：<label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="embed" checked> 同一タブ内</label>
            <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="newtab"> 別タブ</label>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- 上下リサイザー（第1パターンで表示） -->
  <div id="top-resizer" class="resizer horizontal-resizer"></div>

  <!-- 下部コンテナ -->
  <div id="bottom-container">
    <!-- 左側：設定+検索結果 -->
    <div id="left-pane">
      <!-- 左側設定エリア（第2パターン用コンテナ） -->
      <div id="left-container" class="settings-container">
        <!-- 設定パネルがここに移動される -->
      </div>

      <!-- 左右リサイザー（第2パターンで表示） -->
      <div id="left-resizer" class="resizer horizontal-resizer"></div>

      <!-- 検索結果パネル -->
      <div id="log-panel" class="panel">
        <div class="panel-content">
          <div id="log-content">
            <div id="answer" style="display: none; margin: 12px 0; padding: 8px 12px; border: 1px solid #888; border-radius: 4px; background: #eef;">
              <h2 style="margin: 0 0 8px; font-size: 1.2em;">統合回答</h2>
              <pre style="margin: 0; white-space: pre-wrap;"></pre>
            </div>
            <div id="results">
              <p style="color:#888; text-align:center; margin-top:2em;">
                質問を入力して「検索実行」ボタンを押してください
              </p>
            </div>
            <!-- 詳細表示エリア -->
            <div id="detail-content" style="display: none; margin-top: 1em; padding: 1em; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 左右リサイザー -->
    <div id="vertical-resizer" class="resizer vertical-resizer"></div>

    <!-- 右側：PDFパネル -->
    <div id="pdf-panel" class="panel">
      <div class="panel-content" style="padding: 0;">
        <iframe id="pdf-frame" src=""></iframe>
      </div>
    </div>
  </div>
</div>



<!-- 検索中オーバーレイ -->
<div id="search-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); color: #fff; z-index: 10000; font-size: 1.4em; display: flex; align-items: center; justify-content: center; flex-direction: column;">
  <div class="search-spinner"></div>
  <div id="search-message">検索中…</div>
  <div id="search-details" style="font-size: 0.8em; margin-top: 0.5em; color: #ccc;"></div>
  <button id="search-cancel-overlay-btn" style="margin-top: 1em; padding: 0.5em 1em; font-size: 1em; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; transition: all 0.2s;">✖️ キャンセル</button>
</div>

<!-- 再ベクトル化処理中オーバーレイ -->
<div id="processing-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); color: #fff; z-index: 10000; font-size: 1.4em; display: flex; align-items: center; justify-content: center; flex-direction: column;">
  <div id="overlay-message">再ベクトル化中…<br>閉じないでください</div>
  <button id="overlay-ok-btn" style="display: none; margin-top: 1em; padding: 0.5em 1em; font-size: 1em;">OK</button>
</div>

<!-- 処理中のナビゲーション警告 -->
<div id="nav-warning" style="display: none;">
  ⚠️ 検索処理中です<br>
  他のページへの移動はできません<br>
  <small>キャンセルボタンで処理を中止できます</small>
</div>

<!-- 履歴ダイアログ -->
<div id="history-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10002;">
  <div id="history-modal-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);"></div>
  <div id="history-modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 800px; height: 70%; background: white; border-radius: 8px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;">
    <div id="history-modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1em; border-bottom: 1px solid #ddd; background: #f8f9fa; border-radius: 8px 8px 0 0;">
      <h3 style="margin: 0; color: #333;">📜 検索履歴</h3>
      <button id="history-modal-close" style="background: none; border: none; font-size: 1.2em; cursor: pointer; padding: 0.5em; border-radius: 4px;">✖️</button>
    </div>
    <div id="history-modal-body" style="flex: 1; overflow-y: auto; padding: 1em;">
      <div id="history-list"></div>
    </div>
    <div id="history-modal-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 1em; border-top: 1px solid #ddd; background: #f8f9fa; border-radius: 0 0 8px 8px; gap: 0.5em;">
      <button id="history-expand-btn" disabled style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">📖 展開</button>
      <button id="history-restore-btn" disabled style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">🔄 復元</button>
      <button id="history-delete-btn" disabled style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">🗑️ 削除</button>
      <select id="history-download-format" style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">
        <option value="txt">TXT</option>
        <option value="json">JSON</option>
        <option value="rtf">RTF</option>
        <option value="docx">DOCX</option>
      </select>
      <button id="history-download-btn" style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">💾 ダウンロード</button>
      <button id="history-clear-btn" style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">🗑️ 全削除</button>
    </div>
  </div>
</div>



<!-- 機能別に分割されたJavaScriptファイル -->
<script src="{{ url_for('static', path='js/chat_layout.js') }}"></script>
<script src="{{ url_for('static', path='js/chat_resize.js') }}"></script>
<script src="{{ url_for('static', path='js/chat_search.js') }}"></script>
<script src="{{ url_for('static', path='js/chat_history.js') }}"></script>
<script src="{{ url_for('static', path='js/chat_main.js') }}"></script>

{% endblock %}
</content>