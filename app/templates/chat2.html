<!-- app/templates/chat2.html @ä½œæˆæ—¥æ™‚: 2025-07-25 -->
<!-- REM: ingestã¨åŒæ§˜ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚’é©ç”¨ã—ãŸchatãƒšãƒ¼ã‚¸ -->
{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='css/chat.css') }}">
{% endblock %}

{% block content %}
<div id="chat-container" class="layout-no-preview">
  <!-- ä¸Šéƒ¨æ¤œç´¢ã‚¨ãƒªã‚¢ï¼ˆæ¤œç´¢ãƒ‘ãƒãƒ«ã‚’æœ€åˆã‹ã‚‰é…ç½®ï¼‰ -->
  <div id="top-container" class="search-container">
    <!-- æ¤œç´¢ãƒ‘ãƒãƒ« -->
    <div id="search-panel" class="panel">
      <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
      <div id="layout-controls">
        <button id="pattern1-btn" class="layout-btn">&lt;&lt;</button>
        <button id="pattern2-btn" class="layout-btn">&gt;&gt;</button>
      </div>
      <div class="panel-content">
        <h1 class="page-title">ğŸ” ãƒãƒ£ãƒƒãƒˆæ¤œç´¢</h1>
        
        <div class="form-section">
          <textarea id="query" rows="4" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦" style="width: 100%; box-sizing: border-box; resize: vertical;"></textarea>
        </div>
        
        <div class="form-section">
          <label for="mode" style="min-width: 120px;">æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ï¼š</label>
          <select id="mode">
            <option value="ãƒãƒ£ãƒ³ã‚¯çµ±åˆ">ãƒãƒ£ãƒ³ã‚¯çµ±åˆ</option>
            <option value="ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ï¼ˆè¦ç´„+ä¸€è‡´åº¦ï¼‰" selected>ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ï¼ˆè¦ç´„+ä¸€è‡´åº¦ï¼‰</option>
          </select>
          <label for="model_key" style="margin-left:1em;">åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ï¼š</label>
          <select id="model_key">
            {% for key, config in embedding_options.items() %}
            <option value="{{ key }}">{{ config["model_name"] }} ({{ config["embedder"] }})</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="form-section">
          <label for="search_limit" style="min-width: 120px;">æ¤œç´¢ä»¶æ•°ï¼š</label>
          <input type="number" id="search_limit" min="1" max="50" value="10" style="width:4em;">
          <span style="margin-left:0.5em; color:#666; font-size:0.9em;">ä»¶</span>

          <label for="min_score" style="margin-left:1em;">æœ€å°ä¸€è‡´åº¦ï¼š</label>
          <input type="number" id="min_score" min="0" max="1" step="0.1" value="0.0" style="width:4em;">
          <span style="margin-left:0.5em; color:#666; font-size:0.9em;">ä»¥ä¸Š</span>
        </div>
        
        <div class="form-actions">
          <button id="search-btn">ğŸ” æ¤œç´¢å®Ÿè¡Œ</button>
          <button id="cancel-btn" disabled>âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="history-btn">ğŸ“œ å±¥æ­´</button>
          <span id="loading" style="display: none; color: #555; margin-left: 8px;">æ¤œç´¢ä¸­â€¦ãŠå¾…ã¡ãã ã•ã„</span>
          
          <span style="margin-left:1em;">
            PDFè¡¨ç¤ºï¼š<label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="embed" checked> åŒä¸€ã‚¿ãƒ–å†…</label>
            <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="newtab"> åˆ¥ã‚¿ãƒ–</label>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸Šä¸‹ãƒªã‚µã‚¤ã‚¶ãƒ¼ï¼ˆç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¡¨ç¤ºï¼‰ -->
  <div id="top-resizer" class="resizer horizontal-resizer"></div>

  <!-- ä¸‹éƒ¨ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div id="bottom-container">
    <!-- å·¦å´ï¼šæ¤œç´¢+çµæœ -->
    <div id="left-pane">
      <!-- å·¦å´æ¤œç´¢ã‚¨ãƒªã‚¢ï¼ˆç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ç”¨ã‚³ãƒ³ãƒ†ãƒŠï¼‰ -->
      <div id="left-container" class="search-container">
        <!-- æ¤œç´¢ãƒ‘ãƒãƒ«ãŒã“ã“ã«ç§»å‹•ã•ã‚Œã‚‹ -->
      </div>

      <!-- å·¦å³ãƒªã‚µã‚¤ã‚¶ãƒ¼ï¼ˆç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¡¨ç¤ºï¼‰ -->
      <div id="left-resizer" class="resizer horizontal-resizer"></div>

      <!-- çµæœãƒ‘ãƒãƒ« -->
      <div id="results-panel" class="panel">
        <div class="panel-content">
          <div id="results-content">
            <div id="answer" style="display: none; margin: 12px 0; padding: 8px 12px; border: 1px solid #888; border-radius: 4px; background: #eef;">
              <h2 style="margin: 0 0 8px; font-size: 1.2em;">çµ±åˆå›ç­”</h2>
              <pre style="margin: 0; white-space: pre-wrap;"></pre>
            </div>
            <div id="results"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- å·¦å³ãƒªã‚µã‚¤ã‚¶ãƒ¼ -->
    <div id="vertical-resizer" class="resizer vertical-resizer"></div>

    <!-- å³å´ï¼šPDFãƒ‘ãƒãƒ« -->
    <div id="pdf-panel" class="panel">
      <div class="panel-content" style="padding: 0;">
        <iframe id="pdf-frame" src=""></iframe>
      </div>
    </div>
  </div>
</div>

<!-- æ¤œç´¢ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="search-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); color: #fff; z-index: 9999; font-size: 1.2em; display: flex; align-items: center; justify-content: center; flex-direction: column;">
  <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 1em;"></div>
  <div id="search-message">æ¤œç´¢æº–å‚™ä¸­â€¦</div>
  <div id="search-details" style="font-size: 0.9em; margin-top: 0.5em; opacity: 0.8;"></div>
</div>

<!-- å‡¦ç†ä¸­ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è­¦å‘Š -->
<div id="nav-warning" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 193, 7, 0.95); color: #856404; padding: 1em 1.5em; border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); z-index: 10001; font-weight: bold; text-align: center; border: 2px solid #ffc107;">
  âš ï¸ æ¤œç´¢å‡¦ç†ä¸­ã§ã™<br>
  ä»–ã®ãƒšãƒ¼ã‚¸ã¸ã®ç§»å‹•ã¯ã§ãã¾ã›ã‚“<br>
  <small>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã§å‡¦ç†ã‚’ä¸­æ­¢ã§ãã¾ã™</small>
</div>

<!-- å±¥æ­´ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="history-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10002;">
  <div id="history-modal-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);"></div>
  <div id="history-modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 800px; height: 70%; background: white; border-radius: 8px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;">
    <div id="history-modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1em; border-bottom: 1px solid #ddd; background: #f8f9fa; border-radius: 8px 8px 0 0;">
      <h3 style="margin: 0; color: #333;">ğŸ“œ æ¤œç´¢å±¥æ­´</h3>
      <button id="history-modal-close" style="background: none; border: none; font-size: 1.2em; cursor: pointer; padding: 0.5em; border-radius: 4px;">âœ–ï¸</button>
    </div>
    <div id="history-modal-body" style="flex: 1; overflow-y: auto; padding: 1em;">
      <div id="history-list"></div>
    </div>
    <div id="history-modal-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 1em; border-top: 1px solid #ddd; background: #f8f9fa; border-radius: 0 0 8px 8px; gap: 0.5em;">
      <button id="history-expand-btn" disabled style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">ğŸ“– å±•é–‹</button>
      <button id="history-restore-btn" disabled style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">ğŸ”„ å¾©å…ƒ</button>
      <button id="history-delete-btn" disabled style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">ğŸ—‘ï¸ å‰Šé™¤</button>
      <select id="history-download-format" style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">
        <option value="txt">TXT</option>
        <option value="json">JSON</option>
        <option value="rtf">RTF</option>
        <option value="docx">DOCX</option>
      </select>
      <button id="history-download-btn" style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button id="history-clear-btn" style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
    </div>
  </div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* çµæœã‚«ãƒ¼ãƒ‰ */
.card {
    border: 1px solid #ddd;
    padding: 12px;
    margin: 8px 0;
    border-radius: 4px;
    background: #fafafa;
}

.card h3 {
    margin: 0 0 6px;
    font-size: 1.1em;
}

.card pre {
    white-space: pre-wrap;
    background: #f5f5f5;
    padding: 8px;
    border-radius: 4px;
    overflow-x: auto;
}

.card button {
    margin-top: 6px;
    padding: 4px 8px;
}

/* ãƒ•ã‚©ãƒ¼ãƒ  */
.form-section {
    display: flex;
    align-items: center;
    margin-bottom: 0.1em;
    line-height: 1.2;
    width: 100%;
}

.form-section label {
    min-width: 120px;
    flex-shrink: 0;
}

.form-actions {
    margin-top: 1em;
}

.form-actions button {
    margin-right: 1em;
}

.page-title {
    margin: 0 0 8px;
    font-size: 1.2em;
    line-height: 1.5em;
}

.search-container {
    display: flex;
    flex-direction: column;
    position: relative;
}
</style>

<!-- æ©Ÿèƒ½åˆ¥ã«åˆ†å‰²ã•ã‚ŒãŸJavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
<script src="{{ url_for('static', path='js/chat_layout.js') }}"></script>
<script src="{{ url_for('static', path='js/chat_resize.js') }}"></script>
<script src="{{ url_for('static', path='js/chat_search.js') }}"></script>
<script src="{{ url_for('static', path='js/chat_main.js') }}"></script>

{% endblock %}
</content>