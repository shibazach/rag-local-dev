<!-- app/templates/ingest.html @æ›´æ–°æ—¥æ™‚: 2025-07-18 17:00 JST -->
{% extends "base.html" %}
{% block content %}

<style>
  /* ãƒšã‚¤ãƒ³ä¸Šä¸‹åˆ†å‰² */
  #ingest-container { display:flex; flex-direction:column; height:calc(100vh - 2em); }

  /* ä¸Šãƒšã‚¤ãƒ³ */
  #pane-top {
    flex:0 0 auto;
    padding:1em;
    border-bottom:1px solid rgba(255, 255, 255, 0.4);
    box-sizing:border-box;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(15px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    position: relative;
  }
  
  /* ä¸Šãƒšã‚¤ãƒ³ã®èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  #pane-top::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(248, 249, 250, 0.1) 100%);
    z-index: -1;
  }

  /* ä¸‹ãƒšã‚¤ãƒ³ï¼šãƒ­ã‚°ã¨ç·¨é›†ãƒšã‚¤ãƒ³ã‚’å·¦å³ä¸¦ã³ã« */
  #pane-bottom {
    flex:1 1 auto;
    display:flex;
    overflow:hidden;
    position: relative;
  }
  /* å·¦ã‚«ãƒ©ãƒ ï¼šãƒ­ã‚° */
  #log-pane {
    flex:1 1 auto;
    overflow-y:auto;
    padding:1em;
    background:#fafafa;
    box-sizing:border-box;
  }

  /* REM: ãƒšã‚¤ãƒ³é–“ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ */
  #splitter {
    flex: 0 0 5px;
    cursor: col-resize;
    background: #ccc;
  }

  /* å³ã‚«ãƒ©ãƒ ï¼šç·¨é›†ã‚¨ãƒªã‚¢ */
  #editor-pane {
    flex:0 0 40%;
    display:none;
    border-left:1px solid #ccc;
    box-sizing:border-box;
    overflow:hidden;
  }
  #editor-pane textarea {
    width:100%; height:100%; border:none;
    padding:1em; box-sizing:border-box;
    resize:none; overflow:auto;
  }

  /* ãƒ•ã‚©ãƒ¼ãƒ  */
  #ingest-form { display:block; width:100%; }
  .form-section {
    display:flex; align-items:center;
    margin-bottom:0.1em; line-height:1.2; width:100%;
  }
  .form-section label {
    min-width: 120px;
    flex-shrink: 0;
  }
  /* REM: è³ªã‚¹ã‚³ã‚¢é–¾å€¤å…¥åŠ›ã‚’ä¸­å¤®å¯„ã› */
  #quality_threshold { text-align: center; }
  .form-actions { margin-top:1em; }
  .form-actions button { margin-right:1em; }

  /* ãƒ­ã‚°è¡¨ç¤º */
  .file-header   { background:#eef; padding:4px 8px; font-weight:bold; margin-top:1em; }
  .file-progress { font-size:0.9em; color:#555; margin-left:1ch; }
  .page-header   { margin-left:1ch; font-style:italic; }
  .file-section  { margin-left:1em; margin-bottom:1em; }
  .file-section pre { white-space:pre-wrap; word-break:break-word; background:#fff; padding:8px; border:1px solid #ddd; }

  /* å‡¦ç†ä¸­ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ– */
  body.processing-in-progress nav a {
    pointer-events: none;
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  body.processing-in-progress nav a::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.1);
    z-index: 1;
  }
  
  /* å‡¦ç†ä¸­ã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
  #nav-warning {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 193, 7, 0.95);
    color: #856404;
    padding: 1em 1.5em;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    z-index: 10001;
    font-weight: bold;
    text-align: center;
    border: 2px solid #ffc107;
  }

  /* OCRè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  
  .modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
  }
  
  .close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  
  .close:hover,
  .close:focus {
    color: black;
  }
  
  .ocr-setting-group {
    margin-bottom: 15px;
  }
  
  .ocr-setting-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }
  
  .ocr-setting-group input,
  .ocr-setting-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
  }
  
  .ocr-setting-group input[type="checkbox"] {
    width: auto;
    margin-right: 8px;
  }
  
  .ocr-setting-description {
    font-size: 0.9em;
    color: #666;
    margin-top: 3px;
  }
  
  .modal-actions {
    margin-top: 20px;
    text-align: right;
    border-top: 1px solid #ddd;
    padding-top: 15px;
  }
  
  .modal-actions button {
    margin-left: 10px;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  
  .btn-primary {
    background-color: #007bff;
    color: white;
  }
  
  .btn-secondary {
    background-color: #6c757d;
    color: white;
  }
  
  .preset-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 8px;
  }
  
  .preset-info {
    flex: 1;
  }
  
  .preset-name {
    font-weight: bold;
  }
  
  .preset-details {
    font-size: 0.9em;
    color: #666;
  }


</style>

<div id="ingest-container">
  <!-- ä¸Šãƒšã‚¤ãƒ³ -->
  <div id="pane-top">
    <h1 class="page-title">âœï¸ ãƒ‡ãƒ¼ã‚¿æ•´å½¢/ç™»éŒ²</h1>
    <form id="ingest-form">
      <div class="form-section">
        {% include "partials/ingest/ingest_header.html" %}
      </div>
      <div class="form-section">
        <label for="refine-prompt">ğŸ“ æ•´å½¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼š</label>
        <select id="refine-prompt" name="refine_prompt_key">
          {% for key in prompt_keys %}
            <option value="{{ key }}">{{ key }}</option>
          {% endfor %}
        </select>
        <button type="button" id="prompt-edit-btn" style="margin-left: 0.5em;">ç¢ºèª</button>
        <span style="margin-left: 1em; color: #666; font-size: 0.9em;">ï¼ˆLLM ãƒ¢ãƒ‡ãƒ«ï¼š{{ llm_model }}ï¼‰</span>
      </div>
      
      <!-- OCRè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="form-section">
        <label for="ocr-engine">ğŸ” OCRã‚¨ãƒ³ã‚¸ãƒ³ï¼š</label>
        <select id="ocr-engine" name="ocr_engine_id">
          <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
        </select>
        <button type="button" id="ocr-settings-btn" style="margin-left: 0.5em;">è¨­å®š</button>
        <button type="button" id="ocr-presets-btn" style="margin-left: 0.5em;">ãƒ—ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <!-- çœç•¥ï¼šåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ãƒ»ä¸Šæ›¸ããƒ»ãƒœã‚¿ãƒ³ç¾¤ -->
      <div class="form-section">
        <label style="min-width: 140px;">ğŸ“ åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ï¼š</label>
        {% for key, opt in embedding_options.items() %}
          <label style="margin-left:0.5em;">
            <input type="checkbox" name="embed_models" value="{{ key }}" checked>
            {{ loop.index }}. {{ opt.model_name }}
          </label>
        {% endfor %}
      </div>
      <div class="form-section">
        <label for="overwrite_existing" style="margin-left: 1.5em;">æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸Šæ›¸ãï¼š</label>
        <input id="overwrite_existing" type="checkbox" name="overwrite_existing" value="true">
        <label for="quality_threshold">ï¼ˆè³ªã‚¹ã‚³ã‚¢é–¾å€¤</label>
        <input id="quality_threshold" type="number" name="quality_threshold" min="0" max="1" step="0.05" value="0.0" style="width:4em;">
        <label>ä»¥ä¸Šã¯SKIPï¼‰</label>
      </div>
      <div class="form-actions">
        <button type="button" id="start-btn">ğŸš€ å‡¦ç†é–‹å§‹</button>
        <button type="button" id="cancel-btn" disabled>âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <!-- REM: PDFè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
        <span style="margin-left:1em;">
          PDFè¡¨ç¤ºï¼š<label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="embed" checked> åŒä¸€ã‚¿ãƒ–å†…</label>
          <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="newtab"> åˆ¥ã‚¿ãƒ–</label>
        </span>
      </div>
    </form>
  </div>

  <!-- ä¸‹ãƒšã‚¤ãƒ³ï¼šãƒ­ã‚° and ç·¨é›† -->
  <div id="pane-bottom">
    <div id="log-pane"></div>

    <!-- REM: ãƒ­ã‚°ãƒšã‚¤ãƒ³ã¨ç·¨é›†ãƒšã‚¤ãƒ³ã®é–“ã«å¯å¤‰ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ -->
    <div id="splitter"></div>
    <div id="editor-pane">
      <textarea id="prompt-editor"></textarea>
    </div>
    

  </div>
</div>

<!-- å‡¦ç†ä¸­ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è­¦å‘Š -->
<div id="nav-warning">
  âš ï¸ ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã§ã™<br>
  ä»–ã®ãƒšãƒ¼ã‚¸ã¸ã®ç§»å‹•ã¯ã§ãã¾ã›ã‚“<br>
  <small>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã§å‡¦ç†ã‚’ä¸­æ­¢ã§ãã¾ã™</small>
</div>

<!-- OCRè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="ocr-settings-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ” OCRè¨­å®š</h3>
      <span class="close" id="ocr-settings-close">&times;</span>
    </div>
    <div id="ocr-settings-content">
      <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹è¨­å®šé …ç›® -->
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-secondary" id="ocr-settings-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button type="button" class="btn-primary" id="ocr-settings-save">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- OCRãƒ—ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="ocr-presets-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“‹ OCRãƒ—ãƒªã‚»ãƒƒãƒˆ</h3>
      <span class="close" id="ocr-presets-close">&times;</span>
    </div>
    <div style="margin-bottom: 15px;">
      <input type="text" id="new-preset-name" placeholder="æ–°ã—ã„ãƒ—ãƒªã‚»ãƒƒãƒˆå" style="width: 70%; margin-right: 10px;">
      <button type="button" class="btn-primary" id="save-current-preset">ç¾åœ¨ã®è¨­å®šã‚’ä¿å­˜</button>
    </div>
    <div id="ocr-presets-list">
      <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ -->
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-secondary" id="ocr-presets-cancel">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- REM: ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ä»˜ãï¼‰ -->
<script src="{{ url_for('static', path='js/ingest.js') }}?v=20250718"></script>
<script src="{{ url_for('static', path='js/ingest_sse.js') }}?v=20250718"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let processingInProgress = false;
  const navWarning = document.getElementById('nav-warning');
  
  // å‡¦ç†é–‹å§‹æ™‚ã®åˆ¶å¾¡
  function startProcessing() {
    processingInProgress = true;
    document.body.classList.add('processing-in-progress');
    
    // ãƒšãƒ¼ã‚¸é›¢è„±ã®è­¦å‘Š
    window.addEventListener('beforeunload', handleBeforeUnload);
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ç›£è¦–
    document.querySelectorAll('nav a').forEach(link => {
      link.addEventListener('click', handleNavClick);
    });
  }
  
  // å‡¦ç†çµ‚äº†æ™‚ã®åˆ¶å¾¡
  function endProcessing() {
    processingInProgress = false;
    document.body.classList.remove('processing-in-progress');
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
    window.removeEventListener('beforeunload', handleBeforeUnload);
    document.querySelectorAll('nav a').forEach(link => {
      link.removeEventListener('click', handleNavClick);
    });
    
    // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éš ã™
    navWarning.style.display = 'none';
  }
  
  // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®è­¦å‘Š
  function handleBeforeUnload(e) {
    if (processingInProgress) {
      const message = 'ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹ã¨å‡¦ç†ãŒä¸­æ–­ã•ã‚Œã¾ã™ã€‚';
      e.preventDefault();
      e.returnValue = message;
      return message;
    }
  }
  
  // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
  function handleNavClick(e) {
    if (processingInProgress) {
      e.preventDefault();
      e.stopPropagation();
      
      // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      navWarning.style.display = 'block';
      
      // 3ç§’å¾Œã«è‡ªå‹•ã§éš ã™
      setTimeout(() => {
        navWarning.style.display = 'none';
      }, 3000);
      
      return false;
    }
  }
  
  // å‡¦ç†é–‹å§‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆæ—¢å­˜ã®JavaScriptã¨é€£æºï¼‰
  const startBtn = document.getElementById('start-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  
  if (startBtn) {
    startBtn.addEventListener('click', function() {
      // å‡¦ç†é–‹å§‹ã®åˆ¶å¾¡ã‚’è¿½åŠ 
      startProcessing();
    });
  }
  
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function() {
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®åˆ¶å¾¡ã‚’è¿½åŠ 
      endProcessing();
    });
  }
  
  // å‡¦ç†å®Œäº†æ™‚ã®åˆ¶å¾¡ï¼ˆæ—¢å­˜ã®JavaScriptã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹æƒ³å®šï¼‰
  window.onIngestComplete = function() {
    endProcessing();
  };
  
  // å‡¦ç†ã‚¨ãƒ©ãƒ¼æ™‚ã®åˆ¶å¾¡ï¼ˆæ—¢å­˜ã®JavaScriptã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹æƒ³å®šï¼‰
  window.ingestProcessError = function() {
    endProcessing();
  };

  // OCRæ©Ÿèƒ½ã®åˆæœŸåŒ–
  initOCRFeatures();
});

// OCRæ©Ÿèƒ½ã®åˆæœŸåŒ–
function initOCRFeatures() {
  let availableEngines = {};
  let currentEngineSettings = {};
  
  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«OCRã‚¨ãƒ³ã‚¸ãƒ³ä¸€è¦§ã‚’å–å¾—
  loadOCREngines();
  
  // OCRã‚¨ãƒ³ã‚¸ãƒ³é¸æŠã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('ocr-engine').addEventListener('change', function() {
    const engineId = this.value;
    if (engineId) {
      loadEngineSettings(engineId);
    }
  });
  
  // OCRè¨­å®šãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('ocr-settings-btn').addEventListener('click', function() {
    const engineId = document.getElementById('ocr-engine').value;
    if (!engineId) {
      alert('OCRã‚¨ãƒ³ã‚¸ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    showOCRSettingsModal(engineId);
  });
  
  // OCRãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('ocr-presets-btn').addEventListener('click', function() {
    showOCRPresetsModal();
  });
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('ocr-settings-close').addEventListener('click', closeOCRSettingsModal);
  document.getElementById('ocr-settings-cancel').addEventListener('click', closeOCRSettingsModal);
  document.getElementById('ocr-presets-close').addEventListener('click', closeOCRPresetsModal);
  document.getElementById('ocr-presets-cancel').addEventListener('click', closeOCRPresetsModal);
  
  // OCRè¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('ocr-settings-save').addEventListener('click', saveOCRSettings);
  
  // ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('save-current-preset').addEventListener('click', saveCurrentPreset);
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  window.addEventListener('click', function(event) {
    const settingsModal = document.getElementById('ocr-settings-modal');
    const presetsModal = document.getElementById('ocr-presets-modal');
    if (event.target === settingsModal) {
      closeOCRSettingsModal();
    }
    if (event.target === presetsModal) {
      closeOCRPresetsModal();
    }
  });
  
  // OCRã‚¨ãƒ³ã‚¸ãƒ³ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
  async function loadOCREngines() {
    try {
      const response = await fetch('/ingest/ocr/engines');
      availableEngines = await response.json();
      
      const select = document.getElementById('ocr-engine');
      select.innerHTML = '<option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>';
      
      for (const [engineId, engineInfo] of Object.entries(availableEngines)) {
        const option = document.createElement('option');
        option.value = engineId;
        option.textContent = `${engineInfo.name} ${engineInfo.available ? 'âœ“' : 'âœ—'}`;
        option.disabled = !engineInfo.available;
        select.appendChild(option);
      }
    } catch (error) {
      console.error('OCRã‚¨ãƒ³ã‚¸ãƒ³ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
    }
  }
  
  // ã‚¨ãƒ³ã‚¸ãƒ³è¨­å®šã‚’èª­ã¿è¾¼ã¿
  async function loadEngineSettings(engineId) {
    try {
      const response = await fetch(`/ingest/ocr/settings/${engineId}`);
      const data = await response.json();
      currentEngineSettings = data.settings;
    } catch (error) {
      console.error('ã‚¨ãƒ³ã‚¸ãƒ³è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
      currentEngineSettings = {};
    }
  }
  
  // OCRè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  function showOCRSettingsModal(engineId) {
    const modal = document.getElementById('ocr-settings-modal');
    const content = document.getElementById('ocr-settings-content');
    
    if (!availableEngines[engineId]) {
      alert('ã‚¨ãƒ³ã‚¸ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const engineInfo = availableEngines[engineId];
    const parameters = engineInfo.parameters || [];
    
    // è¨­å®šé …ç›®ã‚’å‹•çš„ç”Ÿæˆ
    content.innerHTML = '';
    
    if (parameters.length === 0) {
      content.innerHTML = '<p>ã“ã®ã‚¨ãƒ³ã‚¸ãƒ³ã«ã¯è¨­å®šå¯èƒ½ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    } else {
      parameters.forEach(param => {
        const group = document.createElement('div');
        group.className = 'ocr-setting-group';
        
        const label = document.createElement('label');
        label.textContent = param.label;
        group.appendChild(label);
        
        let input;
        const currentValue = currentEngineSettings[param.name] !== undefined 
          ? currentEngineSettings[param.name] 
          : param.default;
        
        if (param.type === 'checkbox') {
          input = document.createElement('input');
          input.type = 'checkbox';
          input.checked = currentValue;
        } else if (param.type === 'number') {
          input = document.createElement('input');
          input.type = 'number';
          input.value = currentValue;
          if (param.min !== undefined) input.min = param.min;
          if (param.max !== undefined) input.max = param.max;
          if (param.step !== undefined) input.step = param.step;
        } else if (param.type === 'select') {
          input = document.createElement('select');
          param.options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.value;
            opt.textContent = option.label;
            opt.selected = option.value === currentValue;
            input.appendChild(opt);
          });
        } else {
          input = document.createElement('input');
          input.type = 'text';
          input.value = currentValue;
        }
        
        input.dataset.paramName = param.name;
        group.appendChild(input);
        
        if (param.description) {
          const desc = document.createElement('div');
          desc.className = 'ocr-setting-description';
          desc.textContent = param.description;
          group.appendChild(desc);
        }
        
        content.appendChild(group);
      });
    }
    
    modal.style.display = 'block';
  }
  
  // OCRè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  function closeOCRSettingsModal() {
    document.getElementById('ocr-settings-modal').style.display = 'none';
  }
  
  // OCRãƒ—ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  async function showOCRPresetsModal() {
    const modal = document.getElementById('ocr-presets-modal');
    const list = document.getElementById('ocr-presets-list');
    
    try {
      const response = await fetch('/ingest/ocr/presets');
      const presets = await response.json();
      
      list.innerHTML = '';
      
      if (Object.keys(presets).length === 0) {
        list.innerHTML = '<p>ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒªã‚»ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      } else {
        for (const [presetName, presetData] of Object.entries(presets)) {
          const item = document.createElement('div');
          item.className = 'preset-item';
          
          const info = document.createElement('div');
          info.className = 'preset-info';
          
          const name = document.createElement('div');
          name.className = 'preset-name';
          name.textContent = presetName;
          info.appendChild(name);
          
          const details = document.createElement('div');
          details.className = 'preset-details';
          details.textContent = `ã‚¨ãƒ³ã‚¸ãƒ³: ${presetData.engine} | ä½œæˆæ—¥: ${new Date(presetData.created_at).toLocaleDateString()}`;
          info.appendChild(details);
          
          item.appendChild(info);
          
          const actions = document.createElement('div');
          
          const loadBtn = document.createElement('button');
          loadBtn.textContent = 'èª­ã¿è¾¼ã¿';
          loadBtn.className = 'btn-primary';
          loadBtn.style.marginRight = '5px';
          loadBtn.addEventListener('click', () => loadPreset(presetName, presetData));
          actions.appendChild(loadBtn);
          
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'å‰Šé™¤';
          deleteBtn.className = 'btn-secondary';
          deleteBtn.addEventListener('click', () => deletePreset(presetName));
          actions.appendChild(deleteBtn);
          
          item.appendChild(actions);
          list.appendChild(item);
        }
      }
      
      modal.style.display = 'block';
    } catch (error) {
      console.error('ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
      alert('ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
  
  // OCRãƒ—ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  function closeOCRPresetsModal() {
    document.getElementById('ocr-presets-modal').style.display = 'none';
  }
  
  // OCRè¨­å®šã‚’ä¿å­˜
  async function saveOCRSettings() {
    const engineId = document.getElementById('ocr-engine').value;
    if (!engineId) return;
    
    const settings = {};
    const inputs = document.querySelectorAll('#ocr-settings-content input, #ocr-settings-content select');
    
    inputs.forEach(input => {
      const paramName = input.dataset.paramName;
      if (paramName) {
        if (input.type === 'checkbox') {
          settings[paramName] = input.checked;
        } else if (input.type === 'number') {
          settings[paramName] = parseFloat(input.value);
        } else {
          settings[paramName] = input.value;
        }
      }
    });
    
    try {
      const response = await fetch(`/ingest/ocr/settings/${engineId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
      });
      
      if (response.ok) {
        currentEngineSettings = settings;
        alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        closeOCRSettingsModal();
      } else {
        alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
  
  // ç¾åœ¨ã®è¨­å®šã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆã¨ã—ã¦ä¿å­˜
  async function saveCurrentPreset() {
    const presetName = document.getElementById('new-preset-name').value.trim();
    const engineId = document.getElementById('ocr-engine').value;
    
    if (!presetName) {
      alert('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (!engineId) {
      alert('OCRã‚¨ãƒ³ã‚¸ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    try {
      const response = await fetch('/ingest/ocr/presets', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          preset_name: presetName,
          engine_id: engineId,
          settings: currentEngineSettings
        })
      });
      
      if (response.ok) {
        alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        document.getElementById('new-preset-name').value = '';
        showOCRPresetsModal(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
      } else {
        alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
  
  // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿
  function loadPreset(presetName, presetData) {
    document.getElementById('ocr-engine').value = presetData.engine;
    currentEngineSettings = presetData.settings;
    alert(`ãƒ—ãƒªã‚»ãƒƒãƒˆ "${presetName}" ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
    closeOCRPresetsModal();
  }
  
  // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤
  async function deletePreset(presetName) {
    if (!confirm(`ãƒ—ãƒªã‚»ãƒƒãƒˆ "${presetName}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      return;
    }
    
    try {
      const response = await fetch(`/ingest/ocr/presets/${encodeURIComponent(presetName)}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        showOCRPresetsModal(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
      } else {
        alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('ãƒ—ãƒªã‚»ãƒƒãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«OCRè¨­å®šã‚’å«ã‚ã‚‹
  const originalStartBtn = document.getElementById('start-btn');
  if (originalStartBtn) {
    originalStartBtn.addEventListener('click', function() {
      // OCRè¨­å®šã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¿½åŠ 
      const form = document.getElementById('ingest-form');
      
      // æ—¢å­˜ã®OCRè¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
      const existingOCRSettings = form.querySelector('input[name="ocr_settings"]');
      if (existingOCRSettings) {
        existingOCRSettings.remove();
      }
      
      // OCRè¨­å®šã‚’è¿½åŠ 
      const ocrSettingsInput = document.createElement('input');
      ocrSettingsInput.type = 'hidden';
      ocrSettingsInput.name = 'ocr_settings';
      ocrSettingsInput.value = JSON.stringify(currentEngineSettings);
      form.appendChild(ocrSettingsInput);
    });
  }
}
</script>

{% endblock %}
