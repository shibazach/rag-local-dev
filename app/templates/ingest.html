<!-- app/templates/ingest2.html @作成日時: 2025-07-24 -->
{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', path='css/ingest.css') }}">

<div id="app-container" class="layout-no-preview">
  <!-- 上部設定エリア（設定パネルを最初から配置） -->
  <div id="top-container" class="settings-container">
    <!-- 設定パネル -->
    <div id="settings-panel" class="panel">
      <!-- レイアウト切り替えボタン -->
      <div id="layout-controls">
        <button id="pattern1-btn" class="layout-btn">&lt;&lt;</button>
        <button id="pattern2-btn" class="layout-btn">&gt;&gt;</button>
      </div>
      <div class="panel-content">
        <h1 class="page-title">✏️ データ整形/登録</h1>
        
        <form id="ingest-form">
          <div class="form-section">
            {% include "partials/ingest/ingest_header.html" %}
          </div>
          
          <div class="form-section">
            <label for="refine-prompt">📝 整形プロンプト：</label>
            <select id="refine-prompt" name="refine_prompt_key">
              {% for key in prompt_keys %}
              <option value="{{ key }}">{{ key }}</option>
              {% endfor %}
            </select>
            <button type="button" id="prompt-edit-btn" style="margin-left: 0.5em;">確認</button>
            <span style="margin-left: 1em; color: #666; font-size: 0.9em;">（LLM モデル：{{ llm_model }}）</span>
          </div>

          <div class="form-section">
            <label for="ocr-engine">🔍 OCRエンジン：</label>
            <select id="ocr-engine" name="ocr_engine_id" style="width: 200px;">
              <!-- OCRエンジンは動的に読み込まれます -->
            </select>
            <button type="button" id="ocr-settings-btn" style="margin-left: 0.5em;">設定</button>
            <button type="button" id="ocr-presets-btn" style="margin-left: 0.5em;">プリセット</button>
          </div>
          
          <div class="form-section">
            <label style="min-width: 140px;">📝 埋め込みモデル：</label>
            {% for key, opt in embedding_options.items() %}
            <label style="margin-left:0.5em;">
              <input type="checkbox" name="embed_models" value="{{ key }}" checked>
              {{ loop.index }}. {{ opt.model_name }}
            </label>
            {% endfor %}
          </div>
          
          <div class="form-section">
            <label for="overwrite_existing" style="margin-left: 1.5em;">既存レコード上書き：</label>
            <input id="overwrite_existing" type="checkbox" name="overwrite_existing" value="true">
            <label for="quality_threshold">（質スコア閾値</label>
            <input id="quality_threshold" type="number" name="quality_threshold" min="0" max="1" step="0.05" value="0.0" style="width:4em;">
            <label>以上はSKIP）</label>
          </div>
          
          <div class="form-section">
            <label for="llm_timeout">⏱️ LLMタイムアウト：</label>
            <input id="llm_timeout" type="number" name="llm_timeout" min="0" max="3600" step="10" value="300" style="width:5em; text-align:center;">
            <label>秒（0でタイムアウトなし）</label>
          </div>
          
          <div class="form-actions">
            <button type="button" id="start-btn">🚀 処理開始</button>
            <button type="button" id="cancel-btn" disabled>✖️ キャンセル</button>
            <span style="margin-left:1em;">
              PDF表示：<label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="embed" checked> 同一タブ内</label>
              <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="newtab"> 別タブ</label>
            </span>

          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 上下リサイザー（第1パターンで表示） -->
  <div id="top-resizer" class="resizer horizontal-resizer"></div>

  <!-- 下部コンテナ -->
  <div id="bottom-container">
    <!-- 左側：設定+処理ログ -->
    <div id="left-pane">
      <!-- 左側設定エリア（第2パターン用コンテナ） -->
      <div id="left-container" class="settings-container">
        <!-- 設定パネルがここに移動される -->
      </div>

      <!-- 左右リサイザー（第2パターンで表示） -->
      <div id="left-resizer" class="resizer horizontal-resizer"></div>

      <!-- 処理ログパネル -->
      <div id="log-panel" class="panel">
        <div class="panel-content">
          <div id="log-content"></div>
        </div>
      </div>
    </div>

    <!-- 左右リサイザー -->
    <div id="vertical-resizer" class="resizer vertical-resizer"></div>

    <!-- 右側：PDFパネル -->
    <div id="pdf-panel" class="panel">
      <div class="panel-content" style="padding: 0;">
        <iframe id="pdf-frame" src=""></iframe>
      </div>
    </div>
  </div>
</div>

<!-- OCR設定・プリセットモーダルはJavaScriptで動的生成されます -->

<!-- 処理中のナビゲーション警告 -->
<div id="nav-warning">
  ⚠️ データ処理中です<br>
  他のページへの移動はできません<br>
  <small>キャンセルボタンで処理を中止できます</small>
</div>

<!-- 機能別に分割されたJavaScriptファイル -->
<script src="{{ url_for('static', path='js/ocr_settings_dialog.js') }}"></script>
<script src="{{ url_for('static', path='js/ingest_layout.js') }}"></script>
<script src="{{ url_for('static', path='js/ingest_resize.js') }}"></script>
<script src="{{ url_for('static', path='js/ingest_sse.js') }}"></script>
<script src="{{ url_for('static', path='js/ingest_processing.js') }}"></script>
<script src="{{ url_for('static', path='js/ingest_ocr.js') }}"></script>
<script src="{{ url_for('static', path='js/ingest_main.js') }}"></script>

{% endblock %}