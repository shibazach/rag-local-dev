<!-- app/templates/ingest.html @更新日時: 2025-07-18 17:00 JST -->
{% extends "base.html" %}
{% block content %}

<style>
  /* ペイン上下分割 */
  #ingest-container { display:flex; flex-direction:column; height:calc(100vh - 2em); }

  /* 上ペイン */
  #pane-top {
    flex:0 0 auto;
    padding:1em;
    border-bottom:1px solid rgba(255, 255, 255, 0.4);
    box-sizing:border-box;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(15px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    position: relative;
  }
  
  /* 上ペインの背景オーバーレイ */
  #pane-top::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(248, 249, 250, 0.1) 100%);
    z-index: -1;
  }

  /* 下ペイン：ログと編集ペインを左右並びに */
  #pane-bottom {
    flex:1 1 auto;
    display:flex;
    overflow:hidden;
    position: relative;
  }
  /* 左カラム：ログ */
  #log-pane {
    flex:1 1 auto;
    overflow-y:auto;
    padding:1em;
    background:#fafafa;
    box-sizing:border-box;
  }

  /* REM: ペイン間スプリッター */
  #splitter {
    flex: 0 0 5px;
    cursor: col-resize;
    background: #ccc;
  }

  /* 右カラム：編集エリア */
  #editor-pane {
    flex:0 0 40%;
    display:none;
    border-left:1px solid #ccc;
    box-sizing:border-box;
    overflow:hidden;
  }
  #editor-pane textarea {
    width:100%; height:100%; border:none;
    padding:1em; box-sizing:border-box;
    resize:none; overflow:auto;
  }

  /* フォーム */
  #ingest-form { display:block; width:100%; }
  .form-section {
    display:flex; align-items:center;
    margin-bottom:0.1em; line-height:1.2; width:100%;
  }
  .form-section label {
    min-width: 120px;
    flex-shrink: 0;
  }
  /* REM: 質スコア閾値入力を中央寄せ */
  #quality_threshold { text-align: center; }
  .form-actions { margin-top:1em; }
  .form-actions button { margin-right:1em; }

  /* ログ表示 */
  .file-header   { background:#eef; padding:4px 8px; font-weight:bold; margin-top:1em; }
  .file-progress { font-size:0.9em; color:#555; margin-left:1ch; }
  .page-header   { margin-left:1ch; font-style:italic; }
  .file-section  { margin-left:1em; margin-bottom:1em; }
  .file-section pre { white-space:pre-wrap; word-break:break-word; background:#fff; padding:8px; border:1px solid #ddd; }

  /* 処理中のナビゲーション無効化 */
  body.processing-in-progress nav a {
    pointer-events: none;
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  body.processing-in-progress nav a::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.1);
    z-index: 1;
  }
  
  /* 処理中の警告メッセージ */
  #nav-warning {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 193, 7, 0.95);
    color: #856404;
    padding: 1em 1.5em;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    z-index: 10001;
    font-weight: bold;
    text-align: center;
    border: 2px solid #ffc107;
  }


</style>

<div id="ingest-container">
  <!-- 上ペイン -->
  <div id="pane-top">
    <h1 class="page-title">✏️ データ整形/登録</h1>
    <form id="ingest-form">
      <div class="form-section">
        {% include "partials/ingest/ingest_header.html" %}
      </div>
      <div class="form-section">
        <label for="refine-prompt">📝 整形プロンプト：</label>
        <select id="refine-prompt" name="refine_prompt_key">
          {% for key in prompt_keys %}
            <option value="{{ key }}">{{ key }}</option>
          {% endfor %}
        </select>
        <button type="button" id="prompt-edit-btn" style="margin-left: 0.5em;">確認</button>
        <span style="margin-left: 1em; color: #666; font-size: 0.9em;">（LLM モデル：{{ llm_model }}）</span>
      </div>
      <!-- 省略：埋め込みモデル・上書き・ボタン群 -->
      <div class="form-section">
        <label style="min-width: 140px;">📝 埋め込みモデル：</label>
        {% for key, opt in embedding_options.items() %}
          <label style="margin-left:0.5em;">
            <input type="checkbox" name="embed_models" value="{{ key }}" checked>
            {{ loop.index }}. {{ opt.model_name }}
          </label>
        {% endfor %}
      </div>
      <div class="form-section">
        <label for="overwrite_existing" style="margin-left: 1.5em;">既存レコード上書き：</label>
        <input id="overwrite_existing" type="checkbox" name="overwrite_existing" value="true">
        <label for="quality_threshold">（質スコア閾値</label>
        <input id="quality_threshold" type="number" name="quality_threshold" min="0" max="1" step="0.05" value="0.0" style="width:4em;">
        <label>以上はSKIP）</label>
      </div>
      <div class="form-actions">
        <button type="button" id="start-btn">🚀 処理開始</button>
        <button type="button" id="cancel-btn" disabled>✖️ キャンセル</button>
        <!-- REM: PDF表示モード選択 -->
        <span style="margin-left:1em;">
          PDF表示：<label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="embed" checked> 同一タブ内</label>
          <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="newtab"> 別タブ</label>
        </span>
      </div>
    </form>
  </div>

  <!-- 下ペイン：ログ and 編集 -->
  <div id="pane-bottom">
    <div id="log-pane"></div>

    <!-- REM: ログペインと編集ペインの間に可変スプリッター -->
    <div id="splitter"></div>
    <div id="editor-pane">
      <textarea id="prompt-editor"></textarea>
    </div>
    

  </div>
</div>

<!-- 処理中のナビゲーション警告 -->
<div id="nav-warning">
  ⚠️ データ処理中です<br>
  他のページへの移動はできません<br>
  <small>キャンセルボタンで処理を中止できます</small>
</div>

<!-- REM: スクリプト読み込み（バージョン管理付き） -->
<script src="{{ url_for('static', path='js/ingest.js') }}?v=20250718"></script>
<script src="{{ url_for('static', path='js/ingest_sse.js') }}?v=20250718"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let processingInProgress = false;
  const navWarning = document.getElementById('nav-warning');
  
  // 処理開始時の制御
  function startProcessing() {
    processingInProgress = true;
    document.body.classList.add('processing-in-progress');
    
    // ページ離脱の警告
    window.addEventListener('beforeunload', handleBeforeUnload);
    
    // ナビゲーションリンクのクリックを監視
    document.querySelectorAll('nav a').forEach(link => {
      link.addEventListener('click', handleNavClick);
    });
  }
  
  // 処理終了時の制御
  function endProcessing() {
    processingInProgress = false;
    document.body.classList.remove('processing-in-progress');
    
    // イベントリスナーを削除
    window.removeEventListener('beforeunload', handleBeforeUnload);
    document.querySelectorAll('nav a').forEach(link => {
      link.removeEventListener('click', handleNavClick);
    });
    
    // 警告メッセージを隠す
    navWarning.style.display = 'none';
  }
  
  // ページ離脱時の警告
  function handleBeforeUnload(e) {
    if (processingInProgress) {
      const message = 'データ処理中です。ページを離れると処理が中断されます。';
      e.preventDefault();
      e.returnValue = message;
      return message;
    }
  }
  
  // ナビゲーションリンククリック時の処理
  function handleNavClick(e) {
    if (processingInProgress) {
      e.preventDefault();
      e.stopPropagation();
      
      // 警告メッセージを表示
      navWarning.style.display = 'block';
      
      // 3秒後に自動で隠す
      setTimeout(() => {
        navWarning.style.display = 'none';
      }, 3000);
      
      return false;
    }
  }
  
  // 処理開始ボタンのイベントリスナー（既存のJavaScriptと連携）
  const startBtn = document.getElementById('start-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  
  if (startBtn) {
    startBtn.addEventListener('click', function() {
      // 処理開始の制御を追加
      startProcessing();
    });
  }
  
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function() {
      // キャンセル時の制御を追加
      endProcessing();
    });
  }
  
  // 処理完了時の制御（既存のJavaScriptから呼び出される想定）
  window.onIngestComplete = function() {
    endProcessing();
  };
  
  // 処理エラー時の制御（既存のJavaScriptから呼び出される想定）
  window.ingestProcessError = function() {
    endProcessing();
  };
});
</script>

{% endblock %}
