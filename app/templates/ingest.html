<!-- app/templates/ingest.html @2025-07-11 10:33 JST -->
{% extends "base.html" %}
{% block content %}

<style>
  /* REM: ãƒšã‚¤ãƒ³ä¸Šä¸‹åˆ†å‰² */
  #ingest-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 2em);
  }
  #pane-top {
    flex: 0 0 auto;
    padding-bottom: 1em;
    border-bottom: 1px solid #ddd;
  }
  #pane-bottom {
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 1em 1em 1em 0;
  }

  /* REM: å¸¯ä»˜ããƒ•ã‚¡ã‚¤ãƒ«å */
  .file-header {
    background: #eef;
    padding: 4px 8px;
    font-weight: bold;
    margin-bottom: 0.5em;
  }

  /* REM: ãƒ•ã‚¡ã‚¤ãƒ«é€²æ—è¡¨ç¤º */
  .file-progress {
    font-size: 0.9em;
    color: #555;
    margin-left: 1ch;
    margin-bottom: 0.5em;
  }

  /* REM: ãƒšãƒ¼ã‚¸é–‹å§‹ */
  .page-header {
    margin-left: 1ch;
    font-style: italic;
    margin-bottom: 0.5em;
  }

  /* REM: ã‚¢ã‚¤ãƒ†ãƒ ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ */
  .file-section > div:not(.page-header),
  .file-section > details {
    margin-left: 2ch;
  }

  /* REM: ã‚«ãƒ¼ãƒ‰é¢¨ */
  #pane-bottom details {
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 8px;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #fafafa;
  }
  #pane-bottom details pre {
    white-space: pre-wrap;
    word-break: break-word;
    margin-top: 8px;
  }
</style>

<div id="ingest-container">
  <div id="pane-top">
    <!-- REM: å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <h1 class="page-title">âœï¸ ãƒ‡ãƒ¼ã‚¿æ•´å½¢/ç™»éŒ²</h1>
    <form id="ingest-form">
      <!-- REM: ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ -->
      <div class="form-section">
        {% include "partials/ingest/ingest_header.html" %}
        {% include "partials/ingest/folder_modal.html" %}
      </div><br>

      <!-- REM: æ•´å½¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé¸æŠ -->
      <div class="form-section">
        <label for="refine-prompt">ğŸ“ æ•´å½¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼š</label>
        <select id="refine-prompt" name="refine_prompt_key">
          {% for key in prompt_keys %}
            <option value="{{ key }}">{{ key }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- REM: åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ãƒã‚§ãƒƒã‚¯ -->
      <div class="form-section">
        <label>ğŸ“ åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ï¼š</label>
        {% for key, config in embedding_options.items() %}
          <label>
            <input type="checkbox" name="embed_models" value="{{ key }}" checked>
            {{ loop.index }}. {{ config.model_name }}
          </label>ã€€ã€€
        {% endfor %}
      </div><br>

      <!-- REM: ä¸Šæ›¸ãè¨­å®š -->
      <div class="form-section">
        <label>æ—¢å­˜ä¸Šæ›¸ãï¼ˆoverwriteï¼‰ï¼š<input type="checkbox" name="overwrite_existing" value="true"></label><br>
        <label>è³ªã‚¹ã‚³ã‚¢é–¾å€¤ï¼š<input type="number" name="quality_threshold" min="0" max="1" step="0.05" value="0.0"></label>
      </div><br>

      <!-- REM: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
      <div class="form-actions">
        <button type="button" id="start-btn">ğŸš€ å‡¦ç†é–‹å§‹</button>
        <button type="button" id="cancel-btn" disabled>âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </form>
  </div>

  <!-- REM: ãƒ­ã‚°å‡ºåŠ›é ˜åŸŸ -->
  <div id="pane-bottom"></div>
</div>

<script>
  /* REM: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ */
  const startBtn   = document.getElementById('start-btn');
  const cancelBtn  = document.getElementById('cancel-btn');
  const paneBottom = document.getElementById('pane-bottom');
  let controller, es, fileContainers = {}, fileStartTime = {};

  // REM: å‡¦ç†é–‹å§‹æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
  startBtn.onclick = async () => {
    // REM: ãƒœã‚¿ãƒ³çŠ¶æ…‹åˆ‡æ›¿
    startBtn.disabled = true;
    cancelBtn.disabled = false;
    paneBottom.innerHTML = '';

    // REM: ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­æ­¢ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©
    controller = new AbortController();
    const form = new FormData(document.getElementById('ingest-form'));
    // REM: ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€å«ã‚ã‚‹ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’å¸¸ã«é€ä¿¡
    form.append("include_subdirs", document.getElementById("include-subdirs").checked ? "true" : "false");

    // REM: ingestç™»éŒ²APIå®Ÿè¡Œ
    await fetch('/ingest', { method: 'POST', body: form, signal: controller.signal });

    // REM: SSE æ¥ç¶šé–‹å§‹
    es = new EventSource('/ingest/stream');
    es.onmessage = evt => {
      const d = JSON.parse(evt.data);

      // REM: å…¨å®Œäº†å‡¦ç†
      if (d.done) {
        es.close();
        const doneDiv = document.createElement('div');
        doneDiv.textContent = 'âœ… å…¨å‡¦ç†å®Œäº†';
        paneBottom.insertBefore(doneDiv, paneBottom.firstChild);
        startBtn.disabled = false;
        cancelBtn.disabled = true;
        return;
      }

      // REM: æ–°ãƒ•ã‚¡ã‚¤ãƒ«é–‹å§‹å‡¦ç†
      if (!fileContainers[d.file]) {
        if (paneBottom.firstChild) paneBottom.insertBefore(document.createElement('br'), paneBottom.firstChild);
        fileStartTime[d.file] = Date.now();
        const cont = document.createElement('div'); cont.className = 'file-container';
        const hdr = document.createElement('div'); hdr.className = 'file-header';
        const a = document.createElement('a');
        a.textContent = d.file;
        a.href = `/viewer/${d.file_id}`;
        a.target = '_blank';
        hdr.appendChild(a);
        cont.appendChild(hdr);
        if (d.index && d.total) {
          const prog = document.createElement('div'); prog.className = 'file-progress';
          prog.textContent = `${d.index}/${d.total}ç•ªç›®ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ä¸­â€¦`;
          cont.appendChild(prog);
        }
        const sec = document.createElement('div'); sec.className = 'file-section';
        cont.appendChild(sec);
        paneBottom.insertBefore(cont, paneBottom.firstChild);
        fileContainers[d.file] = sec;
      }
      const section = fileContainers[d.file];

      // REM: ãƒšãƒ¼ã‚¸é–‹å§‹è¡¨ç¤º
      if (d.step.startsWith('Page ')) {
        const ph = document.createElement('div'); ph.className = 'page-header';
        ph.textContent = d.step;
        section.insertBefore(ph, section.firstChild);
        return;
      }

      // REM: ãƒ­ã‚°ç”Ÿæˆï¼ˆdetails or divï¼‰
      const label = d.step + (d.duration ? ` (${d.duration}s)` : '');
      let el;
      if (d.full_text) {
        // REM: æŠ˜ã‚ŠãŸãŸã¿è©³ç´°è¦ç´ ã‚’ç”Ÿæˆ
        el = document.createElement('details');
        const sum = document.createElement('summary');
        sum.textContent = label;
        el.appendChild(sum);
        const pre = document.createElement('pre');
        // REM: ç©ºè¡Œ3é€£ä»¥ä¸Šã‚’2è¡Œã«åœ§ç¸®
        pre.textContent = d.full_text.replace(/\n{3,}/g, '\n\n');
        el.appendChild(pre);
      } else {
        // REM: å˜ç´”ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
        el = document.createElement('div');
        el.textContent = label;
      }
      section.insertBefore(el, section.firstChild);
    };
  };

  // REM: ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
  cancelBtn.onclick = () => {
    controller?.abort();
    es?.close();
    startBtn.disabled = false;
    cancelBtn.disabled = true;
  };
</script>

{% endblock %}
