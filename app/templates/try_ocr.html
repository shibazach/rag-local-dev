<!-- app/templates/try_ocr.html -->
{% extends "base.html" %}

{% block head %}
<!-- PDF.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  // PDF.jsã®è¨­å®š
  if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }
</script>
<style>
  /* ãƒšã‚¤ãƒ³ä¸Šä¸‹åˆ†å‰²ï¼ˆingest/chatã¨åŒæ§˜ï¼‰ */
  #try-ocr-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 2em);
  }

  /* ä¸Šãƒšã‚¤ãƒ³ï¼š2åˆ†å‰² */
  #pane-top {
    flex: 0 0 auto;
    display: flex;
    border-bottom: 1px solid rgba(255, 255, 255, 0.4);
    box-sizing: border-box;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(15px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    position: relative;
  }

  /* ä¸Šãƒšã‚¤ãƒ³ã®èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  #pane-top::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(248, 249, 250, 0.1) 100%);
    z-index: -1;
  }

  /* å·¦ä¸Šãƒšã‚¤ãƒ³ï¼šåŸºæœ¬è¨­å®šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå«ã‚€ï¼‰ */
  #top-left {
    flex: 1 1 auto;
    padding: 1em 1em 1em 1em;
    border-right: 1px solid rgba(255, 255, 255, 0.4);
    position: relative;
    z-index: 1;
  }

  /* å³ä¸Šãƒšã‚¤ãƒ³ï¼šã‚¨ãƒ³ã‚¸ãƒ³èª¿æ•´ */
  #top-right {
    flex: 1 1 auto;
    padding: 1em 1em 1em 1em;
    position: relative;
    z-index: 1;
  }

  /* ä¸‹ãƒšã‚¤ãƒ³ï¼šçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
  #pane-bottom {
    flex: 1 1 auto;
    display: flex;
    overflow: hidden;
  }

  /* å·¦ãƒšã‚¤ãƒ³ï¼šOCRçµæœãƒ†ã‚­ã‚¹ãƒˆ */
  #results-pane {
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 1em;
    background: #fafafa;
    box-sizing: border-box;
  }

  /* ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ */
  #splitter {
    flex: 0 0 5px;
    cursor: col-resize;
    background: #ccc;
  }

  /* å³ãƒšã‚¤ãƒ³ï¼šPDFè¡¨ç¤º */
  #pdf-pane {
    flex: 0 0 40%;
    display: none;
    border-left: 1px solid #ccc;
    box-sizing: border-box;
    overflow: hidden;
  }

  /* ãƒ•ã‚©ãƒ¼ãƒ  */
  .form-section {
    display: flex;
    align-items: center;
    margin-bottom: 0.1em;
    line-height: 1.2;
    width: 100%;
  }

  .form-section label {
    min-width: 120px;
    flex-shrink: 0;
  }

  .form-actions {
    margin-top: 1em;
  }

  .form-actions button {
    margin-right: 1em;
  }

  /* ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
  .parameter-group {
    margin-bottom: 0.3em;
    padding: 0.25em;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #fff;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    line-height: 1.2;
  }

  .parameter-label {
    font-weight: bold;
    margin-right: 0.5em;
    min-width: 80px;
    font-size: 0.85em;
  }

  .parameter-input {
    margin-right: 0.5em;
  }

  .parameter-input[type="number"] {
    width: 60px;
  }

  .parameter-input[type="text"] {
    width: 120px;
  }

  .parameter-input[type="checkbox"] {
    width: auto;
  }

  .parameter-input select {
    width: 150px;
  }

  .parameter-description {
    font-size: 0.7em;
    color: #666;
    flex: 1;
    margin-left: 0.3em;
  }

  /* çµæœè¡¨ç¤º */
  .result-card {
    border: 1px solid #ddd;
    padding: 12px;
    margin: 8px 0;
    border-radius: 4px;
    background: #fff;
  }

  .result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-weight: bold;
  }

  .result-stats {
    font-size: 0.9em;
    color: #666;
  }

  .result-text {
    white-space: pre-wrap;
    background: #f5f5f5;
    padding: 8px;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9em;
  }

  .error-text {
    color: #d32f2f;
    background: #ffebee;
  }

  /* å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  #processing-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
    z-index: 9999;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }

  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 1em;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }
</style>
{% endblock %}

{% block content %}
<div id="try-ocr-container">
  <!-- ä¸Šãƒšã‚¤ãƒ³ï¼š2åˆ†å‰²è¨­å®š -->
  <div id="pane-top">
    <!-- å·¦ä¸Šãƒšã‚¤ãƒ³ï¼šåŸºæœ¬è¨­å®šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå«ã‚€ï¼‰ -->
    <div id="top-left">
      <h1 class="page-title">âš™ï¸ åŸºæœ¬è¨­å®š</h1>
      <div class="form-section">
        <label for="file-input">ãƒ•ã‚¡ã‚¤ãƒ«æŒ‡å®š:</label>
        <input type="text" id="file-input" readonly style="width:240px;" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„">
        <button type="button" id="browse-file" style="margin-left:0.5em;">ğŸ“‚</button>
      </div>
      <input type="file" id="file-picker" style="display:none;" accept=".pdf,.png,.jpg,.jpeg">
      <div id="selected-file-info" style="display:none; margin-top:0.5em; font-size:0.8em; color:#666;"></div>
      <div class="form-section">
        <label for="engine-select">OCRã‚¨ãƒ³ã‚¸ãƒ³:</label>
        <select id="engine-select" style="width:250px;">
          {% for engine in engines %}
          <option value="{{ engine }}">{{ engine }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-section">
        <label for="page-num">ãƒšãƒ¼ã‚¸ç•ªå·:</label>
        <input type="number" id="page-num" value="1" min="0" style="width:4em; ime-mode:disabled;" inputmode="numeric"
          pattern="[0-9]*">
        <span style="margin-left:0.5em; color:#666; font-size:0.8em;">(0ã¯å…¨ãƒšãƒ¼ã‚¸)</span>
      </div>
      <div class="form-section">
        <label>PDFè¡¨ç¤º:</label>
        <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="embed" checked> è¡¨ç¤º</label>
        <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="hide"> éè¡¨ç¤º</label>
      </div>
      <div class="form-actions">
        <button id="process-btn">ğŸš€ OCRå®Ÿè¡Œ</button>
        <label style="margin-left:0.5em;">
          <input type="checkbox" id="use-correction-dict" checked> èª¤å­—ä¿®æ­£
        </label>
        <button id="clear-btn" style="margin-left:1em;">ğŸ—‘ï¸ çµæœã‚¯ãƒªã‚¢</button>
        <button id="compare-all-btn">ğŸ“Š å…¨ã‚¨ãƒ³ã‚¸ãƒ³æ¯”è¼ƒ</button>
      </div>
    </div>

    <!-- å³ä¸Šãƒšã‚¤ãƒ³ï¼šã‚¨ãƒ³ã‚¸ãƒ³èª¿æ•´ -->
    <div id="top-right">
      <h1 class="page-title">ğŸ”§ ã‚¨ãƒ³ã‚¸ãƒ³èª¿æ•´</h1>
      <div id="engine-parameters">
        <p style="color:#888; font-size:0.9em;">OCRã‚¨ãƒ³ã‚¸ãƒ³ã‚’é¸æŠã™ã‚‹ã¨ã€èª¿æ•´é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
      </div>
    </div>
  </div>

  <!-- ä¸‹ãƒšã‚¤ãƒ³ï¼šçµæœã¨PDF -->
  <div id="pane-bottom">
    <div id="results-pane">
      <div id="results-container">
        <p style="color:#888; text-align:center; margin-top:2em;">
          OCRã‚¨ãƒ³ã‚¸ãƒ³ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã€ŒOCRå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
        </p>
      </div>
    </div>

    <!-- ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ -->
    <div id="splitter"></div>

    <!-- PDFè¡¨ç¤ºãƒšã‚¤ãƒ³ -->
    <div id="pdf-pane">
      <iframe id="pdf-viewer" style="width:100%; height:100%; border:none;"></iframe>
    </div>
  </div>
</div>

<!-- å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="processing-overlay">
  <div class="spinner"></div>
  <div id="processing-message">OCRå‡¦ç†ä¸­â€¦</div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const processBtn = document.getElementById("process-btn");
    const clearBtn = document.getElementById("clear-btn");
    const compareAllBtn = document.getElementById("compare-all-btn");
    const engineSelect = document.getElementById("engine-select");
    const fileInput = document.getElementById("file-input");
    const browseFileBtn = document.getElementById("browse-file");
    const filePicker = document.getElementById("file-picker");
    const selectedFileInfo = document.getElementById("selected-file-info");

    let selectedFile = null;
    const pageNumInput = document.getElementById("page-num");
    const resultsContainer = document.getElementById("results-container");
    const pdfPane = document.getElementById("pdf-pane");
    const pdfViewer = document.getElementById("pdf-viewer");
    const processingOverlay = document.getElementById("processing-overlay");
    const splitter = document.getElementById("splitter");
    const engineParametersDiv = document.getElementById("engine-parameters");

    let isResizing = false;
    let currentEngineParameters = {};

    // å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®è¡¨ç¤º/éè¡¨ç¤ºï¼ˆçµŒéæ™‚é–“ä»˜ãï¼‰
    let processingStartTime = null;
    let processingTimerInterval = null;
    
    function showProcessing() {
      processingOverlay.style.display = "flex";
      startProcessingTimer();
    }

    function hideProcessing() {
      processingOverlay.style.display = "none";
      stopProcessingTimer();
    }
    
    function updateProcessingProgress(message) {
      const processingMessage = document.getElementById('processing-message');
      if (processingMessage) {
        if (processingStartTime) {
          const elapsed = Math.floor((Date.now() - processingStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          const timeStr = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;
          processingMessage.textContent = `${message} (${timeStr})`;
        } else {
          processingMessage.textContent = message;
        }
      }
    }
    
    function startProcessingTimer() {
      processingStartTime = Date.now();
      updateProcessingProgress('OCRå‡¦ç†ä¸­â€¦');
      // 1ç§’é–“éš”ã§çµŒéæ™‚é–“ã‚’æ›´æ–°
      processingTimerInterval = setInterval(() => {
        updateProcessingProgress('OCRå‡¦ç†ä¸­â€¦');
      }, 1000);
    }
    
    function stopProcessingTimer() {
      if (processingTimerInterval) {
        clearInterval(processingTimerInterval);
        processingTimerInterval = null;
      }
      processingStartTime = null;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ©Ÿèƒ½
    browseFileBtn.addEventListener("click", () => {
      filePicker.click();
    });

    filePicker.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        fileInput.value = file.name;
        selectedFileInfo.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        selectedFileInfo.style.display = "block";
        updatePdfDisplay();
      }
    });

    // PDFãƒ•ã‚¡ã‚¤ãƒ«ã®BlobURLï¼ˆå†åˆ©ç”¨ã™ã‚‹ãŸã‚ä¿æŒï¼‰
    let currentPdfUrl = null;
    let pdfTotalPages = 0; // PDFã®ç·ãƒšãƒ¼ã‚¸æ•°

    // PDFã®ç·ãƒšãƒ¼ã‚¸æ•°ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆPDF.jsä½¿ç”¨ï¼‰
    async function getPdfPageCount(file) {
      return new Promise((resolve) => {
        try {
          // PDF.jsãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆ
          if (window.pdfjsLib) {
            const reader = new FileReader();
            reader.onload = async function (e) {
              try {
                const typedarray = new Uint8Array(e.target.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                resolve(pdf.numPages);
              } catch (error) {
                console.warn("PDF.jsã§ã®ãƒšãƒ¼ã‚¸æ•°å–å¾—å¤±æ•—:", error);
                resolve(100); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤
              }
            };
            reader.readAsArrayBuffer(file);
          } else {
            // PDF.jsãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ç°¡æ˜“æ¨å®š
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                const data = new Uint8Array(e.target.result);
                const text = new TextDecoder().decode(data);

                // "/Count" ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¢ã—ã¦ãƒšãƒ¼ã‚¸æ•°ã‚’å–å¾—
                const countMatch = text.match(/\/Count\s+(\d+)/);
                if (countMatch) {
                  resolve(parseInt(countMatch[1]));
                } else {
                  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: "/Page" ã®å‡ºç¾å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                  const pageMatches = text.match(/\/Page\s/g);
                  resolve(pageMatches ? Math.min(pageMatches.length, 100) : 50);
                }
              } catch (error) {
                console.warn("PDFãƒšãƒ¼ã‚¸æ•°å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                resolve(50); // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤
              }
            };
            reader.readAsArrayBuffer(file);
          }
        } catch (error) {
          console.warn("PDFãƒšãƒ¼ã‚¸æ•°å–å¾—å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
          resolve(50); // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤
        }
      });
    }

    // PDFè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
    async function updatePdfDisplay() {
      const pdfMode = document.querySelector('input[name="pdf_mode"]:checked').value;

      if (pdfMode === "embed" && selectedFile) {
        pdfPane.style.display = "block";

        // æ—¢å­˜ã®BlobURLãŒã‚ã‚Œã°è§£æ”¾
        if (currentPdfUrl) {
          URL.revokeObjectURL(currentPdfUrl);
        }

        // æ–°ã—ã„BlobURLã‚’ç”Ÿæˆã—ã¦ä¿æŒ
        currentPdfUrl = URL.createObjectURL(selectedFile);

        // PDFã®ç·ãƒšãƒ¼ã‚¸æ•°ã‚’å–å¾—
        try {
          console.log("PDFãƒšãƒ¼ã‚¸æ•°å–å¾—é–‹å§‹...");
          pdfTotalPages = await getPdfPageCount(selectedFile);
          console.log(`PDFç·ãƒšãƒ¼ã‚¸æ•°å–å¾—å®Œäº†: ${pdfTotalPages}ãƒšãƒ¼ã‚¸`);

          // ãƒšãƒ¼ã‚¸ç•ªå·å…¥åŠ›æ¬„ã®æœ€å¤§å€¤ã‚’è¨­å®š
          pageNumInput.setAttribute('max', pdfTotalPages);
          console.log(`ãƒšãƒ¼ã‚¸ç•ªå·å…¥åŠ›æ¬„ã®æœ€å¤§å€¤ã‚’${pdfTotalPages}ã«è¨­å®š`);

          // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ç•ªå·ãŒæœ€å¤§å€¤ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯ä¿®æ­£
          const currentPageNum = parseInt(pageNumInput.value) || 1;
          if (currentPageNum > pdfTotalPages) {
            pageNumInput.value = pdfTotalPages;
            console.log(`ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ç•ªå·${currentPageNum}ã‚’æœ€å¤§å€¤${pdfTotalPages}ã«ä¿®æ­£`);
          }

        } catch (error) {
          console.warn("PDFãƒšãƒ¼ã‚¸æ•°å–å¾—å¤±æ•—:", error);
          pdfTotalPages = 50; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤
          console.log(`ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤${pdfTotalPages}ã‚’ä½¿ç”¨`);
        }

        // åˆæœŸè¡¨ç¤ºï¼ˆç¾åœ¨ã®ãƒšãƒ¼ã‚¸ç•ªå·ã§ï¼‰
        updatePdfPage();
      } else {
        pdfPane.style.display = "none";
      }
    }

    // ãƒšãƒ¼ã‚¸ç•ªå·ã®æ¤œè¨¼ã¨ä¿®æ­£
    function validateAndCorrectPageNumber() {
      let pageNum = parseInt(pageNumInput.value) || 1;

      // ãƒšãƒ¼ã‚¸ç•ªå·ãŒæœ€å¤§å€¤ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯æœ€å¤§å€¤ã«ä¿®æ­£
      if (pdfTotalPages > 0 && pageNum > pdfTotalPages) {
        pageNum = pdfTotalPages;
        pageNumInput.value = pageNum;
        console.log(`ãƒšãƒ¼ã‚¸ç•ªå·ã‚’æœ€å¤§å€¤ ${pdfTotalPages} ã«ä¿®æ­£ã—ã¾ã—ãŸ`);
      }

      // ãƒšãƒ¼ã‚¸ç•ªå·ãŒ0æœªæº€ã®å ´åˆã¯1ã«ä¿®æ­£
      if (pageNum < 0) {
        pageNum = 1;
        pageNumInput.value = pageNum;
        console.log(`ãƒšãƒ¼ã‚¸ç•ªå·ã‚’æœ€å°å€¤ 1 ã«ä¿®æ­£ã—ã¾ã—ãŸ`);
      }

      return pageNum;
    }

    // PDFãƒšãƒ¼ã‚¸ã®æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸ç•ªå·æ¤œè¨¼ä»˜ãï¼‰
    function updatePdfPage() {
      if (selectedFile && pdfPane.style.display !== "none") {
        // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’æ¤œè¨¼ãƒ»ä¿®æ­£
        const pageNum = validateAndCorrectPageNumber();
        const displayPage = pageNum === 0 ? 1 : pageNum;

        try {
          // æ¯å›æ–°ã—ã„BlobURLã‚’ç”Ÿæˆï¼ˆEdgeãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
          if (currentPdfUrl) {
            URL.revokeObjectURL(currentPdfUrl);
          }

          currentPdfUrl = URL.createObjectURL(selectedFile);

          // ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆè­˜åˆ¥å­ã‚’ä½¿ç”¨ã—ã¦ãƒšãƒ¼ã‚¸æŒ‡å®šï¼ˆå·¦å´ãƒšã‚¤ãƒ³éè¡¨ç¤ºï¼‰
          const targetUrl = `${currentPdfUrl}#page=${displayPage}&pagemode=none&navpanes=0`;
          pdfViewer.src = targetUrl;

          console.log(`PDFãƒšãƒ¼ã‚¸æ›´æ–°: ${displayPage}ãƒšãƒ¼ã‚¸ç›® (ç·ãƒšãƒ¼ã‚¸æ•°: ${pdfTotalPages}) - ${targetUrl}`);

        } catch (error) {
          console.error("PDFãƒšãƒ¼ã‚¸æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
        }
      }
    }

    // OCRã‚¨ãƒ³ã‚¸ãƒ³é¸æŠæ™‚ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
    engineSelect.addEventListener("change", loadEngineParameters);

    // PDFè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã«PDFè¡¨ç¤ºã‚’æ›´æ–°
    document.querySelectorAll('input[name="pdf_mode"]').forEach(radio => {
      radio.addEventListener("change", updatePdfDisplay);
    });

    // ãƒšãƒ¼ã‚¸ç•ªå·å¤‰æ›´æ™‚ã«PDFãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ï¼ˆè¤‡æ•°ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ç¢ºå®Ÿã«ï¼‰
    pageNumInput.addEventListener("change", function () {
      updatePdfPage();
    });

    pageNumInput.addEventListener("blur", function () {
      updatePdfPage();
    });

    // ãƒšãƒ¼ã‚¸ç•ªå·å…¥åŠ›æ¬„ã®IMEåˆ¶å¾¡ã¨åŠè§’å…¥åŠ›å¼·åˆ¶

    // 1. å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆæœŸè¨­å®š
    pageNumInput.setAttribute("inputmode", "numeric");
    pageNumInput.setAttribute("autocomplete", "off");

    // 2. ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®å‡¦ç†
    pageNumInput.addEventListener("focus", function () {
      this.select();
      this.style.imeMode = "disabled";
    });

    // 3. IMEå…¥åŠ›é–‹å§‹æ™‚ã«ä¸­æ–­ã™ã‚‹
    pageNumInput.addEventListener("compositionstart", function (e) {
      e.preventDefault();
      this.blur();
      setTimeout(() => {
        this.focus();
        this.select();
      }, 1);
      return false;
    });

    // 4. å…¥åŠ›å†…å®¹ã®ç›£è¦–ã¨ä¿®æ­£ï¼ˆæ•°å­—ä»¥å¤–ã‚’å³æ™‚å‰Šé™¤ï¼‰+ ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³å¯¾å¿œ
    let inputTimer = null;
    pageNumInput.addEventListener("input", function () {
      const value = this.value;
      const numericValue = value.replace(/[^0-9]/g, '');
      if (value !== numericValue) {
        this.value = numericValue;
      }

      // ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒšãƒ¼ã‚¸ç§»å‹•ï¼ˆé…å»¶å®Ÿè¡Œï¼‰
      clearTimeout(inputTimer);
      inputTimer = setTimeout(() => {
        updatePdfPage();
      }, 300);
    });

    // 5. ã‚­ãƒ¼å…¥åŠ›æ™‚ã®åˆ¶å¾¡ï¼ˆEnterã‚­ãƒ¼å‡¦ç†ã‚‚å«ã‚€ï¼‰
    pageNumInput.addEventListener("keydown", function (e) {
      // Enterã‚­ãƒ¼ã®å ´åˆã¯ãƒšãƒ¼ã‚¸ç§»å‹•ã‚’å®Ÿè¡Œ
      if (e.key === "Enter") {
        console.log("Enterã‚­ãƒ¼æŠ¼ä¸‹:", pageNumInput.value);
        updatePdfPage();
        return;
      }

      // è¨±å¯ã™ã‚‹ã‚­ãƒ¼: æ•°å­—ã‚­ãƒ¼ã€çŸ¢å°ã‚­ãƒ¼ã€ãƒãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã€ãƒ‡ãƒªãƒ¼ãƒˆã€ã‚¿ãƒ–
      const allowedKeys = [8, 9, 37, 38, 39, 40, 46];
      const isNumericKey = (e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 105);

      if (!isNumericKey && !allowedKeys.includes(e.keyCode)) {
        e.preventDefault();
        return false;
      }
    });

    // 6. ãƒšãƒ¼ã‚¹ãƒˆï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰æ™‚ã«ã‚‚æ•°å­—ä»¥å¤–ã‚’é˜²æ­¢
    pageNumInput.addEventListener("paste", function (e) {
      e.preventDefault();

      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰å–å¾—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’æ•°å­—ã®ã¿ã«åˆ¶é™
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      const numericText = pastedText.replace(/[^0-9]/g, '');

      // ç¾åœ¨ã®é¸æŠç¯„å›²ã‚’å–å¾—
      const start = this.selectionStart;
      const end = this.selectionEnd;

      // ç¾åœ¨ã®å€¤ã‚’å–å¾—
      const currentValue = this.value;

      // é¸æŠç¯„å›²ã‚’æ•°å­—ã®ã¿ã®ãƒ†ã‚­ã‚¹ãƒˆã§ç½®æ›
      this.value = currentValue.substring(0, start) + numericText + currentValue.substring(end);

      // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°
      this.selectionStart = this.selectionEnd = start + numericText.length;
    });

    // OCRã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    async function loadEngineParameters() {
      const engineName = engineSelect.value;
      if (!engineName) {
        engineParametersDiv.innerHTML = '<p style="color:#888; font-size:0.9em;">OCRã‚¨ãƒ³ã‚¸ãƒ³ã‚’é¸æŠã™ã‚‹ã¨ã€èª¿æ•´é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
        return;
      }

      try {
        const response = await fetch(`/api/try_ocr/engine_parameters/${encodeURIComponent(engineName)}`);
        const data = await response.json();

        if (data.parameters && data.parameters.length > 0) {
          renderEngineParameters(data.parameters);
        } else {
          engineParametersDiv.innerHTML = '<p style="color:#888; font-size:0.9em;">ã“ã®ã‚¨ãƒ³ã‚¸ãƒ³ã«ã¯èª¿æ•´é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        }
      } catch (error) {
        engineParametersDiv.innerHTML = '<p style="color:#d32f2f; font-size:0.9em;">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
        console.error('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¨ãƒ³ã‚¸ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®UIç”Ÿæˆ
    function renderEngineParameters(parameters) {
      engineParametersDiv.innerHTML = '';
      currentEngineParameters = {};

      parameters.forEach(param => {
        const group = document.createElement('div');
        group.className = 'parameter-group';

        const label = document.createElement('label');
        label.className = 'parameter-label';
        label.textContent = param.label;

        let input;
        const inputId = `param-${param.name}`;

        switch (param.type) {
          case 'checkbox':
            input = document.createElement('input');
            input.type = 'checkbox';
            input.checked = param.default;
            input.className = 'parameter-input';
            currentEngineParameters[param.name] = param.default;
            input.addEventListener('change', () => {
              currentEngineParameters[param.name] = input.checked;
            });
            break;

          case 'number':
            input = document.createElement('input');
            input.type = 'number';
            input.value = param.default;
            input.min = param.min || '';
            input.max = param.max || '';
            input.step = param.step || '';
            input.className = 'parameter-input';
            currentEngineParameters[param.name] = param.default;
            input.addEventListener('change', () => {
              currentEngineParameters[param.name] = parseFloat(input.value) || param.default;
            });
            break;

          case 'text':
            input = document.createElement('input');
            input.type = 'text';
            input.value = param.default || '';
            input.className = 'parameter-input';
            currentEngineParameters[param.name] = param.default || '';
            input.addEventListener('change', () => {
              currentEngineParameters[param.name] = input.value;
            });
            break;

          case 'select':
            input = document.createElement('select');
            input.className = 'parameter-input';
            param.options.forEach(option => {
              const opt = document.createElement('option');
              opt.value = option.value;
              opt.textContent = option.label;
              if (option.value === param.default) {
                opt.selected = true;
              }
              input.appendChild(opt);
            });
            currentEngineParameters[param.name] = param.default;
            input.addEventListener('change', () => {
              currentEngineParameters[param.name] = input.value;
            });
            break;

          default:
            input = document.createElement('span');
            input.textContent = 'æœªå¯¾å¿œã®å…¥åŠ›ã‚¿ã‚¤ãƒ—';
        }

        input.id = inputId;
        label.setAttribute('for', inputId);

        const description = document.createElement('div');
        description.className = 'parameter-description';
        description.textContent = param.description;

        group.appendChild(label);
        group.appendChild(input);
        group.appendChild(description);
        engineParametersDiv.appendChild(group);
      });
    }

    // OCRå®Ÿè¡Œ
    processBtn.addEventListener("click", async () => {
      const engineName = engineSelect.value;
      const pageNumInput_value = parseInt(pageNumInput.value) || 1;
      // äººé–“ç”¨ã®1ã‹ã‚‰å§‹ã¾ã‚‹ç•ªå·ã‚’ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ç”¨ã®0ã‹ã‚‰å§‹ã¾ã‚‹ç•ªå·ã«å¤‰æ›
      const pageNum = pageNumInput_value === 0 ? -1 : pageNumInput_value - 1;
      // èª¤å­—ä¿®æ­£è¾æ›¸ã®ä½¿ç”¨æœ‰ç„¡
      const useCorrection = document.getElementById("use-correction-dict").checked;

      if (!selectedFile) {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }

      showProcessing();

      try {
        const formData = new FormData();
        formData.append("file", selectedFile);
        formData.append("engine_name", engineName);
        formData.append("page_num", pageNum);
        formData.append("use_correction", useCorrection);

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚é€ä¿¡
        for (const [key, value] of Object.entries(currentEngineParameters)) {
          formData.append(`param_${key}`, value);
        }

        const response = await fetch("/api/try_ocr/process_file", {
          method: "POST",
          body: formData
        });

        const result = await response.json();
        displayResult(result);

      } catch (error) {
        displayError("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + error.message);
      } finally {
        hideProcessing();
      }
    });

    // å…¨ã‚¨ãƒ³ã‚¸ãƒ³æ¯”è¼ƒ
    compareAllBtn.addEventListener("click", async () => {
      const pageNumInput_value = parseInt(pageNumInput.value) || 1;
      // äººé–“ç”¨ã®1ã‹ã‚‰å§‹ã¾ã‚‹ç•ªå·ã‚’ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ç”¨ã®0ã‹ã‚‰å§‹ã¾ã‚‹ç•ªå·ã«å¤‰æ›
      const pageNum = pageNumInput_value === 0 ? -1 : pageNumInput_value - 1;
      // èª¤å­—ä¿®æ­£è¾æ›¸ã®ä½¿ç”¨æœ‰ç„¡
      const useCorrection = document.getElementById("use-correction-dict").checked;

      if (!selectedFile) {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }

      showProcessing();
      resultsContainer.innerHTML = "";

      try {
        // å…¨ã‚¨ãƒ³ã‚¸ãƒ³ã§é †æ¬¡å‡¦ç†
        const engines = Array.from(engineSelect.options).map(opt => opt.value);

        for (const engineName of engines) {
          const formData = new FormData();
          formData.append("file", selectedFile);
          formData.append("engine_name", engineName);
          formData.append("page_num", pageNum);
          formData.append("use_correction", useCorrection);

          // ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚é€ä¿¡
          for (const [key, value] of Object.entries(currentEngineParameters)) {
            formData.append(`param_${key}`, value);
          }

          try {
            const response = await fetch("/api/try_ocr/process_file", {
              method: "POST",
              body: formData
            });
            const result = await response.json();
            displayResult(result);
          } catch (error) {
            displayError(`${engineName}: ${error.message}`);
          }
        }

      } finally {
        hideProcessing();
      }
    });

    // çµæœã‚¯ãƒªã‚¢
    clearBtn.addEventListener("click", () => {
      resultsContainer.innerHTML = '<p style="color:#888; text-align:center; margin-top:2em;">çµæœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</p>';
    });

    // çµæœè¡¨ç¤º
    function displayResult(result) {
      const card = document.createElement("div");
      card.className = "result-card";

      const header = document.createElement("div");
      header.className = "result-header";

      // èª¤å­—ä¿®æ­£æƒ…å ±ã‚’è¡¨ç¤ºã«è¿½åŠ 
      let correctionInfo = '';
      if (result.success && result.corrections && result.corrections.length > 0) {
        correctionInfo = ` | èª¤å­—ä¿®æ­£: ${result.corrections.length}ç®‡æ‰€`;
      }

      // ãƒšãƒ¼ã‚¸ç•ªå·ã®è¡¨ç¤ºã‚’è¿½åŠ ï¼ˆ0ã¯å…¨ãƒšãƒ¼ã‚¸ã€-1ã¯å…¨ãƒšãƒ¼ã‚¸å‡¦ç†ä¸­ï¼‰
      const pageDisplay = result.page_num === -1 ? 'ï¼ˆå…¨ãƒšãƒ¼ã‚¸ï¼‰' :
        result.page_num === 0 ? 'ï¼ˆ1ãƒšãƒ¼ã‚¸ç›®ï¼‰' :
          `ï¼ˆ${result.page_num + 1}ãƒšãƒ¼ã‚¸ç›®ï¼‰`;

      header.innerHTML = `
      <span>${result.engine_name} ${pageDisplay}</span>
      <span class="result-stats">
        ${result.success ? 'âœ…' : 'âŒ'} 
        ${result.processing_time}ç§’
        ${result.confidence ? ` | ä¿¡é ¼åº¦: ${(result.confidence * 100).toFixed(1)}%` : ''}
        ${correctionInfo}
      </span>
    `;

      const textDiv = document.createElement("div");
      textDiv.className = `result-text ${result.success ? '' : 'error-text'}`;

      // èª¤å­—ä¿®æ­£ã•ã‚ŒãŸHTMLãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°é€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆ
      if (result.success && result.html_text) {
        textDiv.innerHTML = result.html_text;
      } else {
        textDiv.textContent = result.success ? result.text : result.error;
      }

      card.appendChild(header);
      card.appendChild(textDiv);

      // æœ€åˆã®çµæœã®å ´åˆã¯æ—¢å­˜å†…å®¹ã‚’ã‚¯ãƒªã‚¢
      if (resultsContainer.children.length === 1 &&
        resultsContainer.children[0].tagName === 'P') {
        resultsContainer.innerHTML = "";
      }

      // æœ€æ–°çµæœã‚’ä¸Šå´ã«æŒ¿å…¥
      resultsContainer.insertBefore(card, resultsContainer.firstChild);
    }

    function displayError(message) {
      displayResult({
        engine_name: "ã‚¨ãƒ©ãƒ¼",
        success: false,
        error: message,
        processing_time: 0
      });
    }

    // ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼æ©Ÿèƒ½
    splitter.addEventListener("mousedown", (e) => {
      isResizing = true;
      document.addEventListener("mousemove", handleMouseMove);
      document.addEventListener("mouseup", handleMouseUp);
    });

    function handleMouseMove(e) {
      if (!isResizing) return;
      const containerWidth = document.getElementById("pane-bottom").offsetWidth;
      const newRightWidth = containerWidth - e.clientX;
      const minWidth = 200;
      const maxWidth = containerWidth - 300;

      if (newRightWidth >= minWidth && newRightWidth <= maxWidth) {
        pdfPane.style.flex = `0 0 ${newRightWidth}px`;
      }
    }

    function handleMouseUp() {
      isResizing = false;
      document.removeEventListener("mousemove", handleMouseMove);
      document.removeEventListener("mouseup", handleMouseUp);
    }

    // åˆæœŸåŒ–æ™‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éš ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
    hideProcessing();
    loadEngineParameters();
  });
</script>
{% endblock %}