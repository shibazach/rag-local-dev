<!-- app/templates/try_ocr.html -->
{% extends "base.html" %}

{% block head %}
<style>
  /* ãƒšã‚¤ãƒ³ä¸Šä¸‹åˆ†å‰²ï¼ˆingest/chatã¨åŒæ§˜ï¼‰ */
  #try-ocr-container { display:flex; flex-direction:column; height:calc(100vh - 2em); }

  /* ä¸Šãƒšã‚¤ãƒ³ï¼š2åˆ†å‰² */
  #pane-top {
    flex:0 0 auto;
    display:flex;
    border-bottom:1px solid #ddd;
    box-sizing:border-box;
  }
  
  /* å·¦ä¸Šãƒšã‚¤ãƒ³ï¼šåŸºæœ¬è¨­å®šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå«ã‚€ï¼‰ */
  #top-left {
    flex:1 1 auto;
    padding:1em 1em 1em 1em;
    border-right:1px solid #ddd;
  }
  
  /* å³ä¸Šãƒšã‚¤ãƒ³ï¼šã‚¨ãƒ³ã‚¸ãƒ³èª¿æ•´ */
  #top-right {
    flex:1 1 auto;
    padding:1em 1em 1em 1em;
    background:#f9f9f9;
  }

  /* ä¸‹ãƒšã‚¤ãƒ³ï¼šçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
  #pane-bottom {
    flex:1 1 auto;
    display:flex;
    overflow:hidden;
  }

  /* å·¦ãƒšã‚¤ãƒ³ï¼šOCRçµæœãƒ†ã‚­ã‚¹ãƒˆ */
  #results-pane {
    flex:1 1 auto;
    overflow-y:auto;
    padding:1em;
    background:#fafafa;
    box-sizing:border-box;
  }

  /* ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ */
  #splitter {
    flex: 0 0 5px;
    cursor: col-resize;
    background: #ccc;
  }

  /* å³ãƒšã‚¤ãƒ³ï¼šPDFè¡¨ç¤º */
  #pdf-pane {
    flex:0 0 40%;
    display:none;
    border-left:1px solid #ccc;
    box-sizing:border-box;
    overflow:hidden;
  }

  /* ãƒ•ã‚©ãƒ¼ãƒ  */
  .form-section {
    display:flex; align-items:center;
    margin-bottom:0.1em; line-height:1.2; width:100%;
  }
  .form-section label {
    min-width: 120px;
    flex-shrink: 0;
  }
  .form-actions { margin-top:1em; }
  .form-actions button { margin-right:1em; }

  /* ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
  .parameter-group {
    margin-bottom: 0.3em;
    padding: 0.25em;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #fff;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    line-height: 1.2;
  }
  .parameter-label {
    font-weight: bold;
    margin-right: 0.5em;
    min-width: 80px;
    font-size: 0.85em;
  }
  .parameter-input {
    margin-right: 0.5em;
  }
  .parameter-input[type="number"] {
    width: 60px;
  }
  .parameter-input[type="text"] {
    width: 120px;
  }
  .parameter-input[type="checkbox"] {
    width: auto;
  }
  .parameter-input select {
    width: 150px;
  }
  .parameter-description {
    font-size: 0.7em;
    color: #666;
    flex: 1;
    margin-left: 0.3em;
  }

  /* çµæœè¡¨ç¤º */
  .result-card {
    border: 1px solid #ddd;
    padding: 12px;
    margin: 8px 0;
    border-radius: 4px;
    background: #fff;
  }
  .result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-weight: bold;
  }
  .result-stats {
    font-size: 0.9em;
    color: #666;
  }
  .result-text {
    white-space: pre-wrap;
    background: #f5f5f5;
    padding: 8px;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9em;
  }
  .error-text {
    color: #d32f2f;
    background: #ffebee;
  }

  /* å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  #processing-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
    z-index: 9999;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 1em;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block content %}
<div id="try-ocr-container">
  <!-- ä¸Šãƒšã‚¤ãƒ³ï¼š2åˆ†å‰²è¨­å®š -->
  <div id="pane-top">
    <!-- å·¦ä¸Šãƒšã‚¤ãƒ³ï¼šåŸºæœ¬è¨­å®šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå«ã‚€ï¼‰ -->
    <div id="top-left">
      <h1 class="page-title">âš™ï¸ åŸºæœ¬è¨­å®š</h1>
      <div class="form-section">
        <label for="file-input">ãƒ•ã‚¡ã‚¤ãƒ«æŒ‡å®š:</label>
        <input type="text" id="file-input" readonly style="width:240px;" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„">
        <button type="button" id="browse-file" style="margin-left:0.5em;">ğŸ“‚ å‚ç…§</button>
      </div>
      <input type="file" id="file-picker" style="display:none;" accept=".pdf,.png,.jpg,.jpeg">
      <div id="selected-file-info" style="display:none; margin-top:0.5em; font-size:0.8em; color:#666;"></div>
      <div class="form-section">
        <label for="engine-select">OCRã‚¨ãƒ³ã‚¸ãƒ³:</label>
        <select id="engine-select" style="width:250px;">
          {% for engine in engines %}
            <option value="{{ engine }}">{{ engine }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-section">
        <label for="page-num">ãƒšãƒ¼ã‚¸ç•ªå·:</label>
        <input type="number" id="page-num" value="1" min="0" style="width:4em;">
        <span style="margin-left:0.5em; color:#666; font-size:0.8em;">(0ã¯å…¨ãƒšãƒ¼ã‚¸)</span>
      </div>
      <div class="form-section">
        <label>PDFè¡¨ç¤º:</label>
        <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="embed" checked> è¡¨ç¤º</label>
        <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="hide"> éè¡¨ç¤º</label>
      </div>
      <div class="form-actions">
        <button id="process-btn">ğŸš€ OCRå®Ÿè¡Œ</button>
        <button id="clear-btn">ğŸ—‘ï¸ çµæœã‚¯ãƒªã‚¢</button>
        <button id="compare-all-btn">ğŸ“Š å…¨ã‚¨ãƒ³ã‚¸ãƒ³æ¯”è¼ƒ</button>
      </div>
    </div>

    <!-- å³ä¸Šãƒšã‚¤ãƒ³ï¼šã‚¨ãƒ³ã‚¸ãƒ³èª¿æ•´ -->
    <div id="top-right">
      <h1 class="page-title">ğŸ”§ ã‚¨ãƒ³ã‚¸ãƒ³èª¿æ•´</h1>
      <div id="engine-parameters">
        <p style="color:#888; font-size:0.9em;">OCRã‚¨ãƒ³ã‚¸ãƒ³ã‚’é¸æŠã™ã‚‹ã¨ã€èª¿æ•´é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
      </div>
    </div>
  </div>

  <!-- ä¸‹ãƒšã‚¤ãƒ³ï¼šçµæœã¨PDF -->
  <div id="pane-bottom">
    <div id="results-pane">
      <div id="results-container">
        <p style="color:#888; text-align:center; margin-top:2em;">
          OCRã‚¨ãƒ³ã‚¸ãƒ³ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã€ŒOCRå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
        </p>
      </div>
    </div>

    <!-- ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ -->
    <div id="splitter"></div>
    
    <!-- PDFè¡¨ç¤ºãƒšã‚¤ãƒ³ -->
    <div id="pdf-pane">
      <iframe id="pdf-viewer" style="width:100%; height:100%; border:none;"></iframe>
    </div>
  </div>
</div>

<!-- å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="processing-overlay">
  <div class="spinner"></div>
  <div id="processing-message">OCRå‡¦ç†ä¸­â€¦ãŠå¾…ã¡ãã ã•ã„</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const processBtn = document.getElementById("process-btn");
  const clearBtn = document.getElementById("clear-btn");
  const compareAllBtn = document.getElementById("compare-all-btn");
  const engineSelect = document.getElementById("engine-select");
  const fileInput = document.getElementById("file-input");
  const browseFileBtn = document.getElementById("browse-file");
  const filePicker = document.getElementById("file-picker");
  const selectedFileInfo = document.getElementById("selected-file-info");
  
  let selectedFile = null;
  const pageNumInput = document.getElementById("page-num");
  const resultsContainer = document.getElementById("results-container");
  const pdfPane = document.getElementById("pdf-pane");
  const pdfViewer = document.getElementById("pdf-viewer");
  const processingOverlay = document.getElementById("processing-overlay");
  const splitter = document.getElementById("splitter");
  const engineParametersDiv = document.getElementById("engine-parameters");
  
  let isResizing = false;
  let currentEngineParameters = {};

  // å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®è¡¨ç¤º/éè¡¨ç¤º
  function showProcessing() {
    processingOverlay.style.display = "flex";
  }
  
  function hideProcessing() {
    processingOverlay.style.display = "none";
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ©Ÿèƒ½
  browseFileBtn.addEventListener("click", () => {
    filePicker.click();
  });

  filePicker.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      selectedFile = file;
      fileInput.value = file.name;
      selectedFileInfo.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
      selectedFileInfo.style.display = "block";
      updatePdfDisplay();
    }
  });

  // PDFè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
  function updatePdfDisplay() {
    const pdfMode = document.querySelector('input[name="pdf_mode"]:checked').value;
    
    if (pdfMode === "embed" && selectedFile) {
      pdfPane.style.display = "block";
      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      const fileURL = URL.createObjectURL(selectedFile);
      pdfViewer.src = fileURL;
    } else {
      pdfPane.style.display = "none";
    }
  }

  // PDFãƒšãƒ¼ã‚¸ã®æ›´æ–°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ï¼‰
  function updatePdfPage() {
    if (selectedFile && pdfPane.style.display !== "none") {
      const pageNum = parseInt(pageNumInput.value) || 1;
      const fileURL = URL.createObjectURL(selectedFile);
      // ãƒšãƒ¼ã‚¸æŒ‡å®šã¯PDFãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã®æ©Ÿèƒ½ã«ä¾å­˜
      const displayPage = pageNum === 0 ? 1 : pageNum;
      pdfViewer.src = `${fileURL}#page=${displayPage}`;
    }
  }

  // OCRã‚¨ãƒ³ã‚¸ãƒ³é¸æŠæ™‚ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
  engineSelect.addEventListener("change", loadEngineParameters);

  // PDFè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã«PDFè¡¨ç¤ºã‚’æ›´æ–°
  document.querySelectorAll('input[name="pdf_mode"]').forEach(radio => {
    radio.addEventListener("change", updatePdfDisplay);
  });

  // ãƒšãƒ¼ã‚¸ç•ªå·å¤‰æ›´æ™‚ã«PDFãƒšãƒ¼ã‚¸ã‚’æ›´æ–°
  pageNumInput.addEventListener("change", updatePdfPage);
  pageNumInput.addEventListener("input", updatePdfPage);

  // OCRã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  async function loadEngineParameters() {
    const engineName = engineSelect.value;
    if (!engineName) {
      engineParametersDiv.innerHTML = '<p style="color:#888; font-size:0.9em;">OCRã‚¨ãƒ³ã‚¸ãƒ³ã‚’é¸æŠã™ã‚‹ã¨ã€èª¿æ•´é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
      return;
    }

    try {
      const response = await fetch(`/api/try_ocr/engine_parameters/${encodeURIComponent(engineName)}`);
      const data = await response.json();
      
      if (data.parameters && data.parameters.length > 0) {
        renderEngineParameters(data.parameters);
      } else {
        engineParametersDiv.innerHTML = '<p style="color:#888; font-size:0.9em;">ã“ã®ã‚¨ãƒ³ã‚¸ãƒ³ã«ã¯èª¿æ•´é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</p>';
      }
    } catch (error) {
      engineParametersDiv.innerHTML = '<p style="color:#d32f2f; font-size:0.9em;">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
      console.error('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ã‚¨ãƒ³ã‚¸ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®UIç”Ÿæˆ
  function renderEngineParameters(parameters) {
    engineParametersDiv.innerHTML = '';
    currentEngineParameters = {};

    parameters.forEach(param => {
      const group = document.createElement('div');
      group.className = 'parameter-group';

      const label = document.createElement('label');
      label.className = 'parameter-label';
      label.textContent = param.label;

      let input;
      const inputId = `param-${param.name}`;

      switch (param.type) {
        case 'checkbox':
          input = document.createElement('input');
          input.type = 'checkbox';
          input.checked = param.default;
          input.className = 'parameter-input';
          currentEngineParameters[param.name] = param.default;
          input.addEventListener('change', () => {
            currentEngineParameters[param.name] = input.checked;
          });
          break;

        case 'number':
          input = document.createElement('input');
          input.type = 'number';
          input.value = param.default;
          input.min = param.min || '';
          input.max = param.max || '';
          input.step = param.step || '';
          input.className = 'parameter-input';
          currentEngineParameters[param.name] = param.default;
          input.addEventListener('change', () => {
            currentEngineParameters[param.name] = parseFloat(input.value) || param.default;
          });
          break;

        case 'text':
          input = document.createElement('input');
          input.type = 'text';
          input.value = param.default || '';
          input.className = 'parameter-input';
          currentEngineParameters[param.name] = param.default || '';
          input.addEventListener('change', () => {
            currentEngineParameters[param.name] = input.value;
          });
          break;

        case 'select':
          input = document.createElement('select');
          input.className = 'parameter-input';
          param.options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.value;
            opt.textContent = option.label;
            if (option.value === param.default) {
              opt.selected = true;
            }
            input.appendChild(opt);
          });
          currentEngineParameters[param.name] = param.default;
          input.addEventListener('change', () => {
            currentEngineParameters[param.name] = input.value;
          });
          break;

        default:
          input = document.createElement('span');
          input.textContent = 'æœªå¯¾å¿œã®å…¥åŠ›ã‚¿ã‚¤ãƒ—';
      }

      input.id = inputId;
      label.setAttribute('for', inputId);

      const description = document.createElement('div');
      description.className = 'parameter-description';
      description.textContent = param.description;

      group.appendChild(label);
      group.appendChild(input);
      group.appendChild(description);
      engineParametersDiv.appendChild(group);
    });
  }

  // OCRå®Ÿè¡Œ
  processBtn.addEventListener("click", async () => {
    const engineName = engineSelect.value;
    const pageNumInput_value = parseInt(pageNumInput.value) || 1;
    // äººé–“ç”¨ã®1ã‹ã‚‰å§‹ã¾ã‚‹ç•ªå·ã‚’ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ç”¨ã®0ã‹ã‚‰å§‹ã¾ã‚‹ç•ªå·ã«å¤‰æ›
    const pageNum = pageNumInput_value === 0 ? -1 : pageNumInput_value - 1;

    if (!selectedFile) {
      alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    showProcessing();
    
    try {
      const formData = new FormData();
      formData.append("file", selectedFile);
      formData.append("engine_name", engineName);
      formData.append("page_num", pageNum);
      
      // ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚é€ä¿¡
      for (const [key, value] of Object.entries(currentEngineParameters)) {
        formData.append(`param_${key}`, value);
      }

      const response = await fetch("/api/try_ocr/process_file", {
        method: "POST",
        body: formData
      });

      const result = await response.json();
      displayResult(result);

    } catch (error) {
      displayError("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + error.message);
    } finally {
      hideProcessing();
    }
  });

  // å…¨ã‚¨ãƒ³ã‚¸ãƒ³æ¯”è¼ƒ
  compareAllBtn.addEventListener("click", async () => {
    const pageNumInput_value = parseInt(pageNumInput.value) || 1;
    // äººé–“ç”¨ã®1ã‹ã‚‰å§‹ã¾ã‚‹ç•ªå·ã‚’ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ç”¨ã®0ã‹ã‚‰å§‹ã¾ã‚‹ç•ªå·ã«å¤‰æ›
    const pageNum = pageNumInput_value === 0 ? -1 : pageNumInput_value - 1;

    if (!selectedFile) {
      alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    showProcessing();
    resultsContainer.innerHTML = "";

    try {
      // å…¨ã‚¨ãƒ³ã‚¸ãƒ³ã§é †æ¬¡å‡¦ç†
      const engines = Array.from(engineSelect.options).map(opt => opt.value);
      
      for (const engineName of engines) {
        const formData = new FormData();
        formData.append("file", selectedFile);
        formData.append("engine_name", engineName);
        formData.append("page_num", pageNum);

        try {
          const response = await fetch("/api/try_ocr/process_file", {
            method: "POST",
            body: formData
          });
          const result = await response.json();
          displayResult(result);
        } catch (error) {
          displayError(`${engineName}: ${error.message}`);
        }
      }

    } finally {
      hideProcessing();
    }
  });

  // çµæœã‚¯ãƒªã‚¢
  clearBtn.addEventListener("click", () => {
    resultsContainer.innerHTML = '<p style="color:#888; text-align:center; margin-top:2em;">çµæœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</p>';
  });

  // çµæœè¡¨ç¤º
  function displayResult(result) {
    const card = document.createElement("div");
    card.className = "result-card";

    const header = document.createElement("div");
    header.className = "result-header";
    header.innerHTML = `
      <span>${result.engine_name}</span>
      <span class="result-stats">
        ${result.success ? 'âœ…' : 'âŒ'} 
        ${result.processing_time}ç§’
        ${result.confidence ? ` | ä¿¡é ¼åº¦: ${(result.confidence * 100).toFixed(1)}%` : ''}
      </span>
    `;

    const textDiv = document.createElement("div");
    textDiv.className = `result-text ${result.success ? '' : 'error-text'}`;
    textDiv.textContent = result.success ? result.text : result.error;

    card.appendChild(header);
    card.appendChild(textDiv);
    
    // æœ€åˆã®çµæœã®å ´åˆã¯æ—¢å­˜å†…å®¹ã‚’ã‚¯ãƒªã‚¢
    if (resultsContainer.children.length === 1 && 
        resultsContainer.children[0].tagName === 'P') {
      resultsContainer.innerHTML = "";
    }
    
    // æœ€æ–°çµæœã‚’ä¸Šå´ã«æŒ¿å…¥
    resultsContainer.insertBefore(card, resultsContainer.firstChild);
  }

  function displayError(message) {
    displayResult({
      engine_name: "ã‚¨ãƒ©ãƒ¼",
      success: false,
      error: message,
      processing_time: 0
    });
  }

  // ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼æ©Ÿèƒ½
  splitter.addEventListener("mousedown", (e) => {
    isResizing = true;
    document.addEventListener("mousemove", handleMouseMove);
    document.addEventListener("mouseup", handleMouseUp);
  });

  function handleMouseMove(e) {
    if (!isResizing) return;
    const containerWidth = document.getElementById("pane-bottom").offsetWidth;
    const newRightWidth = containerWidth - e.clientX;
    const minWidth = 200;
    const maxWidth = containerWidth - 300;

    if (newRightWidth >= minWidth && newRightWidth <= maxWidth) {
      pdfPane.style.flex = `0 0 ${newRightWidth}px`;
    }
  }

  function handleMouseUp() {
    isResizing = false;
    document.removeEventListener("mousemove", handleMouseMove);
    document.removeEventListener("mouseup", handleMouseUp);
  }

  // åˆæœŸåŒ–æ™‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éš ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
  hideProcessing();
  loadEngineParameters();
});
</script>
{% endblock %}