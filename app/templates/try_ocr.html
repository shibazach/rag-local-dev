<!-- app/templates/try_ocr.html -->
{% extends "base.html" %}

{% block head %}
<!-- PDF.jsライブラリの読み込み -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  // PDF.jsの設定
  if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }
</script>
<style>
  /* ペイン上下分割（ingest/chatと同様） */
  #try-ocr-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 2em);
  }

  /* 上ペイン：2分割 */
  #pane-top {
    flex: 0 0 auto;
    display: flex;
    border-bottom: 1px solid rgba(255, 255, 255, 0.4);
    box-sizing: border-box;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(15px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    position: relative;
  }

  /* 上ペインの背景オーバーレイ */
  #pane-top::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(248, 249, 250, 0.1) 100%);
    z-index: -1;
  }

  /* 左上ペイン：基本設定（ファイル選択含む） */
  #top-left {
    flex: 1 1 auto;
    padding: 1em 1em 1em 1em;
    border-right: 1px solid rgba(255, 255, 255, 0.4);
    position: relative;
    z-index: 1;
  }

  /* 右上ペイン：エンジン調整 */
  #top-right {
    flex: 1 1 auto;
    padding: 1em 1em 1em 1em;
    position: relative;
    z-index: 1;
  }

  /* 下ペイン：結果表示エリア */
  #pane-bottom {
    flex: 1 1 auto;
    display: flex;
    overflow: hidden;
  }

  /* 左ペイン：OCR結果テキスト */
  #results-pane {
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 1em;
    background: #fafafa;
    box-sizing: border-box;
  }

  /* スプリッター */
  #splitter {
    flex: 0 0 5px;
    cursor: col-resize;
    background: #ccc;
  }

  /* 右ペイン：PDF表示 */
  #pdf-pane {
    flex: 0 0 40%;
    display: none;
    border-left: 1px solid #ccc;
    box-sizing: border-box;
    overflow: hidden;
  }

  /* フォーム */
  .form-section {
    display: flex;
    align-items: center;
    margin-bottom: 0.1em;
    line-height: 1.2;
    width: 100%;
  }

  .form-section label {
    min-width: 120px;
    flex-shrink: 0;
  }

  .form-actions {
    margin-top: 1em;
  }

  .form-actions button {
    margin-right: 1em;
  }

  /* パラメータ調整用スタイル */
  .parameter-group {
    margin-bottom: 0.3em;
    padding: 0.25em;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #fff;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    line-height: 1.2;
  }

  .parameter-label {
    font-weight: bold;
    margin-right: 0.5em;
    min-width: 80px;
    font-size: 0.85em;
  }

  .parameter-input {
    margin-right: 0.5em;
  }

  .parameter-input[type="number"] {
    width: 60px;
  }

  .parameter-input[type="text"] {
    width: 120px;
  }

  .parameter-input[type="checkbox"] {
    width: auto;
  }

  .parameter-input select {
    width: 150px;
  }

  .parameter-description {
    font-size: 0.7em;
    color: #666;
    flex: 1;
    margin-left: 0.3em;
  }

  /* 結果表示 */
  .result-card {
    border: 1px solid #ddd;
    padding: 12px;
    margin: 8px 0;
    border-radius: 4px;
    background: #fff;
  }

  .result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-weight: bold;
  }

  .result-stats {
    font-size: 0.9em;
    color: #666;
  }

  .result-text {
    white-space: pre-wrap;
    background: #f5f5f5;
    padding: 8px;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9em;
  }

  .error-text {
    color: #d32f2f;
    background: #ffebee;
  }

  /* 処理中オーバーレイ */
  #processing-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
    z-index: 9999;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }

  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 1em;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }
</style>
{% endblock %}

{% block content %}
<div id="try-ocr-container">
  <!-- 上ペイン：2分割設定 -->
  <div id="pane-top">
    <!-- 左上ペイン：基本設定（ファイル選択含む） -->
    <div id="top-left">
      <h1 class="page-title">⚙️ 基本設定</h1>
      <div class="form-section">
        <label for="file-input">ファイル指定:</label>
        <input type="text" id="file-input" readonly style="width:240px;" placeholder="ファイルを選択してください">
        <button type="button" id="browse-file" style="margin-left:0.5em;">📂</button>
      </div>
      <input type="file" id="file-picker" style="display:none;" accept=".pdf,.png,.jpg,.jpeg">
      <div id="selected-file-info" style="display:none; margin-top:0.5em; font-size:0.8em; color:#666;"></div>
      <div class="form-section">
        <label for="engine-select">OCRエンジン:</label>
        <select id="engine-select" style="width:250px;">
          {% for engine in engines %}
          <option value="{{ engine }}">{{ engine }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-section">
        <label for="page-num">ページ番号:</label>
        <input type="number" id="page-num" value="1" min="0" style="width:4em; ime-mode:disabled;" inputmode="numeric"
          pattern="[0-9]*">
        <span style="margin-left:0.5em; color:#666; font-size:0.8em;">(0は全ページ)</span>
      </div>
      <div class="form-section">
        <label>PDF表示:</label>
        <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="embed" checked> 表示</label>
        <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="hide"> 非表示</label>
      </div>
      <div class="form-actions">
        <button id="process-btn">🚀 OCR実行</button>
        <label style="margin-left:0.5em;">
          <input type="checkbox" id="use-correction-dict" checked> 誤字修正
        </label>
        <button id="clear-btn" style="margin-left:1em;">🗑️ 結果クリア</button>
        <button id="compare-all-btn">📊 全エンジン比較</button>
      </div>
    </div>

    <!-- 右上ペイン：エンジン調整 -->
    <div id="top-right">
      <h1 class="page-title">🔧 エンジン調整</h1>
      <div id="engine-parameters">
        <p style="color:#888; font-size:0.9em;">OCRエンジンを選択すると、調整項目が表示されます</p>
      </div>
    </div>
  </div>

  <!-- 下ペイン：結果とPDF -->
  <div id="pane-bottom">
    <div id="results-pane">
      <div id="results-container">
        <p style="color:#888; text-align:center; margin-top:2em;">
          OCRエンジンとファイルを選択して「OCR実行」ボタンを押してください
        </p>
      </div>
    </div>

    <!-- スプリッター -->
    <div id="splitter"></div>

    <!-- PDF表示ペイン -->
    <div id="pdf-pane">
      <iframe id="pdf-viewer" style="width:100%; height:100%; border:none;"></iframe>
    </div>
  </div>
</div>

<!-- 処理中オーバーレイ -->
<div id="processing-overlay">
  <div class="spinner"></div>
  <div id="processing-message">OCR処理中…</div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const processBtn = document.getElementById("process-btn");
    const clearBtn = document.getElementById("clear-btn");
    const compareAllBtn = document.getElementById("compare-all-btn");
    const engineSelect = document.getElementById("engine-select");
    const fileInput = document.getElementById("file-input");
    const browseFileBtn = document.getElementById("browse-file");
    const filePicker = document.getElementById("file-picker");
    const selectedFileInfo = document.getElementById("selected-file-info");

    let selectedFile = null;
    const pageNumInput = document.getElementById("page-num");
    const resultsContainer = document.getElementById("results-container");
    const pdfPane = document.getElementById("pdf-pane");
    const pdfViewer = document.getElementById("pdf-viewer");
    const processingOverlay = document.getElementById("processing-overlay");
    const splitter = document.getElementById("splitter");
    const engineParametersDiv = document.getElementById("engine-parameters");

    let isResizing = false;
    let currentEngineParameters = {};

    // 処理中オーバーレイの表示/非表示（経過時間付き）
    let processingStartTime = null;
    let processingTimerInterval = null;
    
    function showProcessing() {
      processingOverlay.style.display = "flex";
      startProcessingTimer();
    }

    function hideProcessing() {
      processingOverlay.style.display = "none";
      stopProcessingTimer();
    }
    
    function updateProcessingProgress(message) {
      const processingMessage = document.getElementById('processing-message');
      if (processingMessage) {
        if (processingStartTime) {
          const elapsed = Math.floor((Date.now() - processingStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          const timeStr = minutes > 0 ? `${minutes}分${seconds}秒` : `${seconds}秒`;
          processingMessage.textContent = `${message} (${timeStr})`;
        } else {
          processingMessage.textContent = message;
        }
      }
    }
    
    function startProcessingTimer() {
      processingStartTime = Date.now();
      updateProcessingProgress('OCR処理中…');
      // 1秒間隔で経過時間を更新
      processingTimerInterval = setInterval(() => {
        updateProcessingProgress('OCR処理中…');
      }, 1000);
    }
    
    function stopProcessingTimer() {
      if (processingTimerInterval) {
        clearInterval(processingTimerInterval);
        processingTimerInterval = null;
      }
      processingStartTime = null;
    }

    // ファイル選択機能
    browseFileBtn.addEventListener("click", () => {
      filePicker.click();
    });

    filePicker.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        fileInput.value = file.name;
        selectedFileInfo.textContent = `ファイル: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        selectedFileInfo.style.display = "block";
        updatePdfDisplay();
      }
    });

    // PDFファイルのBlobURL（再利用するため保持）
    let currentPdfUrl = null;
    let pdfTotalPages = 0; // PDFの総ページ数

    // PDFの総ページ数を取得する関数（PDF.js使用）
    async function getPdfPageCount(file) {
      return new Promise((resolve) => {
        try {
          // PDF.jsが利用可能な場合
          if (window.pdfjsLib) {
            const reader = new FileReader();
            reader.onload = async function (e) {
              try {
                const typedarray = new Uint8Array(e.target.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                resolve(pdf.numPages);
              } catch (error) {
                console.warn("PDF.jsでのページ数取得失敗:", error);
                resolve(100); // フォールバック値
              }
            };
            reader.readAsArrayBuffer(file);
          } else {
            // PDF.jsが利用できない場合の簡易推定
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                const data = new Uint8Array(e.target.result);
                const text = new TextDecoder().decode(data);

                // "/Count" キーワードを探してページ数を取得
                const countMatch = text.match(/\/Count\s+(\d+)/);
                if (countMatch) {
                  resolve(parseInt(countMatch[1]));
                } else {
                  // フォールバック: "/Page" の出現回数をカウント
                  const pageMatches = text.match(/\/Page\s/g);
                  resolve(pageMatches ? Math.min(pageMatches.length, 100) : 50);
                }
              } catch (error) {
                console.warn("PDFページ数取得エラー:", error);
                resolve(50); // エラー時のフォールバック値
              }
            };
            reader.readAsArrayBuffer(file);
          }
        } catch (error) {
          console.warn("PDFページ数取得処理エラー:", error);
          resolve(50); // エラー時のフォールバック値
        }
      });
    }

    // PDF表示の切り替え
    async function updatePdfDisplay() {
      const pdfMode = document.querySelector('input[name="pdf_mode"]:checked').value;

      if (pdfMode === "embed" && selectedFile) {
        pdfPane.style.display = "block";

        // 既存のBlobURLがあれば解放
        if (currentPdfUrl) {
          URL.revokeObjectURL(currentPdfUrl);
        }

        // 新しいBlobURLを生成して保持
        currentPdfUrl = URL.createObjectURL(selectedFile);

        // PDFの総ページ数を取得
        try {
          console.log("PDFページ数取得開始...");
          pdfTotalPages = await getPdfPageCount(selectedFile);
          console.log(`PDF総ページ数取得完了: ${pdfTotalPages}ページ`);

          // ページ番号入力欄の最大値を設定
          pageNumInput.setAttribute('max', pdfTotalPages);
          console.log(`ページ番号入力欄の最大値を${pdfTotalPages}に設定`);

          // 現在のページ番号が最大値を超えている場合は修正
          const currentPageNum = parseInt(pageNumInput.value) || 1;
          if (currentPageNum > pdfTotalPages) {
            pageNumInput.value = pdfTotalPages;
            console.log(`現在のページ番号${currentPageNum}を最大値${pdfTotalPages}に修正`);
          }

        } catch (error) {
          console.warn("PDFページ数取得失敗:", error);
          pdfTotalPages = 50; // フォールバック値
          console.log(`フォールバック値${pdfTotalPages}を使用`);
        }

        // 初期表示（現在のページ番号で）
        updatePdfPage();
      } else {
        pdfPane.style.display = "none";
      }
    }

    // ページ番号の検証と修正
    function validateAndCorrectPageNumber() {
      let pageNum = parseInt(pageNumInput.value) || 1;

      // ページ番号が最大値を超えている場合は最大値に修正
      if (pdfTotalPages > 0 && pageNum > pdfTotalPages) {
        pageNum = pdfTotalPages;
        pageNumInput.value = pageNum;
        console.log(`ページ番号を最大値 ${pdfTotalPages} に修正しました`);
      }

      // ページ番号が0未満の場合は1に修正
      if (pageNum < 0) {
        pageNum = 1;
        pageNumInput.value = pageNum;
        console.log(`ページ番号を最小値 1 に修正しました`);
      }

      return pageNum;
    }

    // PDFページの更新（ページ番号検証付き）
    function updatePdfPage() {
      if (selectedFile && pdfPane.style.display !== "none") {
        // ページ番号を検証・修正
        const pageNum = validateAndCorrectPageNumber();
        const displayPage = pageNum === 0 ? 1 : pageNum;

        try {
          // 毎回新しいBlobURLを生成（Edgeブラウザ対応）
          if (currentPdfUrl) {
            URL.revokeObjectURL(currentPdfUrl);
          }

          currentPdfUrl = URL.createObjectURL(selectedFile);

          // フラグメント識別子を使用してページ指定（左側ペイン非表示）
          const targetUrl = `${currentPdfUrl}#page=${displayPage}&pagemode=none&navpanes=0`;
          pdfViewer.src = targetUrl;

          console.log(`PDFページ更新: ${displayPage}ページ目 (総ページ数: ${pdfTotalPages}) - ${targetUrl}`);

        } catch (error) {
          console.error("PDFページ更新エラー:", error);
        }
      }
    }

    // OCRエンジン選択時にパラメータを表示
    engineSelect.addEventListener("change", loadEngineParameters);

    // PDF表示モード変更時にPDF表示を更新
    document.querySelectorAll('input[name="pdf_mode"]').forEach(radio => {
      radio.addEventListener("change", updatePdfDisplay);
    });

    // ページ番号変更時にPDFページを更新（複数のイベントで確実に）
    pageNumInput.addEventListener("change", function () {
      updatePdfPage();
    });

    pageNumInput.addEventListener("blur", function () {
      updatePdfPage();
    });

    // ページ番号入力欄のIME制御と半角入力強制

    // 1. 入力フィールドの初期設定
    pageNumInput.setAttribute("inputmode", "numeric");
    pageNumInput.setAttribute("autocomplete", "off");

    // 2. フォーカス時の処理
    pageNumInput.addEventListener("focus", function () {
      this.select();
      this.style.imeMode = "disabled";
    });

    // 3. IME入力開始時に中断する
    pageNumInput.addEventListener("compositionstart", function (e) {
      e.preventDefault();
      this.blur();
      setTimeout(() => {
        this.focus();
        this.select();
      }, 1);
      return false;
    });

    // 4. 入力内容の監視と修正（数字以外を即時削除）+ スピンボタン対応
    let inputTimer = null;
    pageNumInput.addEventListener("input", function () {
      const value = this.value;
      const numericValue = value.replace(/[^0-9]/g, '');
      if (value !== numericValue) {
        this.value = numericValue;
      }

      // スピンボタンクリック時のページ移動（遅延実行）
      clearTimeout(inputTimer);
      inputTimer = setTimeout(() => {
        updatePdfPage();
      }, 300);
    });

    // 5. キー入力時の制御（Enterキー処理も含む）
    pageNumInput.addEventListener("keydown", function (e) {
      // Enterキーの場合はページ移動を実行
      if (e.key === "Enter") {
        console.log("Enterキー押下:", pageNumInput.value);
        updatePdfPage();
        return;
      }

      // 許可するキー: 数字キー、矢印キー、バックスペース、デリート、タブ
      const allowedKeys = [8, 9, 37, 38, 39, 40, 46];
      const isNumericKey = (e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 105);

      if (!isNumericKey && !allowedKeys.includes(e.keyCode)) {
        e.preventDefault();
        return false;
      }
    });

    // 6. ペースト（貼り付け）時にも数字以外を防止
    pageNumInput.addEventListener("paste", function (e) {
      e.preventDefault();

      // クリップボードから取得したテキストを数字のみに制限
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      const numericText = pastedText.replace(/[^0-9]/g, '');

      // 現在の選択範囲を取得
      const start = this.selectionStart;
      const end = this.selectionEnd;

      // 現在の値を取得
      const currentValue = this.value;

      // 選択範囲を数字のみのテキストで置換
      this.value = currentValue.substring(0, start) + numericText + currentValue.substring(end);

      // カーソル位置を更新
      this.selectionStart = this.selectionEnd = start + numericText.length;
    });

    // OCRエンジンのパラメータを読み込み
    async function loadEngineParameters() {
      const engineName = engineSelect.value;
      if (!engineName) {
        engineParametersDiv.innerHTML = '<p style="color:#888; font-size:0.9em;">OCRエンジンを選択すると、調整項目が表示されます</p>';
        return;
      }

      try {
        const response = await fetch(`/api/try_ocr/engine_parameters/${encodeURIComponent(engineName)}`);
        const data = await response.json();

        if (data.parameters && data.parameters.length > 0) {
          renderEngineParameters(data.parameters);
        } else {
          engineParametersDiv.innerHTML = '<p style="color:#888; font-size:0.9em;">このエンジンには調整項目がありません</p>';
        }
      } catch (error) {
        engineParametersDiv.innerHTML = '<p style="color:#d32f2f; font-size:0.9em;">パラメータの読み込みに失敗しました</p>';
        console.error('パラメータ読み込みエラー:', error);
      }
    }

    // エンジンパラメータのUI生成
    function renderEngineParameters(parameters) {
      engineParametersDiv.innerHTML = '';
      currentEngineParameters = {};

      parameters.forEach(param => {
        const group = document.createElement('div');
        group.className = 'parameter-group';

        const label = document.createElement('label');
        label.className = 'parameter-label';
        label.textContent = param.label;

        let input;
        const inputId = `param-${param.name}`;

        switch (param.type) {
          case 'checkbox':
            input = document.createElement('input');
            input.type = 'checkbox';
            input.checked = param.default;
            input.className = 'parameter-input';
            currentEngineParameters[param.name] = param.default;
            input.addEventListener('change', () => {
              currentEngineParameters[param.name] = input.checked;
            });
            break;

          case 'number':
            input = document.createElement('input');
            input.type = 'number';
            input.value = param.default;
            input.min = param.min || '';
            input.max = param.max || '';
            input.step = param.step || '';
            input.className = 'parameter-input';
            currentEngineParameters[param.name] = param.default;
            input.addEventListener('change', () => {
              currentEngineParameters[param.name] = parseFloat(input.value) || param.default;
            });
            break;

          case 'text':
            input = document.createElement('input');
            input.type = 'text';
            input.value = param.default || '';
            input.className = 'parameter-input';
            currentEngineParameters[param.name] = param.default || '';
            input.addEventListener('change', () => {
              currentEngineParameters[param.name] = input.value;
            });
            break;

          case 'select':
            input = document.createElement('select');
            input.className = 'parameter-input';
            param.options.forEach(option => {
              const opt = document.createElement('option');
              opt.value = option.value;
              opt.textContent = option.label;
              if (option.value === param.default) {
                opt.selected = true;
              }
              input.appendChild(opt);
            });
            currentEngineParameters[param.name] = param.default;
            input.addEventListener('change', () => {
              currentEngineParameters[param.name] = input.value;
            });
            break;

          default:
            input = document.createElement('span');
            input.textContent = '未対応の入力タイプ';
        }

        input.id = inputId;
        label.setAttribute('for', inputId);

        const description = document.createElement('div');
        description.className = 'parameter-description';
        description.textContent = param.description;

        group.appendChild(label);
        group.appendChild(input);
        group.appendChild(description);
        engineParametersDiv.appendChild(group);
      });
    }

    // OCR実行
    processBtn.addEventListener("click", async () => {
      const engineName = engineSelect.value;
      const pageNumInput_value = parseInt(pageNumInput.value) || 1;
      // 人間用の1から始まる番号を、プログラム用の0から始まる番号に変換
      const pageNum = pageNumInput_value === 0 ? -1 : pageNumInput_value - 1;
      // 誤字修正辞書の使用有無
      const useCorrection = document.getElementById("use-correction-dict").checked;

      if (!selectedFile) {
        alert("ファイルを選択してください");
        return;
      }

      showProcessing();

      try {
        const formData = new FormData();
        formData.append("file", selectedFile);
        formData.append("engine_name", engineName);
        formData.append("page_num", pageNum);
        formData.append("use_correction", useCorrection);

        // カスタムパラメータも送信
        for (const [key, value] of Object.entries(currentEngineParameters)) {
          formData.append(`param_${key}`, value);
        }

        const response = await fetch("/api/try_ocr/process_file", {
          method: "POST",
          body: formData
        });

        const result = await response.json();
        displayResult(result);

      } catch (error) {
        displayError("通信エラー: " + error.message);
      } finally {
        hideProcessing();
      }
    });

    // 全エンジン比較
    compareAllBtn.addEventListener("click", async () => {
      const pageNumInput_value = parseInt(pageNumInput.value) || 1;
      // 人間用の1から始まる番号を、プログラム用の0から始まる番号に変換
      const pageNum = pageNumInput_value === 0 ? -1 : pageNumInput_value - 1;
      // 誤字修正辞書の使用有無
      const useCorrection = document.getElementById("use-correction-dict").checked;

      if (!selectedFile) {
        alert("ファイルを選択してください");
        return;
      }

      showProcessing();
      resultsContainer.innerHTML = "";

      try {
        // 全エンジンで順次処理
        const engines = Array.from(engineSelect.options).map(opt => opt.value);

        for (const engineName of engines) {
          const formData = new FormData();
          formData.append("file", selectedFile);
          formData.append("engine_name", engineName);
          formData.append("page_num", pageNum);
          formData.append("use_correction", useCorrection);

          // カスタムパラメータも送信
          for (const [key, value] of Object.entries(currentEngineParameters)) {
            formData.append(`param_${key}`, value);
          }

          try {
            const response = await fetch("/api/try_ocr/process_file", {
              method: "POST",
              body: formData
            });
            const result = await response.json();
            displayResult(result);
          } catch (error) {
            displayError(`${engineName}: ${error.message}`);
          }
        }

      } finally {
        hideProcessing();
      }
    });

    // 結果クリア
    clearBtn.addEventListener("click", () => {
      resultsContainer.innerHTML = '<p style="color:#888; text-align:center; margin-top:2em;">結果をクリアしました</p>';
    });

    // 結果表示
    function displayResult(result) {
      const card = document.createElement("div");
      card.className = "result-card";

      const header = document.createElement("div");
      header.className = "result-header";

      // 誤字修正情報を表示に追加
      let correctionInfo = '';
      if (result.success && result.corrections && result.corrections.length > 0) {
        correctionInfo = ` | 誤字修正: ${result.corrections.length}箇所`;
      }

      // ページ番号の表示を追加（0は全ページ、-1は全ページ処理中）
      const pageDisplay = result.page_num === -1 ? '（全ページ）' :
        result.page_num === 0 ? '（1ページ目）' :
          `（${result.page_num + 1}ページ目）`;

      header.innerHTML = `
      <span>${result.engine_name} ${pageDisplay}</span>
      <span class="result-stats">
        ${result.success ? '✅' : '❌'} 
        ${result.processing_time}秒
        ${result.confidence ? ` | 信頼度: ${(result.confidence * 100).toFixed(1)}%` : ''}
        ${correctionInfo}
      </span>
    `;

      const textDiv = document.createElement("div");
      textDiv.className = `result-text ${result.success ? '' : 'error-text'}`;

      // 誤字修正されたHTMLがある場合はそれを表示、なければ通常テキスト
      if (result.success && result.html_text) {
        textDiv.innerHTML = result.html_text;
      } else {
        textDiv.textContent = result.success ? result.text : result.error;
      }

      card.appendChild(header);
      card.appendChild(textDiv);

      // 最初の結果の場合は既存内容をクリア
      if (resultsContainer.children.length === 1 &&
        resultsContainer.children[0].tagName === 'P') {
        resultsContainer.innerHTML = "";
      }

      // 最新結果を上側に挿入
      resultsContainer.insertBefore(card, resultsContainer.firstChild);
    }

    function displayError(message) {
      displayResult({
        engine_name: "エラー",
        success: false,
        error: message,
        processing_time: 0
      });
    }

    // スプリッター機能
    splitter.addEventListener("mousedown", (e) => {
      isResizing = true;
      document.addEventListener("mousemove", handleMouseMove);
      document.addEventListener("mouseup", handleMouseUp);
    });

    function handleMouseMove(e) {
      if (!isResizing) return;
      const containerWidth = document.getElementById("pane-bottom").offsetWidth;
      const newRightWidth = containerWidth - e.clientX;
      const minWidth = 200;
      const maxWidth = containerWidth - 300;

      if (newRightWidth >= minWidth && newRightWidth <= maxWidth) {
        pdfPane.style.flex = `0 0 ${newRightWidth}px`;
      }
    }

    function handleMouseUp() {
      isResizing = false;
      document.removeEventListener("mousemove", handleMouseMove);
      document.removeEventListener("mouseup", handleMouseUp);
    }

    // 初期化時にオーバーレイを隠し、デフォルトエンジンのパラメータを表示
    hideProcessing();
    loadEngineParameters();
  });
</script>
{% endblock %}