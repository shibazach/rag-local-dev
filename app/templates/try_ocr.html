<!-- app/templates/try_ocr.html -->
{% extends "base.html" %}

{% block head %}
<style>
  /* ãƒšã‚¤ãƒ³ä¸Šä¸‹åˆ†å‰²ï¼ˆingest/chatã¨åŒæ§˜ï¼‰ */
  #try-ocr-container { display:flex; flex-direction:column; height:calc(100vh - 2em); }

  /* ä¸Šãƒšã‚¤ãƒ³ï¼šOCRé¸æŠãƒ»ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ */
  #pane-top {
    flex:0 0 auto;
    padding:1em;
    border-bottom:1px solid #ddd;
    box-sizing:border-box;
  }

  /* ä¸‹ãƒšã‚¤ãƒ³ï¼šçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
  #pane-bottom {
    flex:1 1 auto;
    display:flex;
    overflow:hidden;
  }

  /* å·¦ãƒšã‚¤ãƒ³ï¼šOCRçµæœãƒ†ã‚­ã‚¹ãƒˆ */
  #results-pane {
    flex:1 1 auto;
    overflow-y:auto;
    padding:1em;
    background:#fafafa;
    box-sizing:border-box;
  }

  /* ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ */
  #splitter {
    flex: 0 0 5px;
    cursor: col-resize;
    background: #ccc;
  }

  /* å³ãƒšã‚¤ãƒ³ï¼šPDFè¡¨ç¤º */
  #pdf-pane {
    flex:0 0 40%;
    display:none;
    border-left:1px solid #ccc;
    box-sizing:border-box;
    overflow:hidden;
  }

  /* ãƒ•ã‚©ãƒ¼ãƒ  */
  .form-section {
    display:flex; align-items:center;
    margin-bottom:0.1em; line-height:1.2; width:100%;
  }
  .form-actions { margin-top:1em; }
  .form-actions button { margin-right:1em; }

  /* çµæœè¡¨ç¤º */
  .result-card {
    border: 1px solid #ddd;
    padding: 12px;
    margin: 8px 0;
    border-radius: 4px;
    background: #fff;
  }
  .result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-weight: bold;
  }
  .result-stats {
    font-size: 0.9em;
    color: #666;
  }
  .result-text {
    white-space: pre-wrap;
    background: #f5f5f5;
    padding: 8px;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9em;
  }
  .error-text {
    color: #d32f2f;
    background: #ffebee;
  }

  /* å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  #processing-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
    z-index: 9999;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 1em;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block content %}
<div id="try-ocr-container">
  <!-- ä¸Šãƒšã‚¤ãƒ³ï¼šè¨­å®š -->
  <div id="pane-top">
    <h1 class="page-title">ğŸ” OCRæ¯”è¼ƒãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="form-section">
      <label for="engine-select">OCRã‚¨ãƒ³ã‚¸ãƒ³:</label>
      <select id="engine-select">
        {% for engine in engines %}
          <option value="{{ engine }}">{{ engine }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-section">
      <label for="file-select">ãƒ•ã‚¡ã‚¤ãƒ«:</label>
      <select id="file-select">
        <option value="">-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ --</option>
        {% for file in files %}
          <option value="{{ file.id }}">{{ file.file_name }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-section">
      <label for="page-num">ãƒšãƒ¼ã‚¸ç•ªå·:</label>
      <input type="number" id="page-num" value="0" min="0" style="width:4em;">
      <span style="margin-left:0.5em; color:#666;">(0ã‹ã‚‰é–‹å§‹)</span>
    </div>
    
    <div class="form-actions">
      <button id="process-btn">ğŸš€ OCRå®Ÿè¡Œ</button>
      <button id="clear-btn">ğŸ—‘ï¸ çµæœã‚¯ãƒªã‚¢</button>
      <button id="compare-all-btn">ğŸ“Š å…¨ã‚¨ãƒ³ã‚¸ãƒ³æ¯”è¼ƒ</button>
      <!-- PDFè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
      <span style="margin-left:1em;">
        <label><input type="radio" name="pdf_mode" value="embed" checked> PDFè¡¨ç¤º</label>
        <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="hide"> PDFéè¡¨ç¤º</label>
      </span>
    </div>
  </div>

  <!-- ä¸‹ãƒšã‚¤ãƒ³ï¼šçµæœã¨PDF -->
  <div id="pane-bottom">
    <div id="results-pane">
      <div id="results-container">
        <p style="color:#888; text-align:center; margin-top:2em;">
          OCRã‚¨ãƒ³ã‚¸ãƒ³ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã€ŒOCRå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
        </p>
      </div>
    </div>

    <!-- ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ -->
    <div id="splitter"></div>
    
    <!-- PDFè¡¨ç¤ºãƒšã‚¤ãƒ³ -->
    <div id="pdf-pane">
      <iframe id="pdf-viewer" style="width:100%; height:100%; border:none;"></iframe>
    </div>
  </div>
</div>

<!-- å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="processing-overlay">
  <div class="spinner"></div>
  <div id="processing-message">OCRå‡¦ç†ä¸­â€¦ãŠå¾…ã¡ãã ã•ã„</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const processBtn = document.getElementById("process-btn");
  const clearBtn = document.getElementById("clear-btn");
  const compareAllBtn = document.getElementById("compare-all-btn");
  const engineSelect = document.getElementById("engine-select");
  const fileSelect = document.getElementById("file-select");
  const pageNumInput = document.getElementById("page-num");
  const resultsContainer = document.getElementById("results-container");
  const pdfPane = document.getElementById("pdf-pane");
  const pdfViewer = document.getElementById("pdf-viewer");
  const processingOverlay = document.getElementById("processing-overlay");
  const splitter = document.getElementById("splitter");
  
  let isResizing = false;

  // å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®è¡¨ç¤º/éè¡¨ç¤º
  function showProcessing() {
    processingOverlay.style.display = "flex";
  }
  
  function hideProcessing() {
    processingOverlay.style.display = "none";
  }

  // PDFè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
  function updatePdfDisplay() {
    const pdfMode = document.querySelector('input[name="pdf_mode"]:checked').value;
    const fileId = fileSelect.value;
    
    if (pdfMode === "embed" && fileId) {
      pdfPane.style.display = "block";
      pdfViewer.src = `/viewer/${fileId}`;
    } else {
      pdfPane.style.display = "none";
    }
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã«PDFè¡¨ç¤ºã‚’æ›´æ–°
  fileSelect.addEventListener("change", updatePdfDisplay);
  document.querySelectorAll('input[name="pdf_mode"]').forEach(radio => {
    radio.addEventListener("change", updatePdfDisplay);
  });

  // OCRå®Ÿè¡Œ
  processBtn.addEventListener("click", async () => {
    const engineName = engineSelect.value;
    const fileId = fileSelect.value;
    const pageNum = parseInt(pageNumInput.value) || 0;

    if (!fileId) {
      alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    showProcessing();
    
    try {
      const formData = new FormData();
      formData.append("file_id", fileId);
      formData.append("engine_name", engineName);
      formData.append("page_num", pageNum);

      const response = await fetch("/api/try_ocr/process", {
        method: "POST",
        body: formData
      });

      const result = await response.json();
      displayResult(result);
      updatePdfDisplay();

    } catch (error) {
      displayError("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + error.message);
    } finally {
      hideProcessing();
    }
  });

  // å…¨ã‚¨ãƒ³ã‚¸ãƒ³æ¯”è¼ƒ
  compareAllBtn.addEventListener("click", async () => {
    const fileId = fileSelect.value;
    const pageNum = parseInt(pageNumInput.value) || 0;

    if (!fileId) {
      alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    showProcessing();
    resultsContainer.innerHTML = "";

    try {
      // å…¨ã‚¨ãƒ³ã‚¸ãƒ³ã§é †æ¬¡å‡¦ç†
      const engines = Array.from(engineSelect.options).map(opt => opt.value);
      
      for (const engineName of engines) {
        const formData = new FormData();
        formData.append("file_id", fileId);
        formData.append("engine_name", engineName);
        formData.append("page_num", pageNum);

        try {
          const response = await fetch("/api/try_ocr/process", {
            method: "POST",
            body: formData
          });
          const result = await response.json();
          displayResult(result);
        } catch (error) {
          displayError(`${engineName}: ${error.message}`);
        }
      }
      
      updatePdfDisplay();

    } finally {
      hideProcessing();
    }
  });

  // çµæœã‚¯ãƒªã‚¢
  clearBtn.addEventListener("click", () => {
    resultsContainer.innerHTML = '<p style="color:#888; text-align:center; margin-top:2em;">çµæœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</p>';
  });

  // çµæœè¡¨ç¤º
  function displayResult(result) {
    const card = document.createElement("div");
    card.className = "result-card";

    const header = document.createElement("div");
    header.className = "result-header";
    header.innerHTML = `
      <span>${result.engine_name}</span>
      <span class="result-stats">
        ${result.success ? 'âœ…' : 'âŒ'} 
        ${result.processing_time}ç§’
        ${result.confidence ? ` | ä¿¡é ¼åº¦: ${(result.confidence * 100).toFixed(1)}%` : ''}
      </span>
    `;

    const textDiv = document.createElement("div");
    textDiv.className = `result-text ${result.success ? '' : 'error-text'}`;
    textDiv.textContent = result.success ? result.text : result.error;

    card.appendChild(header);
    card.appendChild(textDiv);
    
    // æœ€åˆã®çµæœã®å ´åˆã¯æ—¢å­˜å†…å®¹ã‚’ã‚¯ãƒªã‚¢
    if (resultsContainer.children.length === 1 && 
        resultsContainer.children[0].tagName === 'P') {
      resultsContainer.innerHTML = "";
    }
    
    resultsContainer.appendChild(card);
  }

  function displayError(message) {
    displayResult({
      engine_name: "ã‚¨ãƒ©ãƒ¼",
      success: false,
      error: message,
      processing_time: 0
    });
  }

  // ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼æ©Ÿèƒ½
  splitter.addEventListener("mousedown", (e) => {
    isResizing = true;
    document.addEventListener("mousemove", handleMouseMove);
    document.addEventListener("mouseup", handleMouseUp);
  });

  function handleMouseMove(e) {
    if (!isResizing) return;
    const containerWidth = document.getElementById("pane-bottom").offsetWidth;
    const newRightWidth = containerWidth - e.clientX;
    const minWidth = 200;
    const maxWidth = containerWidth - 300;

    if (newRightWidth >= minWidth && newRightWidth <= maxWidth) {
      pdfPane.style.flex = `0 0 ${newRightWidth}px`;
    }
  }

  function handleMouseUp() {
    isResizing = false;
    document.removeEventListener("mousemove", handleMouseMove);
    document.removeEventListener("mouseup", handleMouseUp);
  }

  // åˆæœŸåŒ–æ™‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éš ã™
  hideProcessing();
});
</script>
{% endblock %}