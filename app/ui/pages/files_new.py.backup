"""ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ãƒšãƒ¼ã‚¸ - ui.tableç‰ˆ"""

from nicegui import ui
from ui.components.layout import RAGHeader, RAGFooter, MainContentArea
from ui.components.common import CommonPanel
from ui.components.common.buttons import BaseButton
from app.services.file_service import FileService
import logging

logger = logging.getLogger(__name__)

class FilesPage:
    def __init__(self):
        """ãƒ•ã‚¡ã‚¤ãƒ«ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–"""
        self.file_service = FileService()
        self.file_data = []
        self.original_data = []
        self.status_filter = 'å…¨ã¦'
        self.search_query = ''
        self.render()
    
    def render(self):
        """ãƒšãƒ¼ã‚¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°"""
        RAGHeader(current_page="files")
        
        with MainContentArea():
            self._create_layout()
        
        RAGFooter()
    
    def _create_layout(self):
        """ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä½œæˆ"""
        with ui.element('div').style(
            'display: grid; '
            'grid-template-columns: 1fr 1fr; '
            'grid-template-rows: 1fr; '
            'gap: 16px; '
            'height: 100%; '
            'padding: 16px;'
        ):
            self._create_file_list_pane()
            self._create_pdf_preview_pane()
    
    def _create_file_list_pane(self):
        """ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãƒšã‚¤ãƒ³"""
        with CommonPanel(
            title="ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§",
            gradient="linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
            header_color="#6b7280",
            width="100%",
            height="100%",
            content_style="padding: 0; position: relative;"
        ) as panel:
            # ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°UIè¿½åŠ 
            with panel.header_element:
                with ui.element('div').style(
                    'display: flex; gap: 8px; align-items: center; '
                    'flex: 1; margin-right: 8px;'
                ):
                    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
                    self.status_select = ui.select(
                        options=[
                            'å…¨ã¦',
                            'å‡¦ç†å®Œäº†',
                            'å‡¦ç†ä¸­', 
                            'æœªå‡¦ç†',
                            'æœªæ•´å½¢',
                            'æœªãƒ™ã‚¯ãƒˆãƒ«åŒ–',
                            'ã‚¨ãƒ©ãƒ¼'
                        ],
                        value=self.status_filter,
                        on_change=lambda e: self._apply_filters()
                    ).style('width: 150px; height: 28px; min-height: 28px; flex-shrink: 0;').props('outlined dense')
                    
                    # æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹
                    self.search_input = ui.input(
                        placeholder='ãƒ•ã‚¡ã‚¤ãƒ«åã§æ¤œç´¢...',
                        on_change=lambda e: self._apply_filters()
                    ).style('flex: 1; min-width: 120px; height: 28px; min-height: 28px;').props('outlined dense')
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
            self._load_file_data()
            
            # ãƒ‡ãƒ¼ã‚¿ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«è¿½åŠ 
            with panel.content_element:
                self._setup_data_grid()
    
    def _load_file_data(self):
        """ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰"""
        try:
            result = self.file_service.get_file_list(limit=1000, offset=0)
            if result and 'files' in result:
                self.file_data = []
                for file in result['files']:
                    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
                    if file.get('refined_text'):
                        status = 'å‡¦ç†å®Œäº†'
                    elif file.get('raw_text') and not file.get('refined_text'):
                        status = 'æœªæ•´å½¢'
                    elif not file.get('raw_text') and not file.get('refined_text'):
                        status = 'æœªå‡¦ç†'
                    else:
                        status = 'å‡¦ç†ä¸­'
                    
                    # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                    size = file.get('size', 0)
                    if size < 1024:
                        size_str = f"{size}B"
                    elif size < 1024 * 1024:
                        size_str = f"{size / 1024:.1f}KB"
                    elif size < 1024 * 1024 * 1024:
                        size_str = f"{size / 1024 / 1024:.1f}MB"
                    else:
                        size_str = f"{size / 1024 / 1024 / 1024:.1f}GB"
                    
                    # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ—ã®HTMLï¼ˆå®Ÿéš›ã®ã‚¢ã‚¤ã‚³ãƒ³ã¯ ui.table ã®ã‚¹ãƒ­ãƒƒãƒˆã§å‡¦ç†ï¼‰
                    actions_html = 'actions'
                    
                    self.file_data.append({
                        'file_id': file.get('file_id'),
                        'filename': file.get('filename', 'ä¸æ˜'),
                        'size': size_str,
                        'status': status,
                        'created_at': file.get('created_at', '').split('T')[0] if file.get('created_at') else '',
                        'actions': actions_html,
                        'raw_data': file  # å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
                    })
                
                logger.info(f"ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: {len(self.file_data)}ä»¶")
        except Exception as e:
            logger.error(f"ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {str(e)}")
            ui.notify(f'ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}', type='error')
    
    def _setup_data_grid(self):
        """ãƒ‡ãƒ¼ã‚¿ã‚°ãƒªãƒƒãƒ‰è¨­å®š - ui.tableç‰ˆ"""
        # ãƒ‡ãƒ¼ã‚¿è¨­å®š
        self.original_data = self.file_data.copy()
        
        # å„è¡Œã«é¸æŠçŠ¶æ…‹ã¨IDã‚’è¿½åŠ 
        for idx, row in enumerate(self.file_data):
            row['id'] = idx
            row['selected'] = False
        
        # ã‚«ãƒ©ãƒ å®šç¾©
        columns = [
            {'name': 'select', 'label': '', 'field': 'select', 'sortable': False, 'align': 'center'},
            {'name': 'filename', 'label': 'ãƒ•ã‚¡ã‚¤ãƒ«å', 'field': 'filename', 'sortable': True, 'align': 'left'},
            {'name': 'size', 'label': 'ã‚µã‚¤ã‚º', 'field': 'size', 'sortable': True, 'align': 'right'},
            {'name': 'status', 'label': 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'field': 'status', 'sortable': True, 'align': 'center'},
            {'name': 'created_at', 'label': 'ä½œæˆæ—¥æ™‚', 'field': 'created_at', 'sortable': True, 'align': 'center'},
            {'name': 'actions', 'label': 'æ“ä½œ', 'field': 'actions', 'sortable': False, 'align': 'center'}
        ]
        
        # ui.tableä½œæˆ
        self.file_table = ui.table(
            columns=columns,
            rows=self.file_data,
            row_key='id',
            pagination={'rowsPerPage': 20}
        ).classes('w-full').style('height: 100%;')
        
        # ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®èƒŒæ™¯è‰²ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
        self.file_table.add_slot('header', '''
            <template v-slot:header="props">
                <q-tr :props="props" style="background-color: #e5e7eb;">
                    <q-th v-for="col in props.cols" :key="col.name" :props="props">
                        {{ col.label }}
                    </q-th>
                </q-tr>
            </template>
        ''')
        
        # ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ—ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        self.file_table.add_slot('body-cell-select', '''
            <template v-slot:body-cell-select="props">
                <q-td :props="props">
                    <q-checkbox v-model="props.row.selected" 
                                @input="$parent.$emit('selection-change', props.row)"
                                dense />
                </q-td>
            </template>
        ''')
        
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ—ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆãƒãƒƒã‚¸é¢¨ï¼‰
        self.file_table.add_slot('body-cell-status', '''
            <template v-slot:body-cell-status="props">
                <q-td :props="props">
                    <q-badge :color="props.value === 'å‡¦ç†å®Œäº†' ? 'green' :
                                    props.value === 'å‡¦ç†ä¸­' ? 'blue' :
                                    props.value === 'æœªå‡¦ç†' ? 'grey' :
                                    props.value === 'æœªæ•´å½¢' ? 'orange' :
                                    props.value === 'æœªãƒ™ã‚¯ãƒˆãƒ«åŒ–' ? 'purple' :
                                    props.value === 'ã‚¨ãƒ©ãƒ¼' ? 'red' : 'grey'" 
                             :label="props.value" 
                             style="padding: 4px 8px;" />
                </q-td>
            </template>
        ''')
        
        # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ—ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        self.file_table.add_slot('body-cell-actions', '''
            <template v-slot:body-cell-actions="props">
                <q-td :props="props">
                    <div style="display: flex; gap: 4px; justify-content: center;">
                        <q-btn flat round dense icon="visibility" size="sm"
                               @click="$parent.$emit('preview', props.row)"
                               style="color: #6b7280;">
                            <q-tooltip>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</q-tooltip>
                        </q-btn>
                        <q-btn flat round dense icon="info" size="sm"
                               @click="$parent.$emit('info', props.row)"
                               style="color: #6b7280;">
                            <q-tooltip>è©³ç´°æƒ…å ±</q-tooltip>
                        </q-btn>
                        <q-btn flat round dense icon="delete" size="sm"
                               @click="$parent.$emit('delete', props.row)"
                               style="color: #ef4444;">
                            <q-tooltip>å‰Šé™¤</q-tooltip>
                        </q-btn>
                    </div>
                </q-td>
            </template>
        ''')
        
        # ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®è¨­å®š
        self.file_table.on('selection-change', lambda e: self._handle_selection_change(e.args))
        self.file_table.on('preview', lambda e: self._preview_file(e.args))
        self.file_table.on('info', lambda e: self._show_file_info(e.args))
        self.file_table.on('delete', lambda e: self._delete_file(e.args))
    
    def _create_pdf_preview_pane(self):
        """PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒšã‚¤ãƒ³ï¼ˆchatã®å³ä¸‹ãƒšã‚¤ãƒ³ã¨åŒæ§‹é€ ï¼‰"""
        # ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ã®ç›´æ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤º
        with ui.element('div').style(
            'width: 100%; height: 100%; '
            'background: white; border-radius: 12px; '
            'box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); '
            'border: 1px solid #e5e7eb; '
            'display: flex; flex-direction: column; '
            'overflow: hidden;'
        ):
            # PDFãƒ“ãƒ¥ãƒ¼ã‚¢ã‚¨ãƒªã‚¢
            with ui.element('div').style(
                'height: 100%; background: #f3f4f6; '
                'display: flex; align-items: center; justify-content: center;'
            ):
                with ui.element('div').style('text-align: center; color: #6b7280;'):
                    ui.icon('picture_as_pdf', size='48px').style('margin-bottom: 12px;')
                    ui.label('PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼').style('font-size: 16px; font-weight: 500; margin-bottom: 4px;')
                    ui.label('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º').style('font-size: 12px;')
    
    def _apply_filters(self):
        """ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨"""
        status_filter = self.status_select.value
        search_query = self.search_input.value.lower()
        
        filtered_data = []
        for row in self.original_data:
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
            if status_filter != 'å…¨ã¦' and row['status'] != status_filter:
                continue
            
            # æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
            if search_query and search_query not in row['filename'].lower():
                continue
            
            filtered_data.append(row)
        
        # ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        self.file_table.rows = filtered_data
        self.file_table.update()
    
    def _preview_file(self, row_data):
        """ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"""
        file_id = row_data.get('file_id')
        filename = row_data.get('filename')
        
        if file_id:
            ui.notify(f'{filename} ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­...', type='info')
            # TODO: å®Ÿéš›ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†ã‚’å®Ÿè£…
    
    def _show_file_info(self, row_data):
        """ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°æƒ…å ±è¡¨ç¤º"""
        filename = row_data.get('filename')
        ui.notify(f'{filename} ã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º', type='info')
        # TODO: è©³ç´°æƒ…å ±ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å®Ÿè£…
    
    def _delete_file(self, row_data):
        """ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤"""
        filename = row_data.get('filename')
        ui.notify(f'{filename} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', type='warning')
        # TODO: å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¨å‰Šé™¤å‡¦ç†ã‚’å®Ÿè£…
    
    def _handle_selection_change(self, row_data):
        """é¸æŠçŠ¶æ…‹ã®å¤‰æ›´å‡¦ç†"""
        selected_count = sum(1 for row in self.file_table.rows if row.get('selected'))
        logger.debug(f'é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: {selected_count}')