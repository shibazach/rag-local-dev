<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}R&D RAGã‚·ã‚¹ãƒ†ãƒ {% endblock %}</title>
    
    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/main.css') }}">
    {% block extra_css %}{% endblock %}
    
    <style>
    /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .nav-link.nav-active {
        color: #dc3545 !important;
        font-weight: bold;
        border-bottom: 2px solid #dc3545;
    }
    </style>
    
    <!-- JavaScript -->
    <script src="{{ url_for('static', path='/js/main.js') }}" defer></script>
    {% block extra_js %}{% endblock %}
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <nav class="nav">
            <div class="nav-brand" id="nav-brand">
                <a href="/" class="nav-link">R&D RAGã‚·ã‚¹ãƒ†ãƒ </a>
            </div>
            <div class="nav-menu" id="nav-menu">
                <a href="/" class="nav-link">ãƒ›ãƒ¼ãƒ </a>
                <a href="/chat" class="nav-link">ãƒãƒ£ãƒƒãƒˆ</a>
                <a href="/files" class="nav-link nav-admin-only" style="display: none;">ãƒ•ã‚¡ã‚¤ãƒ«</a>
                <a href="/upload" class="nav-link nav-admin-only" style="display: none;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>
                <a href="/admin" class="nav-link nav-admin-only" style="display: none;">ç®¡ç†</a>
            </div>
            <div class="nav-auth">
                <span id="user-info" class="user-info" style="display: none;">
                    <span class="user-avatar">ğŸ‘¤</span>
                    <span id="username" class="username"></span>
                </span>
                <button id="logout-btn" class="btn btn-sm btn-outline" style="display: none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                <a href="/login" id="login-link" class="nav-link">ãƒ­ã‚°ã‚¤ãƒ³</a>
            </div>
        </nav>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main">
        {% block content %}{% endblock %}
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 R&D RAGã‚·ã‚¹ãƒ†ãƒ . All rights reserved.</p>
        </div>
    </footer>

    <!-- é€šçŸ¥ã‚¨ãƒªã‚¢ -->
    <div id="notifications" class="notifications"></div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p>å‡¦ç†ä¸­...</p>
    </div>

    <script>
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼çŠ¶æ…‹ã®ç¢ºèª
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/user/profile', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('username').textContent = data.data.username;
                    document.getElementById('user-info').style.display = 'inline';
                    document.getElementById('login-link').style.display = 'none';
                    document.getElementById('logout-btn').style.display = 'inline'; // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã«å¿œã˜ã¦ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                    updateNavigationByRole(data.data.role);
                    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã«å¿œã˜ã¦ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
                    setActiveNavigation();
                } else {
                    document.getElementById('user-info').style.display = 'none';
                    document.getElementById('login-link').style.display = 'inline';
                    document.getElementById('logout-btn').style.display = 'none'; // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                    
                    // æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ã™ã¹ã¦ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                    hideAdminNavigation();
                }
            } catch (error) {
                console.error('èªè¨¼çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã«å¿œã˜ã¦ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
        function setActiveNavigation() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-menu .nav-link');  // nav-brandã‚’é™¤å¤–
            
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('nav-active');
                } else {
                    link.classList.remove('nav-active');
                }
            });
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã«å¿œã˜ã¦ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        function updateNavigationByRole(role) {
            const adminNavLinks = document.querySelectorAll('.nav-admin-only');
            
            if (role === 'admin') {
                // adminæ¨©é™ã®å ´åˆã¯ã™ã¹ã¦è¡¨ç¤º
                adminNavLinks.forEach(link => {
                    link.style.display = 'inline';
                });
            } else {
                // useræ¨©é™ã®å ´åˆã¯ç®¡ç†ç³»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º
                hideAdminNavigation();
            }
        }
        
        // ç®¡ç†ç³»ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        function hideAdminNavigation() {
            const adminNavLinks = document.querySelectorAll('.nav-admin-only');
            adminNavLinks.forEach(link => {
                link.style.display = 'none';
            });
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        document.getElementById('logout-btn')?.addEventListener('click', async () => {
            try {
                console.log('[LOGOUT] ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–‹å§‹');
                
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                const logoutBtn = document.getElementById('logout-btn');
                logoutBtn.disabled = true;
                logoutBtn.textContent = 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­...';
                
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('[LOGOUT] ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status, response.ok);
                
                if (response.ok) {
                    console.log('[LOGOUT] ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                    
                    // UIã‚’å³åº§ã«ã‚¯ãƒªã‚¢
                    document.getElementById('user-info').style.display = 'none';
                    document.getElementById('login-link').style.display = 'inline';
                    document.getElementById('logout-btn').style.display = 'none'; // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                    hideAdminNavigation();
                    
                    // å³åº§ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    window.location.replace('/login');
                } else {
                    console.error('[LOGOUT] ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—:', response.status);
                    let errorMessage = 'Unknown error';
                    try {
                        const errorData = await response.json();
                        console.error('[LOGOUT] ã‚¨ãƒ©ãƒ¼è©³ç´°:', errorData);
                        errorMessage = errorData.detail || errorData.message || 'Unknown error';
                    } catch (parseError) {
                        console.error('[LOGOUT] ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—:', parseError);
                    }
                    alert(`ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorMessage}`);
                    
                    // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    logoutBtn.disabled = false;
                    logoutBtn.textContent = 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ';
                }
            } catch (error) {
                console.error('[LOGOUT] ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert(`ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                const logoutBtn = document.getElementById('logout-btn');
                logoutBtn.disabled = false;
                logoutBtn.textContent = 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ';
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
        document.addEventListener('DOMContentLoaded', checkAuthStatus);
    </script>
</body>
</html> 