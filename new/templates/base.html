<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}R&D RAGシステム{% endblock %}</title>
    
    <!-- セキュリティヘッダー -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/main.css') }}">
    {% block extra_css %}{% endblock %}
    
    <style>
    /* アクティブナビゲーションリンクのスタイル */
    .nav-link.nav-active {
        color: #dc3545 !important;
        font-weight: bold;
        border-bottom: 2px solid #dc3545;
    }
    </style>
    
    <!-- JavaScript -->
    <script src="{{ url_for('static', path='/js/main.js') }}" defer></script>
    {% block extra_js %}{% endblock %}
</head>
<body>
    <!-- ヘッダー -->
    <header class="header">
        <nav class="nav">
            <div class="nav-brand" id="nav-brand">
                <a href="/" class="nav-link">R&D RAGシステム</a>
            </div>
            <div class="nav-menu" id="nav-menu">
                <a href="/" class="nav-link">ホーム</a>
                <a href="/chat" class="nav-link">チャット</a>
                <a href="/files" class="nav-link nav-admin-only" style="display: none;">ファイル</a>
                <a href="/upload" class="nav-link nav-admin-only" style="display: none;">アップロード</a>
                <a href="/admin" class="nav-link nav-admin-only" style="display: none;">管理</a>
            </div>
            <div class="nav-auth">
                <span id="user-info" class="user-info" style="display: none;">
                    <span class="user-avatar">👤</span>
                    <span id="username" class="username"></span>
                </span>
                <button id="logout-btn" class="btn btn-sm btn-outline" style="display: none;">ログアウト</button>
                <a href="/login" id="login-link" class="nav-link">ログイン</a>
            </div>
        </nav>
    </header>

    <!-- メインコンテンツ -->
    <main class="main">
        {% block content %}{% endblock %}
    </main>

    <!-- フッター -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 R&D RAGシステム. All rights reserved.</p>
        </div>
    </footer>

    <!-- 通知エリア -->
    <div id="notifications" class="notifications"></div>

    <!-- ローディングオーバーレイ -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p>処理中...</p>
    </div>

    <script>
        // ユーザー認証状態の確認
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/user/profile', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('username').textContent = data.data.username;
                    document.getElementById('user-info').style.display = 'inline';
                    document.getElementById('login-link').style.display = 'none';
                    document.getElementById('logout-btn').style.display = 'inline'; // ログアウトボタンを表示
                    
                    // ユーザー権限に応じてナビゲーションを表示
                    updateNavigationByRole(data.data.role);
                    // 現在のページに応じてナビゲーションをアクティブにする
                    setActiveNavigation();
                } else {
                    document.getElementById('user-info').style.display = 'none';
                    document.getElementById('login-link').style.display = 'inline';
                    document.getElementById('logout-btn').style.display = 'none'; // ログアウトボタンを非表示
                    
                    // 未ログイン時はすべてのナビゲーションを非表示
                    hideAdminNavigation();
                }
            } catch (error) {
                console.error('認証状態確認エラー:', error);
            }
        }
        
        // 現在のページに応じてナビゲーションリンクをアクティブにする
        function setActiveNavigation() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-menu .nav-link');  // nav-brandを除外
            
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('nav-active');
                } else {
                    link.classList.remove('nav-active');
                }
            });
        }
        
        // ユーザー権限に応じてナビゲーションを更新
        function updateNavigationByRole(role) {
            const adminNavLinks = document.querySelectorAll('.nav-admin-only');
            
            if (role === 'admin') {
                // admin権限の場合はすべて表示
                adminNavLinks.forEach(link => {
                    link.style.display = 'inline';
                });
            } else {
                // user権限の場合は管理系メニューを非表示
                hideAdminNavigation();
            }
        }
        
        // 管理系ナビゲーションを非表示
        function hideAdminNavigation() {
            const adminNavLinks = document.querySelectorAll('.nav-admin-only');
            adminNavLinks.forEach(link => {
                link.style.display = 'none';
            });
        }

        // ログアウト処理
        document.getElementById('logout-btn')?.addEventListener('click', async () => {
            try {
                console.log('[LOGOUT] ログアウト開始');
                
                // ログアウトボタンを無効化
                const logoutBtn = document.getElementById('logout-btn');
                logoutBtn.disabled = true;
                logoutBtn.textContent = 'ログアウト中...';
                
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('[LOGOUT] レスポンス:', response.status, response.ok);
                
                if (response.ok) {
                    console.log('[LOGOUT] ログアウト成功、ログインページにリダイレクト');
                    
                    // UIを即座にクリア
                    document.getElementById('user-info').style.display = 'none';
                    document.getElementById('login-link').style.display = 'inline';
                    document.getElementById('logout-btn').style.display = 'none'; // ログアウトボタンを非表示
                    hideAdminNavigation();
                    
                    // 即座にリダイレクト
                    window.location.replace('/login');
                } else {
                    console.error('[LOGOUT] ログアウト失敗:', response.status);
                    let errorMessage = 'Unknown error';
                    try {
                        const errorData = await response.json();
                        console.error('[LOGOUT] エラー詳細:', errorData);
                        errorMessage = errorData.detail || errorData.message || 'Unknown error';
                    } catch (parseError) {
                        console.error('[LOGOUT] エラーレスポンスの解析に失敗:', parseError);
                    }
                    alert(`ログアウトに失敗しました: ${errorMessage}`);
                    
                    // ボタンを元に戻す
                    logoutBtn.disabled = false;
                    logoutBtn.textContent = 'ログアウト';
                }
            } catch (error) {
                console.error('[LOGOUT] ログアウトエラー:', error);
                alert(`ログアウトエラー: ${error.message}`);
                
                // ボタンを元に戻す
                const logoutBtn = document.getElementById('logout-btn');
                logoutBtn.disabled = false;
                logoutBtn.textContent = 'ログアウト';
            }
        });

        // ページ読み込み時に認証状態を確認
        document.addEventListener('DOMContentLoaded', checkAuthStatus);
    </script>
</body>
</html> 