{% extends "base.html" %}

{% block title %}チャット - R&D RAGシステム{% endblock %}

{% block content %}
<div class="container">
    <div class="chat-container">
        <div class="chat-header">
            <h1>チャット</h1>
            <button class="btn btn-primary" onclick="createSession()">新しいセッション</button>
        </div>
        
        <div class="chat-sessions">
            <h2>セッション一覧</h2>
            <div id="sessions-list" class="sessions-grid">
                <!-- セッション一覧がここに表示されます -->
            </div>
        </div>
        
        <div class="chat-messages" id="chat-messages" style="display: none;">
            <div class="messages-header">
                <h2 id="current-session-title">セッション</h2>
                <button class="btn btn-secondary" onclick="backToSessions()">セッション一覧に戻る</button>
            </div>
            
            <div class="messages-container" id="messages-container">
                <!-- メッセージがここに表示されます -->
            </div>
            
            <div class="message-input">
                <div class="input-group">
                    <input type="text" id="message-input" placeholder="メッセージを入力..." class="form-control">
                    <button class="btn btn-primary" onclick="sendMessage()">送信</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentSessionId = null;

// ページ読み込み時の処理
document.addEventListener('DOMContentLoaded', function() {
    loadSessions();
});

// セッション一覧を読み込み
async function loadSessions() {
    try {
        showLoading();
        const response = await fetch('/api/chat/sessions', {
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            }
        });
        
        if (response.ok) {
            const sessions = await response.json();
            displaySessions(sessions);
        } else {
            showNotification('セッションの読み込みに失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error loading sessions:', error);
        showNotification('セッションの読み込みに失敗しました', 'error');
    } finally {
        hideLoading();
    }
}

// セッション一覧を表示
function displaySessions(sessions) {
    const container = document.getElementById('sessions-list');
    
    if (sessions.length === 0) {
        container.innerHTML = '<p class="no-sessions">セッションがありません</p>';
        return;
    }
    
    container.innerHTML = sessions.map(session => `
        <div class="session-card" onclick="openSession('${session.id}')">
            <h3>${session.title || '無題のセッション'}</h3>
            <p>作成日: ${formatDate(session.created_at)}</p>
            <p>メッセージ数: ${session.message_count || 0}</p>
        </div>
    `).join('');
}

// 新しいセッションを作成
async function createSession() {
    try {
        showLoading();
        const response = await fetch('/api/chat/sessions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({
                title: '新しいセッション'
            })
        });
        
        if (response.ok) {
            const session = await response.json();
            openSession(session.id);
        } else {
            showNotification('セッションの作成に失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error creating session:', error);
        showNotification('セッションの作成に失敗しました', 'error');
    } finally {
        hideLoading();
    }
}

// セッションを開く
async function openSession(sessionId) {
    currentSessionId = sessionId;
    
    try {
        showLoading();
        const response = await fetch(`/api/chat/sessions/${sessionId}`, {
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            }
        });
        
        if (response.ok) {
            const session = await response.json();
            document.getElementById('current-session-title').textContent = session.title || '無題のセッション';
            loadMessages(sessionId);
            document.getElementById('chat-messages').style.display = 'block';
            document.querySelector('.chat-sessions').style.display = 'none';
        } else {
            showNotification('セッションの読み込みに失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error opening session:', error);
        showNotification('セッションの読み込みに失敗しました', 'error');
    } finally {
        hideLoading();
    }
}

// メッセージを読み込み
async function loadMessages(sessionId) {
    try {
        const response = await fetch(`/api/chat/sessions/${sessionId}/messages`, {
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            }
        });
        
        if (response.ok) {
            const messages = await response.json();
            displayMessages(messages);
        } else {
            showNotification('メッセージの読み込みに失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error loading messages:', error);
        showNotification('メッセージの読み込みに失敗しました', 'error');
    }
}

// メッセージを表示
function displayMessages(messages) {
    const container = document.getElementById('messages-container');
    
    container.innerHTML = messages.map(message => `
        <div class="message ${message.role === 'user' ? 'user-message' : 'assistant-message'}">
            <div class="message-content">
                <p>${message.content}</p>
                <small>${formatDate(message.created_at)}</small>
            </div>
        </div>
    `).join('');
    
    // 最新のメッセージまでスクロール
    container.scrollTop = container.scrollHeight;
}

// メッセージを送信
async function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message || !currentSessionId) return;
    
    try {
        showLoading();
        
        // ユーザーメッセージを表示
        const messagesContainer = document.getElementById('messages-container');
        const userMessageHtml = `
            <div class="message user-message">
                <div class="message-content">
                    <p>${message}</p>
                    <small>${formatDate(new Date())}</small>
                </div>
            </div>
        `;
        messagesContainer.insertAdjacentHTML('beforeend', userMessageHtml);
        
        // 入力フィールドをクリア
        input.value = '';
        
        // 最新のメッセージまでスクロール
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // サーバーにメッセージを送信
        const response = await fetch(`/api/chat/sessions/${currentSessionId}/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({
                content: message
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // アシスタントの応答を表示
            const assistantMessageHtml = `
                <div class="message assistant-message">
                    <div class="message-content">
                        <p>${result.assistant_response}</p>
                        <small>${formatDate(new Date())}</small>
                    </div>
                </div>
            `;
            messagesContainer.insertAdjacentHTML('beforeend', assistantMessageHtml);
            
            // 最新のメッセージまでスクロール
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } else {
            showNotification('メッセージの送信に失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        showNotification('メッセージの送信に失敗しました', 'error');
    } finally {
        hideLoading();
    }
}

// セッション一覧に戻る
function backToSessions() {
    currentSessionId = null;
    document.getElementById('chat-messages').style.display = 'none';
    document.querySelector('.chat-sessions').style.display = 'block';
    loadSessions();
}

// Enterキーでメッセージ送信
document.getElementById('message-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});
</script>

<style>
.chat-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.chat-sessions {
    margin-bottom: 30px;
}

.sessions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.session-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.session-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.session-card h3 {
    margin: 0 0 10px 0;
    color: #333;
}

.session-card p {
    margin: 5px 0;
    color: #666;
    font-size: 14px;
}

.no-sessions {
    text-align: center;
    color: #666;
    font-style: italic;
}

.chat-messages {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.messages-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.messages-header h2 {
    margin: 0;
    color: #333;
}

.messages-container {
    height: 400px;
    overflow-y: auto;
    padding: 20px;
}

.message {
    margin-bottom: 20px;
    display: flex;
}

.user-message {
    justify-content: flex-end;
}

.assistant-message {
    justify-content: flex-start;
}

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 12px;
    position: relative;
}

.user-message .message-content {
    background: #007bff;
    color: white;
    border-bottom-right-radius: 4px;
}

.assistant-message .message-content {
    background: #f1f3f4;
    color: #333;
    border-bottom-left-radius: 4px;
}

.message-content p {
    margin: 0 0 5px 0;
    line-height: 1.4;
}

.message-content small {
    font-size: 12px;
    opacity: 0.7;
}

.message-input {
    padding: 20px;
    border-top: 1px solid #e0e0e0;
    background: #f8f9fa;
}

.input-group {
    display: flex;
    gap: 10px;
}

.input-group .form-control {
    flex: 1;
}

@media (max-width: 768px) {
    .chat-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .sessions-grid {
        grid-template-columns: 1fr;
    }
    
    .messages-container {
        height: 300px;
    }
    
    .message-content {
        max-width: 85%;
    }
}
</style>
{% endblock %} 