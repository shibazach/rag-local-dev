<!-- new/templates/chat.html -->
{% extends "base_new.html" %}

{% block extra_css %}
<!-- ãƒãƒ£ãƒƒãƒˆå°‚ç”¨CSS -->
<link rel="stylesheet" href="{{ url_for('static', path='css/common.css') }}">
<link rel="stylesheet" href="{{ url_for('static', path='css/chat.css') }}">
{% endblock %}

{% block content %}
<div id="app-container" class="layout-no-preview">
  <!-- ä¸Šéƒ¨è¨­å®šã‚¨ãƒªã‚¢ï¼ˆè¨­å®šãƒ‘ãƒãƒ«ã‚’æœ€åˆã‹ã‚‰é…ç½®ï¼‰ -->
  <div id="top-container" class="settings-container">
    <!-- è¨­å®šãƒ‘ãƒãƒ« -->
    <div id="settings-panel" class="panel">
      <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
      <div id="layout-controls">
        <button id="pattern1-btn" class="layout-btn">â–½</button>
        <button id="pattern2-btn" class="layout-btn">â–³</button>
      </div>
      <div class="panel-header">
        <h3>âš™ï¸ æ¤œç´¢è¨­å®š</h3>
      </div>
      <div class="panel-content">
        <div class="form-section">
          <textarea id="query" class="chat-query-textarea" rows="4" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"></textarea>
        </div>
        
        <div class="form-section">
          <label for="mode" style="min-width: 120px;">æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ï¼š</label>
          <select id="mode" class="form-control compact-select">
            <option value="ãƒãƒ£ãƒ³ã‚¯çµ±åˆ">ãƒãƒ£ãƒ³ã‚¯çµ±åˆ</option>
            <option value="ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ï¼ˆè¦ç´„+ä¸€è‡´åº¦ï¼‰" selected>ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ï¼ˆè¦ç´„+ä¸€è‡´åº¦ï¼‰</option>
          </select>
          <label for="model_key" style="margin-left:1em;">åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ï¼š</label>
          <select id="model_key" class="form-control compact-select">
            {% for key, config in embedding_options.items() %}
            <option value="{{ key }}">{{ config["model_name"] }} ({{ config["embedder"] }})</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="form-section">
          <label for="search_limit" style="min-width: 120px;">æ¤œç´¢ä»¶æ•°ï¼š</label>
          <input type="number" id="search_limit" class="form-control compact-input" min="1" max="50" value="10" style="width:4em;">
          <span style="margin-left:0.5em; color:#666; font-size:0.9em;">ä»¶</span>

          <label for="min_score" style="margin-left:1em;">æœ€å°ä¸€è‡´åº¦ï¼š</label>
          <input type="number" id="min_score" class="form-control compact-input" min="0" max="1" step="0.1" value="0.0" style="width:4em;">
          <span style="margin-left:0.5em; color:#666; font-size:0.9em;">ä»¥ä¸Š</span>
        </div>
        
        <div class="form-section">
          <label for="search_timeout">â±ï¸ æ¤œç´¢ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼š</label>
          <input id="search_timeout" class="form-control compact-input" type="number" min="0" max="3600" step="5" value="10" style="width:5em; text-align:center;">
          <label>ç§’ï¼ˆ0ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãªã—ï¼‰</label>
        </div>
        
        <div class="form-actions">
          <button id="search-btn" class="btn btn-primary">ğŸ” æ¤œç´¢å®Ÿè¡Œ</button>
          <button id="history-btn" class="btn">ğŸ“œ å±¥æ­´</button>
          <span id="loading" style="display: none; color: #555; margin-left: 8px;">æ¤œç´¢ä¸­â€¦ãŠå¾…ã¡ãã ã•ã„</span>
          
          <span style="margin-left:1em;">
            PDFè¡¨ç¤ºï¼š<label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="embed" checked> åŒä¸€ã‚¿ãƒ–å†…</label>
            <label style="margin-left:0.5em;"><input type="radio" name="pdf_mode" value="newtab"> åˆ¥ã‚¿ãƒ–</label>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸Šä¸‹ãƒªã‚µã‚¤ã‚¶ãƒ¼ï¼ˆç¬¬1ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¡¨ç¤ºï¼‰ -->
  <div id="top-resizer" class="resizer horizontal-resizer"></div>

  <!-- ä¸‹éƒ¨ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div id="bottom-container">
    <!-- å·¦å´ï¼šè¨­å®š+æ¤œç´¢çµæœ -->
    <div id="left-pane">
      <!-- å·¦å´è¨­å®šã‚¨ãƒªã‚¢ï¼ˆç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ç”¨ã‚³ãƒ³ãƒ†ãƒŠï¼‰ -->
      <div id="left-container" class="settings-container">
        <!-- è¨­å®šãƒ‘ãƒãƒ«ãŒã“ã“ã«ç§»å‹•ã•ã‚Œã‚‹ -->
      </div>

      <!-- å·¦å³ãƒªã‚µã‚¤ã‚¶ãƒ¼ï¼ˆç¬¬2ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¡¨ç¤ºï¼‰ -->
      <div id="left-resizer" class="resizer horizontal-resizer"></div>

      <!-- æ¤œç´¢çµæœãƒ‘ãƒãƒ« -->
      <div id="log-panel" class="panel">
        <div class="panel-header">
          <h3>ğŸ“‹ æ¤œç´¢çµæœ</h3>
        </div>
        <div class="panel-content">
          <div id="log-content">
            <div id="answer" style="display: none; margin: 12px 0; padding: 8px 12px; border: 1px solid #888; border-radius: 4px; background: #eef;">
              <h2 style="margin: 0 0 8px; font-size: 1.2em;">çµ±åˆå›ç­”</h2>
              <pre style="margin: 0; white-space: pre-wrap;"></pre>
            </div>
            <div id="results">
              <p style="color:#888; text-align:center; margin-top:2em;">
                è³ªå•ã‚’å…¥åŠ›ã—ã¦ã€Œæ¤œç´¢å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
              </p>
            </div>
            <!-- è©³ç´°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="detail-content" style="display: none; margin-top: 1em; padding: 1em; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å·¦å³ãƒªã‚µã‚¤ã‚¶ãƒ¼ -->
    <div id="vertical-resizer" class="resizer vertical-resizer"></div>

    <!-- å³å´ï¼šPDFãƒ‘ãƒãƒ« -->
    <div id="pdf-panel" class="panel">
      <div class="panel-content" style="padding: 0;">
        <iframe id="pdf-frame" src=""></iframe>
      </div>
    </div>
  </div>
</div>

<!-- æ¤œç´¢ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="search-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); color: #fff; z-index: 10000; font-size: 1.4em; display: flex; align-items: center; justify-content: center; flex-direction: column;">
  <div class="search-spinner"></div>
  <div id="search-message">æ¤œç´¢ä¸­â€¦</div>
  <div id="search-details" style="font-size: 0.8em; margin-top: 0.5em; color: #ccc;"></div>
  <button id="search-cancel-overlay-btn" style="margin-top: 1em; padding: 0.5em 1em; font-size: 1em; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; transition: all 0.2s;">âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<!-- å†ãƒ™ã‚¯ãƒˆãƒ«åŒ–å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="processing-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); color: #fff; z-index: 10000; font-size: 1.4em; display: flex; align-items: center; justify-content: center; flex-direction: column;">
  <div id="overlay-message">å†ãƒ™ã‚¯ãƒˆãƒ«åŒ–ä¸­â€¦<br>é–‰ã˜ãªã„ã§ãã ã•ã„</div>
  <button id="overlay-ok-btn" style="display: none; margin-top: 1em; padding: 0.5em 1em; font-size: 1em;">OK</button>
</div>

<!-- å‡¦ç†ä¸­ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è­¦å‘Š -->
<div id="nav-warning" style="display: none;">
  âš ï¸ æ¤œç´¢å‡¦ç†ä¸­ã§ã™<br>
  ä»–ã®ãƒšãƒ¼ã‚¸ã¸ã®ç§»å‹•ã¯ã§ãã¾ã›ã‚“<br>
  <small>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã§å‡¦ç†ã‚’ä¸­æ­¢ã§ãã¾ã™</small>
</div>

<!-- å±¥æ­´ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="history-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10002;">
  <div id="history-modal-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);"></div>
  <div id="history-modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 800px; height: 70%; background: white; border-radius: 8px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;">
    <div id="history-modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1em; border-bottom: 1px solid #ddd; background: #f8f9fa; border-radius: 8px 8px 0 0;">
      <h3 style="margin: 0; color: #333;">ğŸ“œ æ¤œç´¢å±¥æ­´</h3>
      <button id="history-modal-close" style="background: none; border: none; font-size: 1.2em; cursor: pointer; padding: 0.5em; border-radius: 4px;">âœ–ï¸</button>
    </div>
    <div id="history-modal-body" style="flex: 1; overflow-y: auto; padding: 1em;">
      <div id="history-list"></div>
    </div>
    <div id="history-modal-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 1em; border-top: 1px solid #ddd; background: #f8f9fa; border-radius: 0 0 8px 8px; gap: 0.5em;">
      <button id="history-expand-btn" disabled style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">ğŸ“– å±•é–‹</button>
      <button id="history-restore-btn" disabled style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">ğŸ”„ å¾©å…ƒ</button>
      <button id="history-delete-btn" disabled style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">ğŸ—‘ï¸ å‰Šé™¤</button>
      <select id="history-download-format" style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">
        <option value="txt">TXT</option>
        <option value="json">JSON</option>
        <option value="rtf">RTF</option>
        <option value="docx">DOCX</option>
      </select>
      <button id="history-download-btn" style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button id="history-clear-btn" style="padding: 0.5em 1em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
    </div>
  </div>
</div>

<!-- NiceGUIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è©¦é¨“ã‚¨ãƒªã‚¢ -->
<div style="margin-top: 40px; padding: 20px; border-top: 3px solid #007bff; background: #f8f9fa;">
  <h3 style="color: #007bff; margin-bottom: 20px;">ğŸš€ NiceGUIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è©¦é¨“ã‚¨ãƒªã‚¢</h3>
  <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
    æ—¢å­˜æ©Ÿèƒ½ã¨åŒã˜ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’NiceGUIã§å†ç¾ã—ã¦ã„ã¾ã™ã€‚å°†æ¥çš„ã«ä¸Šéƒ¨ã®æ—¢å­˜ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨ç½®ãæ›ãˆäºˆå®šã§ã™ã€‚
  </p>
  
  <!-- NiceGUI iframeåŸ‹ã‚è¾¼ã¿ã‚¨ãƒªã‚¢ -->
  <div id="nicegui-chat-controls" style="min-height: 500px; border: 1px solid #ddd; border-radius: 8px; background: white;">
    <div style="padding: 20px; text-align: center; color: #888;">
      <div class="spinner" style="display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <p style="margin-top: 10px;">NiceGUIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

{% endblock %}

{% block extra_js %}
<!-- æ©Ÿèƒ½åˆ¥ã«åˆ†å‰²ã•ã‚ŒãŸJavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
<script src="{{ url_for('static', path='js/chat_layout.js') }}"></script>
<script src="{{ url_for('static', path='js/chat_resize.js') }}"></script>
<script src="{{ url_for('static', path='js/chat_search.js') }}"></script>
<script src="{{ url_for('static', path='js/chat_history.js') }}"></script>
<script src="{{ url_for('static', path='js/chat_main.js') }}"></script>

<!-- NiceGUIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«åŸ‹ã‚è¾¼ã¿ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // NiceGUIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’åŸ‹ã‚è¾¼ã¿
    const niceguiContainer = document.getElementById('nicegui-chat-controls');
    if (niceguiContainer) {
        // iframeä½œæˆ
        const iframe = document.createElement('iframe');
        iframe.src = '/nicegui/chat/controls';
        iframe.style.width = '100%';
        iframe.style.height = '500px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†å¾Œã«ã‚¹ãƒ”ãƒŠãƒ¼ã‚’å‰Šé™¤
        iframe.onload = function() {
            niceguiContainer.innerHTML = '';
            niceguiContainer.appendChild(iframe);
        };
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        iframe.onerror = function() {
            niceguiContainer.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #dc3545;">
                    <p>âŒ NiceGUIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                    <p style="font-size: 12px; color: #666;">
                        ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå†èµ·å‹•ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
                    </p>
                </div>
            `;
        };
    }
});
</script>
{% endblock %}