{% extends "base_new.html" %}
{% block title %}ãƒ‡ãƒ¼ã‚¿ç™»éŒ²{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/status_common.css') }}?v=2">
<link rel="stylesheet" href="{{ url_for('static', path='/css/data_registration.css') }}?v=20">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='/js/sse_client.js') }}" defer></script>
<script src="{{ url_for('static', path='/js/data_registration.js') }}?v=2" defer></script>
{% endblock %}

{% block content %}
<div class="data-registration-container">
    <!-- å·¦ä¸Šãƒšã‚¤ãƒ³: è¨­å®šé …ç›® -->
    <div class="settings-panel">
        <div class="panel-header">
            <h3>ğŸ“‹ å‡¦ç†è¨­å®š</h3>
            <div class="panel-header-actions">
                <button id="start-processing" class="btn btn-primary btn-sm" disabled>
                    <span class="btn-icon">ğŸš€</span>
                    å‡¦ç†é–‹å§‹
                </button>
                <button id="stop-processing" class="btn btn-secondary btn-sm" style="display: none;">
                    <span class="btn-icon">â¹ï¸</span>
                    åœæ­¢
                </button>
            </div>
        </div>
        <div class="panel-content">
            <!-- æ•´å½¢ãƒ—ãƒ­ã‚»ã‚¹ã¨ä½¿ç”¨ãƒ¢ãƒ‡ãƒ« -->
            <div class="setting-group horizontal-group">
                <div class="setting-left">
                    <label for="process-select">æ•´å½¢ãƒ—ãƒ­ã‚»ã‚¹</label>
                    <select id="process-select" class="form-control process-select-wide">
                        <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (OCR + LLMæ•´å½¢)</option>
                        <option value="multimodal" id="multimodal-option">ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«</option>
                    </select>
                </div>
                <div class="setting-right">
                    <div class="model-display-inline">ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«ï¼š<span id="current-model">è‡ªå‹•åˆ¤å®šä¸­...</span></div>
                </div>
            </div>



            <!-- åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ« -->
            <div class="setting-group">
                <label>åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«</label>
                <div class="model-group">
                    <div class="model-category">
                        <div class="checkbox-group">
                            {% for key, config in embedding_options.items() %}
                            <label>
                                <input type="checkbox" id="{{ key }}" {% if key == "1" %}checked{% endif %}> 
                                <span class="category-inline">{{ config["embedder"] }}:</span> {{ config["model_name"] }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ä¸Šæ›¸ãã¨å“è³ªã—ãã„å€¤ -->
            <div class="setting-group horizontal-group">
                <div class="setting-left">
                    <div class="checkbox-group" style="margin-left: 2em;">
                        <label>
                            <input type="checkbox" id="overwrite-existing" checked>
                            æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ã
                        </label>
                    </div>
                </div>
                <div class="setting-right">
                    <label for="quality-threshold">å“è³ªã—ãã„å€¤</label>
                    <input type="number" id="quality-threshold" class="form-control compact-input-small" value="0.0" min="0" max="1" step="0.1">
                </div>
            </div>

            <!-- LLMã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ -->
            <div class="setting-group">
                <label for="llm-timeout">LLMã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (ç§’)</label>
                <input type="number" id="llm-timeout" class="form-control compact-input-small timeout" value="300" min="30" max="3600">
            </div>


        </div>
    </div>

    <!-- å³ä¸Šãƒšã‚¤ãƒ³: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
    <div class="file-selection-panel">
        <div class="panel-header horizontal-layout">
            <h3>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</h3>
            <select id="status-filter" class="form-control compact-select">
                <option value="">ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                <option value="pending_processing" data-status="æœªå‡¦ç†">æœªå‡¦ç†</option>
                <option value="processing" data-status="å‡¦ç†ä¸­">å‡¦ç†ä¸­</option>
                <option value="text_extracted" data-status="æœªæ•´å½¢">æœªæ•´å½¢</option>
                <option value="text_refined" data-status="æœªãƒ™ã‚¯ãƒˆãƒ«åŒ–">æœªãƒ™ã‚¯ãƒˆãƒ«åŒ–</option>
                <option value="processed" data-status="å‡¦ç†å®Œäº†">å‡¦ç†å®Œäº†</option>
                <option value="error" data-status="ã‚¨ãƒ©ãƒ¼">ã‚¨ãƒ©ãƒ¼</option>
            </select>
            <input type="text" id="search-input" class="form-control compact-input" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åã§æ¤œç´¢...">
            <span class="selection-count">é¸æŠ: <span id="selected-count">0</span>ä»¶</span>
        </div>
        <div class="panel-content">

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="file-list-container">
                <table class="file-table">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="header-checkbox" title="å…¨é¸æŠ/è§£é™¤">
                            </th>
                            <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                            <th>é æ•°</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th>ã‚µã‚¤ã‚º</th>
                        </tr>
                    </thead>
                    <tbody id="file-list-tbody">
                        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                    </tbody>
                </table>
                <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span id="file-count-info">0ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«</span>
                        <select id="page-size" class="form-control pagination-select">
                            <option value="50">50ä»¶/ãƒšãƒ¼ã‚¸</option>
                            <option value="100" selected>100ä»¶/ãƒšãƒ¼ã‚¸</option>
                            <option value="200">200ä»¶/ãƒšãƒ¼ã‚¸</option>
                            <option value="500">500ä»¶/ãƒšãƒ¼ã‚¸</option>
                        </select>
                    </div>
                    <div class="pagination-nav">
                        <button id="prev-page" class="btn btn-sm btn-outline" disabled>â—€</button>
                        <span id="page-info">1 / 1</span>
                        <button id="next-page" class="btn btn-sm btn-outline" disabled>â–¶</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å·¦ä¸‹ãƒšã‚¤ãƒ³: å‡¦ç†ãƒ­ã‚° -->
    <div class="log-panel">
        <div class="panel-header">
            <h3>ğŸ“‹ å‡¦ç†ãƒ­ã‚°</h3>
            <div class="log-controls">
                <label class="toggle-switch">
                    <input type="checkbox" id="auto-scroll-toggle" checked>
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</span>
                </label>
                <button id="export-csv" class="btn btn-sm btn-outline">CSVå‡ºåŠ›</button>
            </div>
        </div>
        <div class="panel-content">
            <div id="processing-log" class="log-container">
                <!-- å‡¦ç†ãƒ­ã‚°ãŒã“ã“ã«å‹•çš„è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <!-- å³ä¸‹ãƒšã‚¤ãƒ³: å‡¦ç†çŠ¶æ³ -->
    <div class="status-panel">
        <div class="panel-header">
            <h3>ğŸ“Š å‡¦ç†çŠ¶æ³</h3>
        </div>
        <div class="panel-content">
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-label">å…¨ä½“é€²æ—</span>
                    <span class="progress-text">å¾…æ©Ÿä¸­</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="overall-progress" style="width: 0%"></div>
                </div>
                <div class="progress-stats">
                    <span>å®Œäº†: <span id="completed-count">0</span></span>
                    <span>ã‚¨ãƒ©ãƒ¼: <span id="error-count">0</span></span>
                    <span>æ®‹ã‚Š: <span id="remaining-count">0</span></span>
                </div>
            </div>

            <div class="current-task">
                <h4>ç¾åœ¨ã®å‡¦ç†</h4>
                <div id="current-task-info">
                    <div class="task-file">å¾…æ©Ÿä¸­...</div>
                    <div class="task-stage">-</div>
                    <div class="task-progress">
                        <div class="progress-bar small">
                            <div class="progress-fill" id="current-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stats-grid-horizontal">
                <div class="stat-item">
                    <div class="stat-value" id="total-files">0</div>
                    <div class="stat-label">ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="selected-files">0</div>
                    <div class="stat-label">é¸æŠãƒ•ã‚¡ã‚¤ãƒ«æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="processing-time">00:00</div>
                    <div class="stat-label">å‡¦ç†æ™‚é–“</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="estimated-time">--:--</div>
                    <div class="stat-label">äºˆæƒ³æ®‹ã‚Šæ™‚é–“</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="log-dialog-overlay" class="log-dialog-overlay" style="display: none;">
    <div class="log-dialog">
        <div class="log-dialog-header">
            <h3>å‡¦ç†è©³ç´°ãƒ­ã‚°</h3>
            <button class="log-dialog-close" onclick="closeLogDialog()">&times;</button>
        </div>
        <div id="log-dialog-content" class="log-dialog-content">
            <!-- è©³ç´°ãƒ­ã‚°å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeDataRegistration();
});

async function initializeDataRegistration() {
    await loadFileList();
    setupEventListeners();
    updateSelectionCount();
    loadPromptConfig();
    initColumnResizing();  // ã‚«ãƒ©ãƒ å¹…å¤‰æ›´æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
    initializeStatusDropdown();  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è‰²ä»˜ããƒãƒƒã‚¸ã‚’åˆæœŸåŒ–
    
    // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ï¼‰
    window.autoScrollEnabled = true;
}

async function loadPromptConfig() {
    try {
        const response = await fetch('/api/config/prompts', {
            headers: {
                'Authorization': `Bearer ${Auth.getAuthToken()}`
            },
            credentials: 'include'
        });
        
        if (response.ok) {
            const config = await response.json();
            
            // CPU/GPUç’°å¢ƒã«å¿œã˜ã¦ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆ¶å¾¡
            const multimodalOption = document.getElementById('multimodal-option');
            const currentModelSpan = document.getElementById('current-model');
            const processSelect = document.getElementById('process-select');
            
            if (config.cuda_available) {
                // GPUç’°å¢ƒ: ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ä½¿ç”¨å¯èƒ½
                multimodalOption.disabled = false;
                multimodalOption.style.color = '';
                multimodalOption.title = 'ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç† (Qwen-VL 7B)';
                currentModelSpan.textContent = 'gemma3 (GPU)';
            } else {
                // CPUç’°å¢ƒ: ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ä½¿ç”¨ä¸å¯
                multimodalOption.disabled = true;
                multimodalOption.style.color = '#ccc';
                multimodalOption.title = 'GPUç’°å¢ƒã§ã®ã¿åˆ©ç”¨å¯èƒ½';
                currentModelSpan.textContent = 'Phi4-mini (CPU)';
                
                // CPUç’°å¢ƒã§ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
                if (processSelect.value === 'multimodal') {
                    processSelect.value = 'default';
                }
            }
            
            // ãƒ—ãƒ­ã‚»ã‚¹é¸æŠã®å¤‰æ›´ç›£è¦–
            processSelect.addEventListener('change', function() {
                if (this.value === 'multimodal' && config.cuda_available) {
                    currentModelSpan.textContent = 'Qwen-VL 7B (GPU)';
                } else {
                    currentModelSpan.textContent = config.cuda_available ? 'gemma3 (GPU)' : 'Phi4-mini (CPU)';
                }
            });
        }
    } catch (error) {
        console.error('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã®å–å¾—ã«å¤±æ•—:', error);
        document.getElementById('current-model').textContent = 'è¨­å®šå–å¾—å¤±æ•—';
    }
}

function setupEventListeners() {
    // å…¨é¸æŠ/è§£é™¤
    document.getElementById('select-all').addEventListener('click', selectAllFiles);
    document.getElementById('deselect-all').addEventListener('click', deselectAllFiles);
    document.getElementById('header-checkbox').addEventListener('change', toggleAllFiles);
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    document.getElementById('status-filter').addEventListener('change', filterFiles);
    document.getElementById('search-input').addEventListener('input', filterFiles);
    
    // å‡¦ç†ãƒœã‚¿ãƒ³
    document.getElementById('start-processing').addEventListener('click', startProcessing);
    document.getElementById('stop-processing').addEventListener('click', stopProcessing);
    
    // ãƒ­ã‚°åˆ¶å¾¡
    document.getElementById('auto-scroll-toggle').addEventListener('change', toggleAutoScroll);
    document.getElementById('export-csv').addEventListener('click', exportLogToCSV);
    
    // åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ã®å¤‰æ›´ç›£è¦–
    document.querySelectorAll('input[type="checkbox"][id*="intfloat"], input[type="checkbox"][id*="nomic"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateProcessButton);
    });
}

async function loadFileList() {
    try {
        const response = await fetch('/api/files', {
            headers: {
                'Authorization': `Bearer ${Auth.getAuthToken()}`
            },
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            displayFileList(data.files || []);
        } else {
            addLogEntry('ERROR', 'ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        addLogEntry('ERROR', `ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
}

function displayFileList(files) {
    const tbody = document.getElementById('file-list-tbody');
    tbody.innerHTML = '';
    
    files.forEach(file => {
        const row = document.createElement('tr');
        row.dataset.fileId = file.id;
        row.dataset.status = file.status;
        row.dataset.fileName = file.file_name;
        
        const pageCount = file.page_count || '-';
        
        row.innerHTML = `
            <td>
                <input type="checkbox" class="file-checkbox" data-file-id="${file.id}">
            </td>
            <td class="file-name" title="${file.file_name}">${file.file_name}</td>
            <td>${pageCount}</td>
            <td>
                <span class="status-badge status-${file.status}">
                    ${getStatusText(file.status)}
                </span>
            </td>
            <td>${formatFileSize(file.file_size || 0)}</td>
        `;
        
        tbody.appendChild(row);
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
        const checkbox = row.querySelector('.file-checkbox');
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
            updateSelectionCount();
            updateProcessButton();
        });
    });
    
    document.getElementById('total-files').textContent = files.length;
    updateSelectionCount();
}

function selectAllFiles() {
    const visibleRows = Array.from(document.querySelectorAll('#file-list-tbody tr'))
        .filter(row => row.style.display !== 'none');
    const visibleCheckboxes = visibleRows.map(row => row.querySelector('.file-checkbox'));
    
    visibleCheckboxes.forEach(cb => {
        if (cb && !cb.disabled) {
            cb.checked = true;
            cb.closest('tr').classList.add('selected');
        }
    });
    
    document.getElementById('header-checkbox').checked = true;
    updateSelectionCount();
    updateProcessButton();
}

function deselectAllFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = false;
        cb.closest('tr').classList.remove('selected');
    });
    
    document.getElementById('header-checkbox').checked = false;
    updateSelectionCount();
    updateProcessButton();
}

function toggleAllFiles() {
    const headerCheckbox = document.getElementById('header-checkbox');
    const visibleRows = Array.from(document.querySelectorAll('#file-list-tbody tr'))
        .filter(row => row.style.display !== 'none');
    
    const visibleCheckboxes = visibleRows.map(row => row.querySelector('.file-checkbox'));
    const allChecked = visibleCheckboxes.every(cb => cb.checked);
    
    if (allChecked) {
        // å…¨ã¦ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã®å ´åˆã¯è§£é™¤
        visibleCheckboxes.forEach(cb => {
            cb.checked = false;
            cb.closest('tr').classList.remove('selected');
        });
        headerCheckbox.checked = false;
    } else {
        // ä¸€éƒ¨ã¾ãŸã¯å…¨ã¦ãŒæœªãƒã‚§ãƒƒã‚¯ã®å ´åˆã¯å…¨é¸æŠ
        visibleCheckboxes.forEach(cb => {
            cb.checked = true;
            cb.closest('tr').classList.add('selected');
        });
        headerCheckbox.checked = true;
    }
    
    updateSelectionCount();
    updateProcessButton();
}

function updateSelectionCount() {
    const selectedCount = document.querySelectorAll('.file-checkbox:checked').length;
    document.getElementById('selected-count').textContent = selectedCount;
    document.getElementById('selected-files').textContent = selectedCount;
}

function updateProcessButton() {
    const selectedCount = document.querySelectorAll('.file-checkbox:checked').length;
    const startButton = document.getElementById('start-processing');
    
    // MUSTé …ç›®ã®ãƒã‚§ãƒƒã‚¯
    const hasSelectedFiles = selectedCount > 0;
    const hasSelectedModel = document.querySelectorAll('input[type="checkbox"][id*="intfloat"], input[type="checkbox"][id*="nomic"]:checked').length > 0;
    
    const canProcess = hasSelectedFiles && hasSelectedModel;
    startButton.disabled = !canProcess;
    
    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§ã‚¨ãƒ©ãƒ¼ç†ç”±ã‚’è¡¨ç¤º
    if (!hasSelectedFiles) {
        startButton.title = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';
    } else if (!hasSelectedModel) {
        startButton.title = 'åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';
    } else {
        startButton.title = 'å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™';
    }
}

function filterFiles() {
    const statusFilter = document.getElementById('status-filter').value;
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const rows = document.querySelectorAll('#file-list-tbody tr');
    
    rows.forEach(row => {
        const status = row.dataset.status;
        const fileName = row.dataset.fileName.toLowerCase();
        
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesSearch = !searchTerm || fileName.includes(searchTerm);
        
        row.style.display = matchesStatus && matchesSearch ? '' : 'none';
    });
}

// ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å†…ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«è‰²ä»˜ããƒãƒƒã‚¸ã‚’è¿½åŠ 
function initializeStatusDropdown() {
    const statusFilter = document.getElementById('status-filter');
    if (!statusFilter) return;
    
    // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã¦è‰²ä»˜ããƒãƒƒã‚¸ã‚’è¿½åŠ 
    const options = statusFilter.querySelectorAll('option');
    options.forEach(option => {
        const statusText = option.getAttribute('data-status');
        if (statusText) {
            const statusClass = `status-${statusText}`;
            option.innerHTML = `<span class="status-badge ${statusClass}">${statusText}</span>`;
        }
    });
}

function startProcessing() {
    const selectedFiles = Array.from(document.querySelectorAll('.file-checkbox:checked'))
        .map(cb => cb.dataset.fileId);
    
    if (selectedFiles.length === 0) {
        addLogEntry('WARNING', 'å‡¦ç†ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    // UIçŠ¶æ…‹å¤‰æ›´
    document.getElementById('start-processing').style.display = 'none';
    document.getElementById('stop-processing').style.display = 'inline-flex';
    
    addLogEntry('INFO', `å‡¦ç†é–‹å§‹: ${selectedFiles.length}ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ`);
    
    // TODO: å®Ÿéš›ã®å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
    simulateProcessing(selectedFiles);
}

function stopProcessing() {
    // UIçŠ¶æ…‹å¤‰æ›´
    document.getElementById('start-processing').style.display = 'inline-flex';
    document.getElementById('stop-processing').style.display = 'none';
    
    addLogEntry('WARNING', 'å‡¦ç†ã‚’åœæ­¢ã—ã¾ã—ãŸ');
}

function simulateProcessing(fileIds) {
    // ãƒ‡ãƒ¢ç”¨ã®ç–‘ä¼¼å‡¦ç†
    let processed = 0;
    const total = fileIds.length;
    
    const interval = setInterval(() => {
        processed++;
        const progress = (processed / total) * 100;
        
        document.getElementById('overall-progress').style.width = `${progress}%`;
        document.getElementById('completed-count').textContent = processed;
        document.getElementById('remaining-count').textContent = total - processed;
        
        addLogEntry('INFO', `ãƒ•ã‚¡ã‚¤ãƒ« ${processed}/${total} å‡¦ç†å®Œäº†`);
        
        if (processed >= total) {
            clearInterval(interval);
            addLogEntry('SUCCESS', 'å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
            document.getElementById('start-processing').style.display = 'inline-flex';
            document.getElementById('stop-processing').style.display = 'none';
        }
    }, 1000);
}

function addLogEntry(level, message, detailData = null) {
    const logContainer = document.getElementById('processing-log');
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    
    if (detailData) {
        entry.classList.add('clickable');
        entry.onclick = () => showLogDetail(detailData);
    }
    
    const now = new Date();
    const timeStr = now.toLocaleString('ja-JP', {
        hour12: false,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    entry.innerHTML = `
        <span class="log-time">[${timeStr}]</span>
        <span class="log-level ${level}">${level}</span>
        <span class="log-message">${message}${detailData ? ' [è©³ç´°]' : ''}</span>
    `;
    
    // æœ€æ–°ã®ãƒ­ã‚°ã‚’ä¸Šã«è¿½åŠ 
    if (logContainer.firstChild) {
        logContainer.insertBefore(entry, logContainer.firstChild);
    } else {
        logContainer.appendChild(entry);
    }
    
    // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒæœ‰åŠ¹ãªå ´åˆã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    if (window.autoScrollEnabled !== false) {
        logContainer.scrollTop = 0;
    }
}

function showLogDetail(detailData) {
    const overlay = document.getElementById('log-dialog-overlay');
    const content = document.getElementById('log-dialog-content');
    
    let detailText = '';
    if (typeof detailData === 'object') {
        detailText = JSON.stringify(detailData, null, 2);
    } else {
        detailText = detailData;
    }
    
    content.textContent = detailText;
    overlay.style.display = 'flex';
}

function closeLogDialog() {
    document.getElementById('log-dialog-overlay').style.display = 'none';
}

function toggleAutoScroll() {
    const toggle = document.getElementById('auto-scroll-toggle');
    const isActive = toggle.checked;
    
    // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°
    window.autoScrollEnabled = isActive;
    
    if (isActive) {
        addLogEntry('INFO', 'è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ');
    } else {
        addLogEntry('INFO', 'è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸ');
    }
}

function exportLogToCSV() {
    const logContainer = document.getElementById('processing-log');
    const logEntries = logContainer.querySelectorAll('.log-entry');
    
    if (logEntries.length === 0) {
        addLogEntry('WARNING', 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    // CSVãƒ˜ãƒƒãƒ€ãƒ¼
    let csvContent = 'æ™‚åˆ»,ãƒ¬ãƒ™ãƒ«,ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\n';
    
    // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’CSVã«å¤‰æ›
    logEntries.forEach(entry => {
        const time = entry.querySelector('.log-time').textContent.replace(/[\[\]]/g, '');
        const level = entry.querySelector('.log-level').textContent;
        const message = entry.querySelector('.log-message').textContent.replace(/"/g, '""'); // ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        
        csvContent += `"${time}","${level}","${message}"\n`;
    });
    
    // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆç¾åœ¨ã®æ—¥æ™‚ï¼‰
    const now = new Date();
    const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
    const filename = `processing_log_${timestamp}.csv`;
    
    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    
    addLogEntry('SUCCESS', `ãƒ­ã‚°ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ« (${filename}) ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
}

function getStatusText(status) {
    const statusMap = {
        'pending_processing': 'æœªå‡¦ç†',
        'processing': 'å‡¦ç†ä¸­',
        'text_extracted': 'æœªæ•´å½¢',
        'text_refined': 'æœªãƒ™ã‚¯ãƒˆãƒ«åŒ–',
        'processed': 'å‡¦ç†å®Œäº†',
        'error': 'ã‚¨ãƒ©ãƒ¼'
    };
    return statusMap[status] || status;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Excelãƒ©ã‚¤ã‚¯ãªã‚«ãƒ©ãƒ å¹…å¤‰æ›´æ©Ÿèƒ½
function initColumnResizing() {
    const table = document.querySelector('.file-table');
    if (!table) return;
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒªã‚µã‚¤ã‚¶ãƒ¼ã‚’è¿½åŠ 
    const headers = table.querySelectorAll('th');
    headers.forEach((th, index) => {
        // æœ€å¾Œã®ã‚«ãƒ©ãƒ ä»¥å¤–ã«ãƒªã‚µã‚¤ã‚¶ãƒ¼ã‚’è¿½åŠ 
        if (index < headers.length - 1) {
            const resizer = document.createElement('div');
            resizer.className = 'column-resizer';
            th.appendChild(resizer);
            
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;
            
            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = th.offsetWidth;
                resizer.classList.add('active');
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const diff = e.clientX - startX;
                const newWidth = Math.max(30, startWidth + diff); // æœ€å°å¹…30px
                
                // ã‚«ãƒ©ãƒ å¹…ã‚’æ›´æ–°
                th.style.width = newWidth + 'px';
                
                // å¯¾å¿œã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ«ã®å¹…ã‚‚æ›´æ–°
                const tbody = table.querySelector('tbody');
                if (tbody) {
                    tbody.querySelectorAll(`tr td:nth-child(${index + 1})`).forEach(td => {
                        td.style.width = newWidth + 'px';
                    });
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‚«ãƒ©ãƒ ã®å¹…ã‚’å†è¨ˆç®—
                adjustFileNameColumn();
            });
            
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    resizer.classList.remove('active');
                    document.body.style.cursor = '';
                }
            });
        }
    });
}

function adjustFileNameColumn() {
    const table = document.querySelector('.file-table');
    if (!table) return;
    
    const headers = table.querySelectorAll('th');
    let fixedWidth = 0;
    
    // ãƒ•ã‚¡ã‚¤ãƒ«åä»¥å¤–ã®ã‚«ãƒ©ãƒ å¹…ã‚’è¨ˆç®—
    headers.forEach((th, index) => {
        if (index !== 1) { // ãƒ•ã‚¡ã‚¤ãƒ«åã‚«ãƒ©ãƒ ä»¥å¤–
            fixedWidth += th.offsetWidth;
        }
    });
    
    // ãƒ•ã‚¡ã‚¤ãƒ«åã‚«ãƒ©ãƒ ã®å¹…ã‚’è¨­å®š
    const fileNameHeader = headers[1];
    const fileNameWidth = table.offsetWidth - fixedWidth - 20; // ä½™ç™½ã‚’è€ƒæ…®
    
    if (fileNameWidth > 100) { // æœ€å°å¹…ã‚’ç¢ºä¿
        fileNameHeader.style.width = fileNameWidth + 'px';
        
        // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ«ã‚‚æ›´æ–°
        const tbody = table.querySelector('tbody');
        if (tbody) {
            tbody.querySelectorAll('tr td:nth-child(2)').forEach(td => {
                td.style.width = fileNameWidth + 'px';
            });
        }
    }
}
</script>

<!-- OLDç³»ã¨åŒæ§˜ã€å‡¦ç†ãƒ­ã‚°ãƒšã‚¤ãƒ³ã®ã¿ã‚’ä½¿ç”¨ -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    DataRegistration.init();
});
</script>

{% endblock %}