{% extends "base.html" %}

{% block title %}ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç† - R&D RAGã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ãƒ‡ãƒãƒƒã‚°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
    <div id="debug-status" class="debug-status">
        <div class="debug-info">
            <span id="debug-text">åˆæœŸåŒ–ä¸­...</span>
            <button onclick="clearDebug()" class="debug-clear">ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <div class="files-layout">
        <!-- å·¦ãƒšã‚¤ãƒ³ï¼šãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ -->
        <div class="files-left-panel">
            <div class="files-container">
                
                <div class="files-controls">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åã§æ¤œç´¢..." class="form-control">
                    </div>
                    <div class="filter-controls">
                        <select id="status-filter" class="form-control">
                            <option value="">ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                            <option value="uploaded">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿</option>
                            <option value="processing">å‡¦ç†ä¸­</option>
                            <option value="completed">å®Œäº†</option>
                            <option value="error">ã‚¨ãƒ©ãƒ¼</option>
                        </select>
                    </div>
                </div>
                
                <div class="files-list">
                    <div class="files-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                                    <th>ã‚µã‚¤ã‚º</th>
                                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="files-tbody">
                                <!-- ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="no-files" class="no-files" style="display: none;">
                        <p>ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p>ä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
            </div>
        </div>
        
                       <!-- ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« -->
               <div class="resize-handle" id="resize-handle"></div>
               
               <!-- å³ãƒšã‚¤ãƒ³ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
               <div class="files-right-panel">
            <div class="preview-container">
                <div class="preview-content">
                    <div id="preview-placeholder">
                        <p>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º</p>
                    </div>
                                               <div id="pdf-preview-content" style="display: none;">
                               <iframe id="pdf-preview-frame" 
                                       src=""
                                       width="100%" 
                                       height="100%"
                                       style="border: none;">
                               </iframe>
                               <div id="pdf-fallback" style="display: none;">
                                   <p>PDFã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚<a id="pdf-download-link" href="#" target="_blank">æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã</a></p>
                               </div>
                           </div>
                    <div id="text-preview-content" style="display: none;">
                        <pre id="text-preview-text"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é€šçŸ¥ã‚¨ãƒªã‚¢ -->
    <div id="notifications"></div>
</div>

<script>
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    debugLog('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–‹å§‹');
    console.log('[INIT] ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–‹å§‹');
    
    // DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
    const requiredElements = [
        'files-tbody',
        'no-files',
        'pdf-preview-content',
        'pdf-preview-frame',
        'text-preview-content'
    ];
    
    console.log('[INIT] DOMè¦ç´ ç¢ºèª:');
    requiredElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        const exists = !!element;
        console.log(`[INIT] ${elementId}: ${exists}`);
        if (!exists) {
            console.error(`[INIT] è­¦å‘Š: ${elementId} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
        }
    });
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    loadFiles();
    
    // æ¤œç´¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('search-input').addEventListener('input', filterFiles);
    document.getElementById('status-filter').addEventListener('change', filterFiles);
    
    // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã®åˆæœŸåŒ–
    initResizeHandle();
});

// ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã®åˆæœŸåŒ–
function initResizeHandle() {
    const resizeHandle = document.getElementById('resize-handle');
    const leftPanel = document.querySelector('.files-left-panel');
    const rightPanel = document.querySelector('.files-right-panel');
    const layout = document.querySelector('.files-layout');
    
    if (!resizeHandle || !leftPanel || !rightPanel || !layout) {
        console.error('[RESIZE] ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã®åˆæœŸåŒ–ã«å¤±æ•—: å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    let isResizing = false;
    let startX = 0;
    let startLeftWidth = 0;
    
    resizeHandle.addEventListener('mousedown', function(e) {
        isResizing = true;
        startX = e.clientX;
        startLeftWidth = leftPanel.offsetWidth;
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        
        e.preventDefault();
    });
    
    function handleMouseMove(e) {
        if (!isResizing) return;
        
        const deltaX = e.clientX - startX;
        const newLeftWidth = startLeftWidth + deltaX;
        const layoutWidth = layout.offsetWidth;
        
        // æœ€å°ãƒ»æœ€å¤§å¹…ã®åˆ¶é™
        const minWidth = 200;
        const maxWidth = layoutWidth - 200;
        
        if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
            leftPanel.style.width = newLeftWidth + 'px';
            leftPanel.style.flex = 'none';
        }
    }
    
    function handleMouseUp() {
        isResizing = false;
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
    }
}

// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°é–¢æ•°
function debugLog(message) {
    const debugText = document.getElementById('debug-text');
    const timestamp = new Date().toLocaleTimeString();
    debugText.textContent = `[${timestamp}] ${message}`;
    console.log(`[DEBUG] ${message}`);
}

// ãƒ‡ãƒãƒƒã‚°ã‚¯ãƒªã‚¢
function clearDebug() {
    debugLog('ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
}

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
function showLoading() {
    debugLog('ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹');
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'flex';
    }
}

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
function hideLoading() {
    debugLog('ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º');
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

// é€šçŸ¥è¡¨ç¤º
function showNotification(message, type = 'info') {
    debugLog(`é€šçŸ¥è¡¨ç¤º: ${type} - ${message}`);
    const notifications = document.getElementById('notifications');
    if (notifications) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notifications.appendChild(notification);
        
        // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
}

// ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
async function loadFiles() {
    try {
        debugLog('ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿é–‹å§‹');
        showLoading();
        
        debugLog('APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­: /api/files');
        const response = await fetch('/api/files', {
            credentials: 'include'  // ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã‚’ä½¿ç”¨
        });
        
        debugLog(`APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡: ${response.status} ${response.statusText}`);
        
        if (response.ok) {
            const data = await response.json();
            debugLog(`APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(data).substring(0, 200)}...`);
            debugLog(`APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹: ${typeof data}`);
            debugLog(`APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚­ãƒ¼: ${Object.keys(data).join(', ')}`);
            
            // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ§‹é€ ã«åˆã‚ã›ã¦ä¿®æ­£
            const files = data.files || [];
            debugLog(`ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${files.length}`);
            
            if (files.length > 0) {
                debugLog(`æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«: ${JSON.stringify(files[0]).substring(0, 100)}...`);
            }
            
            displayFiles(files);
            debugLog('ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤ºå®Œäº†');
        } else {
            const errorText = await response.text();
            debugLog(`APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorText}`);
            showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    } catch (error) {
        debugLog(`ä¾‹å¤–ç™ºç”Ÿ: ${error.message}`);
        console.error('Error loading files:', error);
        showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    } finally {
        hideLoading();
    }
}

// ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
function displayFiles(files) {
    try {
        debugLog(`displayFilesé–‹å§‹: ${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«`);
        
        const tbody = document.getElementById('files-tbody');
        const noFiles = document.getElementById('no-files');
        
        if (!tbody) {
            debugLog('ã‚¨ãƒ©ãƒ¼: files-tbodyè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        
        if (!noFiles) {
            debugLog('ã‚¨ãƒ©ãƒ¼: no-filesè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        
        if (files.length === 0) {
            debugLog('ãƒ•ã‚¡ã‚¤ãƒ«ãŒ0å€‹ã®ãŸã‚ã€ç©ºã®è¡¨ç¤ºã‚’è¨­å®š');
            tbody.innerHTML = '';
            noFiles.style.display = 'block';
            return;
        }
        
        debugLog('ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®HTMLç”Ÿæˆé–‹å§‹');
        noFiles.style.display = 'none';
        
        const fileRows = [];
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            debugLog(`ãƒ•ã‚¡ã‚¤ãƒ«${i + 1}: ${file.filename} (${file.file_size} bytes) - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${file.status}`);
            
            try {
                // ãƒšãƒ¼ã‚¸æ•°æƒ…å ±ã‚’å–å¾—ï¼ˆPDFã®å ´åˆï¼‰
                const pageCount = file.page_count || '-';
                const isCompleted = file.status === 'completed';
                
                const row = `
                    <tr data-filename="${file.filename}" data-status="${file.status}">
                        <td>
                            <div class="file-info">
                                <span class="file-icon">ğŸ“„</span>
                                <a href="#" onclick="previewFile('${file.id}')" class="file-name-link">${file.filename}</a>
                            </div>
                        </td>
                        <td>${formatFileSize(file.file_size)} (${pageCount}é )</td>
                        <td>
                            <span class="status-badge status-${file.status}">
                                ${getStatusText(file.status)}
                            </span>
                        </td>
                        <td>${formatDate(file.created_at)}</td>
                        <td>
                            <div class="file-actions">
                                <button class="btn btn-sm btn-secondary" 
                                        onclick="viewFile('${file.id}')" 
                                        title="è©³ç´°è¡¨ç¤º">
                                    ğŸ‘ï¸
                                </button>
                                <button class="btn btn-sm btn-info ${!isCompleted ? 'disabled' : ''}" 
                                        onclick="${isCompleted ? 'previewFile(\'' + file.id + '\', \'text\')' : 'return false'}" 
                                        title="${isCompleted ? 'ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼' : 'å‡¦ç†å®Œäº†å¾Œã«åˆ©ç”¨å¯èƒ½'}"
                                        ${!isCompleted ? 'disabled' : ''}>
                                    ğŸ“„
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteFile('${file.id}')" title="å‰Šé™¤">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                fileRows.push(row);
            } catch (error) {
                debugLog(`ãƒ•ã‚¡ã‚¤ãƒ«${i + 1}ã®HTMLç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        debugLog(`HTMLç”Ÿæˆå®Œäº†: ${fileRows.length}å€‹ã®è¡Œã‚’ç”Ÿæˆ`);
        tbody.innerHTML = fileRows.join('');
        debugLog('ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤ºå®Œäº†');
        
    } catch (error) {
        debugLog(`displayFilesã‚¨ãƒ©ãƒ¼: ${error.message}`);
        console.error('displayFiles error:', error);
    }
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
function filterFiles() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    const rows = document.querySelectorAll('#files-tbody tr');
    
    rows.forEach(row => {
        const filename = row.querySelector('.file-name').textContent.toLowerCase();
        const status = row.dataset.status;
        
        const matchesSearch = filename.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;
        
        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
    });
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°è¡¨ç¤º
async function viewFile(fileId) {
    try {
        showLoading();
        const response = await fetch(`/api/files/${fileId}`, {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            const file = data.file || data;
            showFileDetails(file);
        } else {
            showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    } catch (error) {
        console.error('Error viewing file:', error);
        showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    } finally {
        hideLoading();
    }
}

// ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°ã‚’è¡¨ç¤º
function showFileDetails(file) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="file-detail">
                    <strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${file.filename}
                </div>
                <div class="file-detail">
                    <strong>ã‚µã‚¤ã‚º:</strong> ${formatFileSize(file.file_size)}
                </div>
                <div class="file-detail">
                    <strong>ãƒšãƒ¼ã‚¸æ•°:</strong> ${file.page_count || '-'}
                </div>
                <div class="file-detail">
                    <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> 
                    <span class="status-badge status-${file.status}">
                        ${getStatusText(file.status)}
                    </span>
                </div>
                <div class="file-detail">
                    <strong>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚:</strong> ${formatDate(file.created_at)}
                </div>
                ${file.text_content ? `
                <div class="file-detail">
                    <strong>ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹:</strong>
                    <div class="text-content">
                        <pre>${file.text_content}</pre>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
async function deleteFile(fileId) {
    if (!confirm('ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    
    try {
        showLoading();
        const response = await fetch(`/api/files/${fileId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        if (response.ok) {
            showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            loadFiles(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
        } else {
            showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    } catch (error) {
        console.error('Error deleting file:', error);
        showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    } finally {
        hideLoading();
    }
}

// ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
async function previewFile(fileId, previewType) {
    try {
        debugLog(`ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹: ${fileId}, ã‚¿ã‚¤ãƒ—: ${previewType}`);
        console.log(`[PREVIEW] ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹: fileId=${fileId}, previewType=${previewType}`);
        
        const response = await fetch(`/api/files/${fileId}/preview`, {
            method: 'GET',
            credentials: 'include'
        });
        
        console.log(`[PREVIEW] APIãƒ¬ã‚¹ãƒãƒ³ã‚¹: status=${response.status}, ok=${response.ok}`);
        debugLog(`APIãƒ¬ã‚¹ãƒãƒ³ã‚¹: status=${response.status}, ok=${response.ok}`);
        
        if (response.ok) {
            const contentType = response.headers.get('content-type');
            console.log(`[PREVIEW] Content-Type: ${contentType}`);
            debugLog(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—: ${contentType}`);
            
            if (contentType && contentType.includes('application/pdf')) {
                // PDFãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                console.log(`[PREVIEW] PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º: fileId=${fileId}`);
                debugLog('PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º');
                showPdfPreview(fileId);
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯ãƒã‚¤ãƒŠãƒªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å ´åˆ
                const data = await response.json();
                console.log(`[PREVIEW] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿:`, data);
                debugLog(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿å—ä¿¡: ${JSON.stringify(data).substring(0, 100)}...`);
                
                if (data.type === 'text') {
                    console.log(`[PREVIEW] ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º`);
                    debugLog('ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º');
                    showTextPreview(data.content);
                } else {
                    console.log(`[PREVIEW] ãƒã‚¤ãƒŠãƒªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º`);
                    debugLog('ãƒã‚¤ãƒŠãƒªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º');
                    showTextPreview(data.content);
                }
            }
        } else {
            const errorData = await response.json();
            const errorMessage = `HTTP ${response.status}: ${errorData.detail || 'Unknown error'}`;
            console.error(`[PREVIEW] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
            console.error(`[PREVIEW] ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:`, errorData);
            debugLog(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.detail}`);
            showNotification(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: ${errorMessage}`, 'error');
        }
    } catch (error) {
        const errorMessage = `${error.name}: ${error.message}`;
        console.error(`[PREVIEW] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾‹å¤–ã‚¨ãƒ©ãƒ¼:`, error);
        console.error(`[PREVIEW] ã‚¨ãƒ©ãƒ¼è©³ç´°:`, {
            name: error.name,
            message: error.message,
            stack: error.stack
        });
        debugLog(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
        showNotification(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: ${errorMessage}`, 'error');
    }
}

// PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å³ãƒšã‚¤ãƒ³ã«è¡¨ç¤º
function showPdfPreview(fileId) {
    const pdfUrl = `${window.location.origin}/api/files/${fileId}/preview`;
    const placeholder = document.getElementById('preview-placeholder');
    const pdfContent = document.getElementById('pdf-preview-content');
    const pdfFrame = document.getElementById('pdf-preview-frame');
    const pdfFallback = document.getElementById('pdf-fallback');
    const downloadLink = document.getElementById('pdf-download-link');
    
    console.log(`[PREVIEW] PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º: ${pdfUrl}`);
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
    placeholder.style.display = 'none';
    pdfContent.style.display = 'block';
    pdfFallback.style.display = 'none';
    
    // PDF iframeã®è¨­å®š
    pdfFrame.src = pdfUrl;
    downloadLink.href = pdfUrl;
    downloadLink.textContent = 'æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã';
    
    // iframeã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º
    pdfFrame.onerror = function() {
        console.log(`[PREVIEW] PDF iframeèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º`);
        pdfFrame.style.display = 'none';
        pdfFallback.style.display = 'block';
    };
    
    // iframeã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’æ¤œå‡º
    pdfFrame.onload = function() {
        console.log(`[PREVIEW] PDF iframeèª­ã¿è¾¼ã¿å®Œäº†`);
    };
    
    console.log(`[PREVIEW] PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºå®Œäº†`);
}

// ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å³ãƒšã‚¤ãƒ³ã«è¡¨ç¤º
function showTextPreview(content) {
    const placeholder = document.getElementById('preview-placeholder');
    const textContent = document.getElementById('text-preview-content');
    const textElement = document.getElementById('text-preview-text');
    
    console.log(`[PREVIEW] ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º`);
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
    placeholder.style.display = 'none';
    textContent.style.display = 'block';
    
    // ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã‚’è¨­å®š
    textElement.textContent = content;
    
    console.log(`[PREVIEW] ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºå®Œäº†`);
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
function closePreview() {
    const placeholder = document.getElementById('preview-placeholder');
    const pdfContent = document.getElementById('pdf-preview-content');
    const textContent = document.getElementById('text-preview-content');
    
    console.log(`[PREVIEW] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹`);
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º
    placeholder.style.display = 'block';
    pdfContent.style.display = 'none';
    textContent.style.display = 'none';
    
    console.log(`[PREVIEW] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‰ã˜ã¾ã—ãŸ`);
}

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
function getStatusText(status) {
    const statusMap = {
        'uploaded': 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿',
        'processing': 'å‡¦ç†ä¸­',
        'completed': 'å®Œäº†',
        'error': 'ã‚¨ãƒ©ãƒ¼'
    };
    return statusMap[status] || status;
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDate(dateString) {
    if (!dateString) return '-';
    
    const date = new Date(dateString);
    return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}
</script>

<style>
/* ãƒ‡ãƒãƒƒã‚°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
.debug-status {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 20px;
    font-family: monospace;
    font-size: 12px;
}

.debug-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.debug-text {
    color: #666;
    word-break: break-all;
}

.debug-clear {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 2px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}
        
/* å³ãƒšã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.files-layout {
    display: flex;
    height: calc(100vh - 120px);
    gap: 0;
    position: relative;
}
        
.files-left-panel {
    flex: 1;
    min-width: 300px;
    max-width: 60%;
    overflow: hidden;
}
        
.resize-handle {
    width: 8px;
    background: #e0e0e0;
    cursor: col-resize;
    position: relative;
    transition: background-color 0.2s;
}

.resize-handle:hover {
    background: #c0c0c0;
}

.resize-handle:active {
    background: #a0a0a0;
}

.resize-handle::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 2px;
    height: 20px;
    background: #999;
    border-radius: 1px;
}
        
.files-right-panel {
    flex: 1;
    min-width: 300px;
    background-color: #f8f9fa;
}
        
.preview-container {
    height: 100%;
    display: flex;
    flex-direction: column;
}
        
.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    background-color: #fff;
}
        
.preview-header h3 {
    margin: 0;
    color: #333;
}
        
.preview-content {
    flex: 1;
    padding: 20px;
    overflow: auto;
}
        
#preview-placeholder {
    text-align: center;
    color: #666;
    margin-top: 50px;
}
        
#pdf-preview-content {
    height: 100%;
}
        
#pdf-preview-frame {
    width: 100%;
    height: 100%;
    border: none;
}
        
#text-preview-content {
    height: 100%;
    overflow: auto;
}
        
#text-preview-text {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
}
        
/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 1200px) {
    .files-layout {
        flex-direction: column;
        height: auto;
    }
    
    .files-right-panel {
        max-width: none;
        height: 400px;
    }
}

.files-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.files-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.files-controls {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    align-items: center;
}

.search-box {
    flex: 1;
}

.filter-controls {
    min-width: 200px;
}

.files-table {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.files-table table {
    width: 100%;
    border-collapse: collapse;
}

.files-table th,
.files-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}

.files-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #333;
}

.files-table tr:hover {
    background: #f8f9fa;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 8px;
}

.file-icon {
    font-size: 18px;
}

.file-name {
    font-weight: 500;
    color: #333;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.status-uploaded {
    background: #e3f2fd;
    color: #1976d2;
}

.status-processing {
    background: #fff3e0;
    color: #f57c00;
}

.status-completed {
    background: #e8f5e8;
    color: #388e3c;
}

.status-error {
    background: #ffebee;
    color: #d32f2f;
}

.file-actions {
    display: flex;
    gap: 8px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.no-files {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.no-files p {
    margin-bottom: 20px;
    font-size: 18px;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 2% auto;
    padding: 0;
    border: 1px solid #888;
    width: 90%;
    height: 90%;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    background-color: #f8f9fa;
    border-radius: 8px 8px 0 0;
}

.modal-header h3 {
    margin: 0;
    color: #333;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.close-btn:hover {
    color: #333;
}

.modal-body {
    padding: 0;
    height: calc(100% - 70px);
}

.file-detail {
    margin-bottom: 15px;
}

.file-detail strong {
    display: inline-block;
    width: 120px;
    color: #333;
}

.text-content {
    margin-top: 10px;
    background: #f8f9fa;
    border-radius: 4px;
    padding: 12px;
    max-height: 200px;
    overflow-y: auto;
}

.text-content pre {
    margin: 0;
    white-space: pre-wrap;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.4;
}

.preview-content {
    background: #f8f9fa;
    border-radius: 4px;
    padding: 12px;
    max-height: 400px;
    overflow-y: auto;
}

.preview-content pre {
    margin: 0;
    white-space: pre-wrap;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.4;
}

.hex-dump {
    font-family: 'Courier New', Courier, monospace;
    font-size: 12px;
    color: #333;
    background: #f0f0f0;
    padding: 8px;
    border-radius: 4px;
    overflow-x: auto;
}

@media (max-width: 768px) {
    .files-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .files-controls {
        flex-direction: column;
        gap: 15px;
    }
    
    .files-table {
        overflow-x: auto;
    }
    
    .files-table table {
        min-width: 600px;
    }
    
    .file-actions {
        flex-direction: column;
        gap: 4px;
    }
}

#pdf-preview-frame {
    width: 100%;
    height: 100%;
    border: none;
}

#text-preview-content {
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.4;
    max-height: 500px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹CSS */
.file-name-link {
    color: #007bff;
    text-decoration: none;
    cursor: pointer;
}

.file-name-link:hover {
    color: #0056b3;
    text-decoration: underline;
}



/* ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒœã‚¿ãƒ³ */
.btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.btn.disabled:hover {
    opacity: 0.5;
}
</style>
{% endblock %} 