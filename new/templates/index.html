{% extends "base_new.html" %}

{% block title %}ãƒ›ãƒ¼ãƒ  - R&D RAGã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_css %}
<!-- v=2 -->
<style>
body.home-page .main-content {
    padding-top: 0;
}

/* ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã§ã¯ä¸Šéƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤º */
body.home-page .app-header {
    display:none;
}

body.home-page .hero {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #455a64 100%);
    color: white;
    padding: 20px 0 10px;
    position: relative;
}

body.home-page .hero-title {
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

body.home-page .hero-subtitle {
    color: rgba(255, 255, 255, 0.9);
}

/* ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®å³ä¸Šé…ç½® */
.hero-auth-container {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.hero-login-button {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.hero-login-button:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.hero-user-menu {
    display: flex;
    align-items: center;
    gap: 10px;
    color: white;
}

/* å…¨ä½“ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚° */
body.home-page .container {
    text-align: center;
}

/* ä¸»ãªæ©Ÿèƒ½ã®ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚° */
.feature-list-container {
    display: flex;
    justify-content: center;
    margin: 0 auto;
}

.feature-list {
    display: inline-block;
    text-align: left;
    max-width: 600px;
}

/* ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã®ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚° */
.stats-grid {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 0 auto;
    max-width: 600px;
}

body.home-page .features {
    padding: 40px 0;
}

body.home-page .feature-grid {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

body.home-page .feature-card {
    padding: 20px;
    margin-bottom: 0;
}

body.home-page .feature-icon {
    font-size: 32px;
    margin-bottom: 10px;
}

body.home-page .feature-card h3 {
    font-size: 18px;
    margin-bottom: 8px;
}

body.home-page .feature-card p {
    font-size: 14px;
    line-height: 1.4;
}

body.home-page .section-title {
    font-size: 24px;
    margin-bottom: 20px;
}

/* ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸å°‚ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
.home-nav-menu {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 30px;
    flex-wrap: wrap;
}

.home-nav-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    color: rgba(255, 255, 255, 0.85);
    text-decoration: none;
    border-radius: 4px;
    transition: all 0.2s ease;
    font-weight: 500;
    min-width: 100px;
    justify-content: center;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.12);
}

.home-nav-item:hover {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    border-color: rgba(255, 255, 255, 0.25);
}

.home-nav-item.active {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
}

.home-nav-item .nav-icon {
    font-size: 16px;
    line-height: 1;
}

.home-nav-item .nav-text {
    font-size: 14px;
    white-space: nowrap;
}

/* æ–°ã—ã„ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
.main-navigation {
    background: rgba(255, 255, 255, 0.95);
    border-bottom: 1px solid #ddd;
    padding: 15px 0;
}

.nav-buttons {
    display: inline-flex;
    display: flex;
    justify-content: center;
    gap: 0;
    margin-bottom: 15px;
    align-items: center;
}

.nav-button {
    padding: 10px 20px;
    color: #666;
    text-decoration: none;
    border: 1px solid #ddd;
    background: white;
    font-weight: 500;
    transition: all 0.2s ease;
}

.nav-button:first-child {
    border-radius: 6px 0 0 6px;
}

.nav-button:not(:first-child) {
    border-left: none;
}

.nav-button:last-child {
    border-radius: 0 6px 6px 0;
}

.nav-button:hover {
    background: #f8f9fa;
    color: #333;
}

.nav-button.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.nav-button-auth {
    background: transparent;
    color: #007bff;
    border-color: #007bff;
}

.nav-button-auth:hover {
    background: #007bff;
    color: white;
}

.auth-section {
    display: flex;
    justify-content: center;
    margin-bottom: 15px;
}

.user-menu {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: 10px;
}

.user-menu span {
    color: #333;
    font-weight: 500;
    font-size: 14px;
}

.authenticated-menu {
    max-width: 600px;
    margin: 0 auto;
}

.menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
}

.menu-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px 10px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    text-decoration: none;
    color: #333;
    transition: all 0.2s ease;
    min-height: 80px;
    justify-content: center;
}

.menu-item:hover {
    background: #f8f9fa;
    border-color: #007bff;
    color: #007bff;
}

.menu-icon {
    font-size: 20px;
    margin-bottom: 5px;
}

.menu-text {
    font-size: 12px;
    font-weight: 500;
}

/* æ–°ã—ã„æ©Ÿèƒ½ãƒªã‚¹ãƒˆ */









</style>

<script>
document.body.classList.add('home-page');

// ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸å°‚ç”¨ã®èªè¨¼çŠ¶æ…‹ç¢ºèª
document.addEventListener('DOMContentLoaded', function() {
    checkAuthForHome();
});

async function checkAuthForHome() {
    try {
        const response = await fetch('/api/user/profile', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            showAuthenticatedState(data.data.username, data.data.role);
        } else {
            showUnauthenticatedState();
        }
    } catch (error) {
        console.error('èªè¨¼çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
        showUnauthenticatedState();
    }
}

function showAuthenticatedState(username, role) {
    console.log('èªè¨¼çŠ¶æ…‹è¡¨ç¤º:', username, role);
    
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’éš ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
    const loginBtn = document.getElementById('login-button');
    const userMenu = document.getElementById('user-menu');
    const userName = document.getElementById('user-name');
    
    if (loginBtn) loginBtn.style.display = 'none';
    if (userMenu) userMenu.style.display = 'flex';
    if (userName) userName.textContent = username;
    
    // èªè¨¼å¾Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
    const authMenu = document.getElementById('authenticated-menu');
    if (authMenu) authMenu.style.display = 'block';
    
    // adminé™å®šé …ç›®ã®è¡¨ç¤ºåˆ¶å¾¡
    const adminItems = document.querySelectorAll('.admin-only');
    if (role === 'admin') {
        adminItems.forEach(item => {
            item.style.display = 'flex';
        });
    } else {
        adminItems.forEach(item => {
            item.style.display = 'none';
        });
    }
}

function showUnauthenticatedState() {
    console.log('æœªèªè¨¼çŠ¶æ…‹è¡¨ç¤º');
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éš ã—ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    const userMenu = document.getElementById('user-menu');
    const loginBtn = document.getElementById('login-button');
    const authMenu = document.getElementById('authenticated-menu');
    
    if (userMenu) userMenu.style.display = 'none';
    if (loginBtn) loginBtn.style.display = 'block';
    if (authMenu) authMenu.style.display = 'none';
}

// ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆmain.jsã®é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
function showLoginModal() {
    if (typeof window.showLoginModal === 'function') {
        window.showLoginModal();
    } else {
        window.location.href = '/login';
    }
}

// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆmain.jsã®é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
function logout() {
    if (typeof window.logout === 'function') {
        window.logout();
    } else {
        window.location.href = '/logout';
    }
}
</script>
{% endblock %}

{% block content %}
<div class="hero">
    <div class="container">
        <h1 class="hero-title">R&D RAGã‚·ã‚¹ãƒ†ãƒ </h1>
        <p class="hero-subtitle">AIãƒ–ãƒ¼ã‚¹ãƒˆã•ã‚ŒãŸæ–°ä¸–ä»£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ âœ¨</p>
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’å³ä¸Šã«é…ç½® -->
        <div class="hero-auth-container">
            <button id="login-button" class="hero-login-button" onclick="showLoginModal()" style="display: none;">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="user-menu" class="hero-user-menu" style="display: none;">
                <span id="user-name"></span>
                <button id="logout-button" class="btn btn-sm btn-outline" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="main-navigation">
    <div class="container">
        <div class="nav-buttons">
            <a href="/chat" class="nav-button">ãƒãƒ£ãƒƒãƒˆ</a>
            <a href="/files" class="nav-button">ãƒ•ã‚¡ã‚¤ãƒ«</a>
        </div>
        
        <!-- èªè¨¼å¾Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div id="authenticated-menu" class="authenticated-menu" style="display: none;">
            <div class="menu-grid">
                <a href="/files" class="menu-item">
                    <span class="menu-icon">â‰¡</span>
                    <span class="menu-text">ãƒ•ã‚¡ã‚¤ãƒ«</span>
                </a>
                <a href="/upload" class="menu-item admin-only" style="display: none;">
                    <span class="menu-icon">â†—</span>
                    <span class="menu-text">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
                </a>
                <a href="/ocr-comparison" class="menu-item admin-only" style="display: none;">
                    <span class="menu-icon">ğŸ“Š</span>
                    <span class="menu-text">OCRæ¯”è¼ƒæ¤œè¨¼</span>
                </a>
                <a href="/data-registration" class="menu-item admin-only" style="display: none;">
                    <span class="menu-icon">âš™</span>
                    <span class="menu-text">ãƒ‡ãƒ¼ã‚¿ç™»éŒ²</span>
                </a>
                <a href="/admin" class="menu-item admin-only" style="display: none;">
                    <span class="menu-icon">âš¡</span>
                    <span class="menu-text">ç®¡ç†</span>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="features">
    <div class="container">
        <h2 class="section-title">ä¸»ãªæ©Ÿèƒ½</h2>
        
        <div class="feature-list-container">
            <div class="feature-list">
            <div class="feature-item">
                <span class="feature-icon">ğŸ“„</span>
                <div class="feature-content">
                    <span class="feature-name">å¤šå½¢å¼æ–‡æ›¸å¯¾å¿œï¼š</span>
                    <span class="feature-description">PDFã€Wordã€ãƒ†ã‚­ã‚¹ãƒˆã€CSVã€JSONã€EMLãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ã«å¯¾å¿œ</span>
                </div>
            </div>
            
            <div class="feature-item">
                <span class="feature-icon">ğŸ”</span>
                <div class="feature-content">
                    <span class="feature-name">é«˜ç²¾åº¦OCRï¼š</span>
                    <span class="feature-description">è¤‡æ•°ã®OCRã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚ˆã‚‹é«˜ç²¾åº¦ãªãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º</span>
                </div>
            </div>
            
            <div class="feature-item">
                <span class="feature-icon">ğŸ¤–</span>
                <div class="feature-content">
                    <span class="feature-name">LLMæ•´å½¢ï¼š</span>
                    <span class="feature-description">Ollamaã‚’ä½¿ç”¨ã—ãŸæ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã®å“è³ªå‘ä¸Š</span>
                </div>
            </div>
            
            <div class="feature-item">
                <span class="feature-icon">ğŸ”</span>
                <div class="feature-content">
                    <span class="feature-name">ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼š</span>
                    <span class="feature-description">è¤‡æ•°ã®åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹é«˜ç²¾åº¦æ¤œç´¢</span>
                </div>
            </div>
            
            <div class="feature-item">
                <span class="feature-icon">âš¡</span>
                <div class="feature-content">
                    <span class="feature-name">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ï¼š</span>
                    <span class="feature-description">SSEã«ã‚ˆã‚‹é€²æ—è¡¨ç¤ºã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†</span>
                </div>
            </div>
            
            <div class="feature-item">
                <span class="feature-icon">ğŸ”’</span>
                <div class="feature-content">
                    <span class="feature-name">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆï¼š</span>
                    <span class="feature-description">HTTPSå¯¾å¿œã€èªè¨¼ã€APIåˆ†é›¢ã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ã‚¢ãªè¨­è¨ˆ</span>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>

<div class="stats">
    <div class="container">
        <h2 class="section-title">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="file-count">-</div>
                <div class="stat-label">ç™»éŒ²ãƒ•ã‚¡ã‚¤ãƒ«æ•°</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="session-count">-</div>
                <div class="stat-label">ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="embedding-count">-</div>
                <div class="stat-label">åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«æ•°</div>
            </div>
        </div>
    </div>
</div>

<script>
// ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³èª¿æ•´
document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('home-page');
    
    // èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    checkAuthForHome();
});

// ãƒ›ãƒ¼ãƒ ç”¨ã®èªè¨¼ç¢ºèª
async function checkAuthForHome() {
    try {
        const response = await fetch('/api/user/profile', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const userData = await response.json();
            showAuthenticatedState(userData.data);
        } else {
            showUnauthenticatedState();
        }
    } catch (error) {
        console.error('èªè¨¼ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
        showUnauthenticatedState();
    }
}

// ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿çŠ¶æ…‹ã®è¡¨ç¤º
function showAuthenticatedState(user) {
    const loginButton = document.getElementById('login-button');
    const userMenu = document.getElementById('user-menu');
    
    if (loginButton) loginButton.style.display = 'none';
    if (userMenu) {
        userMenu.style.display = 'flex';
        const usernameElement = userMenu.querySelector('.username');
        if (usernameElement) {
            usernameElement.textContent = user.username || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
        }
    }
}

// æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®è¡¨ç¤º
function showUnauthenticatedState() {
    const loginButton = document.getElementById('login-button');
    const userMenu = document.getElementById('user-menu');
    
    if (loginButton) loginButton.style.display = 'block';
    if (userMenu) userMenu.style.display = 'none';
}

// ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆã®å–å¾—
async function loadStats() {
    try {
        // ç®¡ç†ç”»é¢ã®çµ±è¨ˆAPIã‚’ä½¿ç”¨
        const response = await fetch('/api/admin/stats', { 
            credentials: 'include' 
        });
        
        if (response.ok) {
            const stats = await response.json();
            document.getElementById('file-count').textContent = stats.total_files || 0;
            document.getElementById('session-count').textContent = stats.total_sessions || 0;
            document.getElementById('embedding-count').textContent = stats.vectorized_files || 0;
        } else {
            // èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å€‹åˆ¥APIã‚’è©¦è¡Œ
            await loadStatsIndividually();
        }
        
    } catch (error) {
        console.error('çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        await loadStatsIndividually();
    }
}

// å€‹åˆ¥APIä½¿ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
async function loadStatsIndividually() {
    try {
        // ãƒ•ã‚¡ã‚¤ãƒ«æ•°
        const filesResponse = await fetch('/api/files', { credentials: 'include' });
        if (filesResponse.ok) {
            const filesData = await filesResponse.json();
            document.getElementById('file-count').textContent = filesData.files ? filesData.files.length : 0;
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°
        const sessionsResponse = await fetch('/api/chat/sessions', { credentials: 'include' });
        if (sessionsResponse.ok) {
            const sessionsData = await sessionsResponse.json();
            document.getElementById('session-count').textContent = sessionsData.sessions ? sessionsData.sessions.length : 0;
        }
        
        // åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«æ•°ï¼ˆä»®ï¼‰
        document.getElementById('embedding-count').textContent = '-';
        
    } catch (error) {
        console.error('å€‹åˆ¥çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('file-count').textContent = '-';
        document.getElementById('session-count').textContent = '-';
        document.getElementById('embedding-count').textContent = '-';
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«çµ±è¨ˆã‚’å–å¾—
document.addEventListener('DOMContentLoaded', loadStats);
</script>
{% endblock %} 