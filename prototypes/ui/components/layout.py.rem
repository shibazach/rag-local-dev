"""
å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ - new/ç³»templatesæº–æ‹ 
"""

from nicegui import ui
from typing import Optional, Dict, Any

# çµ¶å¯¾ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§SimpleAuthã‚’å‚ç…§ï¼ˆç›¸å¯¾ã‚¤ãƒ³ãƒãƒ¼ãƒˆå›é¿ï¼‰
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

class SimpleAuth:
    """ç°¡æ˜“èªè¨¼ã‚·ã‚¹ãƒ†ãƒ  - ä¸€æ™‚çš„ã«å†å®šç¾©ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆå•é¡Œå›é¿ï¼‰"""
    _current_user: Optional[Dict[str, Any]] = None
    
    @classmethod
    def get_current_user(cls) -> Optional[Dict[str, Any]]:
        return cls._current_user
    
    @classmethod
    def is_admin(cls) -> bool:
        user = cls.get_current_user()
        return user and user.get("role") == "admin"
    
    @classmethod
    def is_authenticated(cls) -> bool:
        return cls._current_user is not None
    
    @classmethod
    def logout(cls):
        cls._current_user = None

class RAGHeader:
    """new/æº–æ‹ ã®å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ98ç‚¹ä»•æ§˜ï¼‰"""
    
    def __init__(self, show_site_name: bool = True, current_page: str = ""):
        self.show_site_name = show_site_name
        self.current_page = current_page
        self.create_header()
    
    def create_header(self):
        """ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆï¼ˆå®Œå…¨ç”»é¢å¹…å¯¾å¿œãƒ»paddingå®Œå…¨ã‚¼ãƒ­ï¼‰"""
        with ui.element('div').style('position:fixed;top:0;left:0;right:0;width:100%;height:48px;background:#334155;z-index:1000;display:flex;align-items:center;padding:0;margin:0;overflow:hidden;'):
            
            # å·¦å´ï¼šã‚µã‚¤ãƒˆåï¼ˆå›ºå®šå¹…160pxï¼‰
            with ui.element('div').style('width:160px;display:flex;align-items:center;'):
                if self.show_site_name:
                    ui.label('ğŸ  R&D RAGã‚·ã‚¹ãƒ†ãƒ ').style('color:white;font-size:16px;font-weight:bold;margin-left:16px;')
            
            # ä¸­å¤®ï¼šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Œå…¨ä¸­å¤®é…ç½®ï¼‰
            with ui.element('div').style('flex:1;display:flex;align-items:center;justify-content:center;gap:20px;'):
                if self.current_page != "index":
                    self._nav_button('ğŸ ', 'ãƒ›ãƒ¼ãƒ ', '/')
                if self.current_page != "chat":
                    self._nav_button('ğŸ’¬', 'ãƒãƒ£ãƒƒãƒˆ', '/chat')
                if self.current_page != "files":
                    self._nav_button('ğŸ“', 'ãƒ•ã‚¡ã‚¤ãƒ«', '/files')
                if self.current_page != "upload":
                    self._nav_button('ğŸ“¤', 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', '/upload')
                if self.current_page != "ocr-adjustment":
                    self._nav_button('ğŸ”„', 'OCRèª¿æ•´', '/ocr-adjustment')
                if self.current_page != "data-registration":
                    self._nav_button('âš™ï¸', 'ãƒ‡ãƒ¼ã‚¿ç™»éŒ²', '/data-registration')
                if self.current_page != "admin":
                    self._nav_button('âš¡', 'ç®¡ç†', '/admin')
            
            # å³å´ï¼šèªè¨¼éƒ¨åˆ†ï¼ˆå›ºå®šå¹…160pxãƒ»å³å¯„ã›ï¼‰
            with ui.element('div').style('width:160px;display:flex;align-items:center;justify-content:flex-end;gap:8px;margin-right:16px;'):
                ui.label('â—').style('color:#10b981;font-size:12px;')
                ui.label('admin').style('color:white;font-size:14px;')
                ui.button('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', on_click=lambda: ui.navigate.to('/login')).style('background:#3b82f6;color:white;border:none;padding:4px 12px;border-radius:4px;font-size:12px;cursor:pointer;')
    
    def _nav_button(self, icon: str, label: str, path: str):
        """ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆå…±é€šã‚¹ã‚¿ã‚¤ãƒ«ï¼‰"""
        with ui.element('div').style('display:flex;align-items:center;gap:4px;cursor:pointer;padding:4px 8px;border-radius:4px;transition:background 0.2s;').on('click', lambda: ui.navigate.to(path)):
            ui.label(icon).style('color:white;font-size:16px;')
            ui.label(label).style('color:white;font-size:14px;')


class RAGFooter:
    """å…±é€šãƒ•ãƒƒã‚¿ãƒ¼ - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼å½¢å¼"""
    
    def __init__(self, show_status: bool = True):
        self.show_status = show_status
        if show_status:
            self.create_status_bar()
    
    def create_status_bar(self):
        """ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ä½œæˆï¼ˆå®Œå…¨ç”»é¢å¹…ãƒ»éš™é–“ã‚¼ãƒ­ï¼‰"""
        with ui.element('div').style('position:fixed;bottom:0;left:0;right:0;width:100%;height:24px;background:#374151;color:white;display:flex;align-items:center;justify-content:space-between;padding:0;margin:0;font-size:12px;z-index:999;'):
            ui.label('ã‚·ã‚¹ãƒ†ãƒ : æ­£å¸¸ç¨¼åƒä¸­').style('color:#10b981;margin-left:16px;')
            ui.label('æ¥ç¶š: OK').style('color:#3b82f6;margin-right:16px;')

class RAGLayout:
    """ãƒšãƒ¼ã‚¸å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ"""
    
    def __init__(self, page_title: str = "R&D RAGã‚·ã‚¹ãƒ†ãƒ ", show_header: bool = True, show_footer: bool = True):
        self.page_title = page_title
        self.show_header = show_header
        self.show_footer = show_footer
        
        # ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ - ä½™ç™½å®Œå…¨æœ€å°åŒ–
        ui.add_head_html('''
        <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .main-content {
            min-height: calc(100vh - 24px);
            padding: 0;
            margin: 0;
            padding-bottom: 24px;
        }
        .compact-layout {
            padding: 2px 4px;
            margin: 0;
        }
        .nicegui-row, .nicegui-column {
            gap: 2px !important;
        }
        .nicegui-card {
            margin: 1px !important;
            padding: 4px !important;
        }
        .nicegui-splitter {
            gap: 1px !important;
        }
        </style>
        ''')
        
        if self.show_header:
            RAGHeader(page_title)
    
    def __enter__(self):
        """ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼é–‹å§‹"""
        self.content_container = ui.column().classes('main-content w-full')
        return self.content_container.__enter__()
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        """ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼çµ‚äº†"""
        if self.show_footer:
            RAGFooter()
        return self.content_container.__exit__(exc_type, exc_val, exc_tb)

class MainContentArea:
    """ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ - å…¨ãƒšãƒ¼ã‚¸å…±é€šã®å®Œç’§ãªãƒ©ãƒƒãƒ‘ãƒ¼"""
    
    def __init__(self, footer_height: str = "24px"):
        """
        Args:
            footer_height: ãƒ•ãƒƒã‚¿ãƒ¼é«˜ã•ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ24pxï¼‰
        """
        self.footer_height = footer_height
        self.container = None
        
    def __enter__(self):
        """ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢é–‹å§‹ - å®Œç’§ãªä½™ç™½ã‚¼ãƒ­è¨­å®š"""
        self.container = ui.element('div').style(
            'margin-top:48px;'                    # ãƒ˜ãƒƒãƒ€ãƒ¼é«˜ã•åˆ†ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
            'margin-left:0;'                      # å·¦ä½™ç™½å®Œå…¨ã‚¼ãƒ­
            'margin-right:0;'                     # å³ä½™ç™½å®Œå…¨ã‚¼ãƒ­  
            f'margin-bottom:{self.footer_height};'  # ãƒ•ãƒƒã‚¿ãƒ¼é«˜ã•åˆ†ã®ä¸‹éƒ¨ä½™ç™½
            'padding:0;'                          # å†…éƒ¨ä½™ç™½å®Œå…¨ã‚¼ãƒ­
            'width:100%;'                         # å®Œå…¨å¹…ï¼ˆ100vwã§ã¯ãªã100%ï¼‰
            f'min-height:calc(100vh - 48px - {self.footer_height});'  # æœ€å°é«˜ã•è¨­å®š
            'overflow:hidden;'                    # ã¯ã¿å‡ºã—åˆ¶å¾¡
            'position:relative;'                  # å­è¦ç´ ã®åŸºæº–ä½ç½®
        )
        return self.container.__enter__()
        
    def __exit__(self, exc_type, exc_val, exc_tb):
        """ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢çµ‚äº†"""
        return self.container.__exit__(exc_type, exc_val, exc_tb)