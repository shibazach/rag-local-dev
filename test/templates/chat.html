<!-- test/templates/chat.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒãƒ£ãƒƒãƒˆæ¤œç´¢</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    #loading { display:none; color:#555; margin:8px 0; }
    .card { border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:4px; background:#fafafa; }
    .card h3 { margin:0 0 6px; font-size:1.1em; }
    .card pre { white-space:pre-wrap; background:#f5f5f5; padding:8px; border-radius:4px; overflow-x:auto; }
    .card button { margin-top:6px; padding:4px 8px; }
    .editor { margin-top:8px; }
    .editor textarea { width:100%; height:200px; }
    .editor button { margin-right:8px; }

    /* çµ±åˆå›ç­”ã‚¨ãƒªã‚¢ã®ä½™ç™½ã‚’èª¿æ•´ */
    #answer {
      display: none;       /* â† åˆæœŸã¯éš ã—ã¦ãŠã */
      margin: 12px 0;         /* ä¸Šä¸‹ 12px ã« */
      padding: 8px 12px;      /* å†…å´ã‚‚å°‘ã—ç‹­ã */
      border: 1px solid #888;
      border-radius: 4px;
      background: #eef;
    }
    #answer h2 {
      margin: 0 0 8px;        /* è¦‹å‡ºã—ã®ä¸Šãƒãƒ¼ã‚¸ãƒ³ã‚’ã‚¼ãƒ­ã« */
      font-size: 1.2em;
    }
    #answer pre {
      margin: 0;              /* ãƒ—ãƒ¬é ˜åŸŸã®ä½™è¨ˆãªä½™ç™½ã‚«ãƒƒãƒˆ */
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  {% extends "base.html" %}
  {% block content %}
  <h1>ğŸ”ãƒãƒ£ãƒƒãƒˆæ¤œç´¢</h1>

  <div>
    <textarea id="query" rows="4" cols="60" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"></textarea><br>

    <label>æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰:</label>
    <select id="mode">
      <option value="ãƒãƒ£ãƒ³ã‚¯çµ±åˆ">ãƒãƒ£ãƒ³ã‚¯çµ±åˆ</option>
      <option value="ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ï¼ˆè¦ç´„+ä¸€è‡´åº¦ï¼‰">ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ï¼ˆè¦ç´„+ä¸€è‡´åº¦ï¼‰</option>
    </select>

    <label>åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«:</label>
    <select id="model_key">
      {% for key, config in embedding_options.items() %}
        <option value="{{ key }}">{{ config["model_name"] }} ({{ config["embedder"] }})</option>
      {% endfor %}
    </select><br><br>

    <button id="search-btn">ğŸ” æ¤œç´¢å®Ÿè¡Œ</button>
    <button id="cancel-btn" disabled>âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <span id="loading">æ¤œç´¢ä¸­â€¦ãŠå¾…ã¡ãã ã•ã„</span>
  </div>

  <!-- çµ±åˆå›ç­”ã‚’å…¥ã‚Œã‚‹é ˜åŸŸ -->
  <div id="answer" style="border:1px solid #888;padding:12px;margin:12px 0;border-radius:4px;background:#eef;"></div>

  <!-- çµæœã‚«ãƒ¼ãƒ‰ -->
  <div id="results"></div>

  <script>
    const searchBtn = document.getElementById("search-btn");
    const cancelBtn = document.getElementById("cancel-btn");
    const loading = document.getElementById("loading");
    const resultsDiv = document.getElementById("results");
    let controller = null;

    searchBtn.addEventListener("click", async () => {
      // ãƒœã‚¿ãƒ³ã¨ã‚¹ãƒ”ãƒŠãƒ¼ã®åˆ‡æ›¿
      searchBtn.disabled = true;
      cancelBtn.disabled = false;
      loading.style.display = "inline";
      resultsDiv.innerHTML = "";
      document.getElementById("answer").innerHTML = "";

      controller = new AbortController();
      const signal = controller.signal;

      const query = document.getElementById("query").value;
      const mode = document.getElementById("mode").value;
      const model_key = document.getElementById("model_key").value;

      try {
        const form = new FormData();
        form.append("query", query);
        form.append("mode", mode);
        form.append("model_key", model_key);

        const res = await fetch("/query", { method: "POST", body: form, signal });
        const json = await res.json();

        if (json.error) {
          resultsDiv.innerHTML = `<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ${json.error}</p>`;
        } else {
          // ãƒãƒ£ãƒ³ã‚¯çµ±åˆãƒ¢ãƒ¼ãƒ‰ï¼šçµ±åˆå›ç­”ã¨ã‚½ãƒ¼ã‚¹ä¸€è¦§ã‚’å…ˆã«æç”»
          if (json.mode === "ãƒãƒ£ãƒ³ã‚¯çµ±åˆ") {
            const answerDiv = document.getElementById("answer");
            // 1) ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æŒ¿å…¥
            answerDiv.innerHTML = `<h2>çµ±åˆå›ç­”</h2><pre>${json.answer}</pre>`;
            // 2) è¡¨ç¤º
            answerDiv.style.display = "block";

            // ã‚½ãƒ¼ã‚¹ä¸€è¦§æç”»
            resultsDiv.innerHTML = `<h3>ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«</h3>`;
            json.sources.forEach((src, i) => {
              const num = i + 1;
              resultsDiv.innerHTML +=
                `<p>${num}. <a href="/viewer/${src.file_id}?num=${num}" target="_blank">${src.filename}</a></p>`;
            });
          } else {
            // ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ answer ã‚’éš ã™
            const answerDiv = document.getElementById("answer");
            answerDiv.style.display = "none";
            // æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã‚«ãƒ¼ãƒ‰æç”»ã¸
          }

          // çµæœã‚«ãƒ¼ãƒ‰ï¼ˆé€šã—ç•ªå·ä»˜ãï¼‰
          json.results.forEach((item, idx) => {
            const num = idx + 1;
            const card = document.createElement("div");
            card.className = "card";

            // ã‚¿ã‚¤ãƒˆãƒ«è¡Œï¼ˆPDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯ä»˜ãï¼‰
            const h3 = document.createElement("h3");
            if (item.file_id) {
              h3.innerHTML = `${num}. <a href="/viewer/${item.file_id}?num=${num}" target="_blank">${item.filename}</a>`;
            } else {
              h3.textContent = `${num}. ${item.filename}`;
            }
            card.appendChild(h3);

            // ã‚¹ãƒ‹ãƒšãƒƒãƒˆ or è¦ç´„
            const pre = document.createElement("pre");
            pre.textContent = item.snippet || item.summary || "";
            card.appendChild(pre);

            // ä¸€è‡´åº¦è¡¨ç¤ºï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
            if (item.score !== undefined) {
              const p = document.createElement("p");
              p.textContent = `ä¸€è‡´åº¦: ${item.score.toFixed(2)}`;
              card.appendChild(p);
            }

            // ç·¨é›†ãƒˆã‚°ãƒ«
            if (item.file_id) {
              const toggleBtn = document.createElement("button");
              toggleBtn.textContent = "âœï¸ ç·¨é›†";
              card.appendChild(toggleBtn);

              const editorDiv = document.createElement("div");
              editorDiv.className = "editor";
              editorDiv.style.display = "none";
              card.appendChild(editorDiv);

              toggleBtn.addEventListener("click", async () => {
                if (editorDiv.style.display === "none") {
                  toggleBtn.textContent = "âœ–ï¸ é–‰ã˜ã‚‹";
                  if (!editorDiv.innerHTML) {
                    const resp = await fetch(`/api/content/${item.file_id}`);
                    const data = await resp.json();
                    editorDiv.innerHTML = `
                      <textarea>${data.content}</textarea><br>
                      <button class="save-btn">ä¿å­˜ï¼ˆå†ãƒ™ã‚¯ãƒˆãƒ«åŒ–ï¼‰</button>
                    `;
                    editorDiv.querySelector(".save-btn").addEventListener("click", async () => {
                      const newContent = editorDiv.querySelector("textarea").value;
                      const resSave = await fetch(`/api/save/${item.file_id}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ content: newContent })
                      });
                      if (resSave.ok) {
                        alert("âœ… å†ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
                      } else {
                        alert("âŒ ã‚¨ãƒ©ãƒ¼: " + (await resSave.text()));
                      }
                    });
                  }
                  editorDiv.style.display = "block";
                } else {
                  toggleBtn.textContent = "âœï¸ ç·¨é›†";
                  editorDiv.style.display = "none";
                }
              });
            }

            resultsDiv.appendChild(card);
          });  // forEach
        }
      } catch (err) {
        if (err.name === "AbortError") {
          resultsDiv.innerHTML = `<p style="color:#888;">æ¤œç´¢ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚</p>`;
        } else {
          resultsDiv.innerHTML = `<p style="color:red;">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
        }
      } finally {
        searchBtn.disabled = false;
        cancelBtn.disabled = true;
        loading.style.display = "none";
        controller = null;
      }
    });

    cancelBtn.addEventListener("click", () => {
      if (controller) controller.abort();
    });
  </script>
  {% endblock %}
</body>
</html>
