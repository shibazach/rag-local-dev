<!-- test/templates/chat.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç ”ç©¶éƒ¨ãƒ­ãƒ¼ã‚«ãƒ«RAG</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    #loading { display: none; margin: 8px 0; color: #555; }
    #results .card { border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:4px; background:#fafafa; }
    #results h3 { margin:0 0 6px; font-size:1.1em; }
    #results pre { white-space:pre-wrap; background:#f5f5f5; padding:8px; border-radius:4px; overflow-x:auto; }
    #results button { margin-top:6px; padding:4px 8px; }
  </style>
</head>
<body>
  <h1>ğŸ” ç ”ç©¶éƒ¨ãƒ­ãƒ¼ã‚«ãƒ«RAG</h1>

  <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div>
    <textarea id="query" rows="4" cols="60" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"></textarea><br>

    <label>æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰:</label>
    <select id="mode">
      <option value="ãƒãƒ£ãƒ³ã‚¯çµ±åˆ">ãƒãƒ£ãƒ³ã‚¯çµ±åˆ</option>
      <option value="ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ï¼ˆè¦ç´„+ä¸€è‡´åº¦ï¼‰">ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ï¼ˆè¦ç´„+ä¸€è‡´åº¦ï¼‰</option>
    </select>

    <label>åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«:</label>
    <select id="model_key">
      {% for key, config in embedding_options.items() %}
        <option value="{{ key }}">{{ config["model_name"] }} ({{ config["embedder"] }})</option>
      {% endfor %}
    </select><br><br>

    <button id="search-btn">ğŸ” æ¤œç´¢å®Ÿè¡Œ</button>
    <button id="cancel-btn" disabled>âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <span id="loading">æ¤œç´¢ä¸­â€¦ãŠå¾…ã¡ãã ã•ã„</span>
  </div>

  <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="results"></div>

  <script>
    const searchBtn = document.getElementById("search-btn");
    const cancelBtn = document.getElementById("cancel-btn");
    const loading = document.getElementById("loading");
    const resultsDiv = document.getElementById("results");
    let controller = null;

    searchBtn.addEventListener("click", async () => {
      // UIåˆ‡ã‚Šæ›¿ãˆ
      searchBtn.disabled = true;
      cancelBtn.disabled = false;
      loading.style.display = "inline";

      // AbortControllerç”Ÿæˆ
      controller = new AbortController();
      const signal = controller.signal;

      // ãƒ•ã‚©ãƒ¼ãƒ å€¤å–å¾—
      const query = document.getElementById("query").value;
      const mode = document.getElementById("mode").value;
      const model_key = document.getElementById("model_key").value;

      // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      try {
        const form = new FormData();
        form.append("query", query);
        form.append("mode", mode);
        form.append("model_key", model_key);

        const res = await fetch("/query", {
          method: "POST",
          body: form,
          signal
        });
        const json = await res.json();

        // çµæœè¡¨ç¤º
        resultsDiv.innerHTML = "";
        if (json.error) {
          resultsDiv.innerHTML = `<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ${json.error}</p>`;
        } else {
          json.results.forEach(item => {
            const card = document.createElement("div");
            card.className = "card";

            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚¯ãƒªãƒƒã‚¯ã§PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            if (item.file_id) {
              const h3 = document.createElement("h3");
              h3.innerHTML = `<a href="/api/pdf/${item.file_id}" target="_blank">${item.filename}</a>`;
              card.appendChild(h3);
            } else {
              const h3 = document.createElement("h3");
              h3.textContent = item.filename;
              card.appendChild(h3);
            }

            // snippet or summary
            const pre = document.createElement("pre");
            pre.textContent = item.snippet || item.summary || "";
            card.appendChild(pre);

            // score
            if (item.score !== undefined) {
              const p = document.createElement("p");
              p.textContent = `ä¸€è‡´åº¦: ${item.score.toFixed(2)}`;
              card.appendChild(p);
            }

            // ç·¨é›†ãƒœã‚¿ãƒ³
            if (item.file_id) {
              const btn = document.createElement("button");
              btn.textContent = "âœï¸ ç·¨é›†";
              btn.onclick = () => window.location.href = `/edit/${item.file_id}`;
              card.appendChild(btn);
            }

            resultsDiv.appendChild(card);
          });
        }
      } catch (err) {
        if (err.name === "AbortError") {
          resultsDiv.innerHTML = `<p style="color:#888;">æ¤œç´¢ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚</p>`;
        } else {
          resultsDiv.innerHTML = `<p style="color:red;">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
        }
      } finally {
        // UIãƒªã‚»ãƒƒãƒˆ
        searchBtn.disabled = false;
        cancelBtn.disabled = true;
        loading.style.display = "none";
        controller = null;
      }
    });

    cancelBtn.addEventListener("click", () => {
      if (controller) controller.abort();
    });
  </script>
</body>
</html>
