<!-- test/templates/chat.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>RAGãƒãƒ£ãƒƒãƒˆ</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <h1>ğŸ” ãƒ­ãƒ¼ã‚«ãƒ«RAGãƒãƒ£ãƒƒãƒˆ</h1>
  <form id="query-form">
    <label>è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:</label><br>
    <textarea name="query" rows="4" cols="60" required></textarea><br>

    <label>æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰:</label>
    <select name="mode">
      <option value="ãƒãƒ£ãƒ³ã‚¯çµ±åˆ">ãƒãƒ£ãƒ³ã‚¯çµ±åˆ</option>
      <option value="ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ï¼ˆè¦ç´„+ä¸€è‡´åº¦ï¼‰">ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ï¼ˆè¦ç´„+ä¸€è‡´åº¦ï¼‰</option>
    </select><br>

    <label>åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«:</label>
    <select name="model_key">
      {% for key, config in embedding_options.items() %}
        <option value="{{ key }}">{{ config["model_name"] }} ({{ config["embedder"] }})</option>
      {% endfor %}
    </select><br><br>

    <button type="submit">æ¤œç´¢å®Ÿè¡Œ</button>
  </form>

  <div id="results"></div>

  <script>
  document.getElementById("query-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const res = await fetch("/query", { method: "POST", body: formData });
    const resultDiv = document.getElementById("results");
    resultDiv.innerHTML = "";

    let json;
    try {
      json = await res.json();
    } catch {
      return resultDiv.innerHTML = "<p style='color:red'>âš ï¸ çµæœè§£æã«å¤±æ•—ã—ã¾ã—ãŸ</p>";
    }
    if (json.error) return resultDiv.innerHTML = `<p style='color:red'>ã‚¨ãƒ©ãƒ¼: ${json.error}</p>`;

    // UIæ•´å½¢è¡¨ç¤º
    json.results.forEach(item => {
      const card = document.createElement("div");
      card.classList.add("card");

      const title = document.createElement("h3");
      if (item.file_id) {
        title.innerHTML = `<a href="/api/pdf/${item.file_id}" target="_blank">${item.filename}</a>`;
      } else {
        title.textContent = item.filename;
      }
      card.appendChild(title);

      const snippet = document.createElement("pre");
      snippet.textContent = item.snippet || item.summary || "";
      card.appendChild(snippet);

      if (item.score !== undefined) {
        const score = document.createElement("p");
        score.textContent = `ä¸€è‡´åº¦: ${item.score.toFixed(2)}`;
        card.appendChild(score);
      }

      if (item.file_id) {
        const btn = document.createElement("button");
        btn.textContent = "âœï¸ ç·¨é›†";
        btn.onclick = () => location.href = `/edit/${item.file_id}`;
        card.appendChild(btn);
      }
      resultDiv.appendChild(card);
    });
  });
  </script>

</body>
</html>
